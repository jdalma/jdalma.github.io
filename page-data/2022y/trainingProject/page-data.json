{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022y/trainingProject/","result":{"data":{"site":{"siteMetadata":{"title":"코딩 주머니"}},"markdownRemark":{"id":"e289b6e1-1c61-5810-b7d7-f485a6333ffc","excerpt":"기존에 존재하던 REST API를 그대로 유지하면서 gRPC 통신을 같이 사용할 수 있을지 확인하고, Stream 통신을 테스트해보는 것이다. REST API와 RPC 통신을 한 포트로 처리할 수 있는 Armeria를 사용한다. protocol buffer를 통해 기존 JSON…","html":"<p>기존에 존재하던 REST API를 그대로 유지하면서 gRPC 통신을 같이 사용할 수 있을지 확인하고, Stream 통신을 테스트해보는 것이다.</p>\n<ul>\n<li>REST API와 RPC 통신을 한 포트로 처리할 수 있는 Armeria를 사용한다.</li>\n<li>protocol buffer를 통해 기존 JSON보다 데이터 사이즈를 줄일 수 있을 것이다.</li>\n</ul>\n<h1 id=\"armeria와-tomcat을-한-개의-포트로\" style=\"position:relative;\">Armeria와 Tomcat을 한 개의 포트로?<a href=\"#armeria%EC%99%80-tomcat%EC%9D%84-%ED%95%9C-%EA%B0%9C%EC%9D%98-%ED%8F%AC%ED%8A%B8%EB%A1%9C\" aria-label=\"armeria와 tomcat을 한 개의 포트로 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Armeria에서는 <a href=\"https://javadoc.io/doc/com.linecorp.armeria/armeria-javadoc/latest/com/linecorp/armeria/server/HttpService.html\"><code class=\"language-text\">javadoc</code> HttpService</a>로 Tomcat, gRPC 들을 추상화 해놓았다.<br>\nArmeria 서버가 실행될 때 원하는 Service들을 ServerBuilder에 추가시키기만 하면 된다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@Configuration\nclass ArmeriaConfig{\n\n    @Bean\n    fun armeriaServerConfigurator(\n      context: ServletWebServerApplicationContext, \n      services: List&lt;BindableService&gt;\n    ): ArmeriaServerConfigurator {\n        val grpcService: GrpcService =\n            GrpcService.builder().apply {\n                this.addServices(services)\n            }.build()\n\n        val container = context.webServer as TomcatWebServer\n        container.start()\n\n        return ArmeriaServerConfigurator { builder -&gt;\n\n            // tomcatService 바인딩\n            builder.serviceUnder(&quot;/&quot;,  TomcatService.of(container.tomcat))\n\n            // stub 구현체 등록\n            builder.service(grpcService)\n\n            // Armeria Service 문서 활성화\n            builder.serviceUnder(&quot;/docs&quot;, DocService())\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<blockquote>\n<p>✋<br>\nTomcat 포트를 직접 지정해주고 해당 포트로 REST 요청을 보내게되면 Armeria를 거치지 않고 바로 TomcatWebServer가 처리한다.<br>\nTomcat 포트를 <code class=\"language-text\">-1</code>로 지정하고 Armeria 포트만 지정해주면 Armeria가 REST 요청과 gRPC 요청 둘 다 처리하게 된다.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ebff249f14a266fa7fbdc0f601d37a08/90eea/flow.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAABYlAAAWJQFJUiTwAAABZ0lEQVR42j1Si27CMBDr//8ZQ0yIISGKBm2hlL6Avt/17ACrdMql8fnsSyzwm+dZC+q6hm3b2O/38H0fXddhGAbM02TOZ+7npsHctuAhRuL7okDHGKsKzfMJy3VdPB4PTCwax/E/RNay8Gu5hHc+vwhZiDd5S+KGhCMbDsT2fY/sfodVEHRnouKKXaIoQpIkBvgMQ9jbLRKq7bMMExuHtxtK4oSRm4B7CVLExFtSttlsjMUgCHA8HvHLiLj/Wa8RcGUn5HlurLqOY5oK7zAXseqMEIal+TlvUBzHONOewOH1CvdwMCpn2inK0hA6bCaVPs+l8MbcOZ1w5T5lvaV5aGYNZ6JPitXE/OOMoJz2RWgugnnP+AhIqfB7tcJut3tZVnHG+Sg0B8/zcLlcjMU0Tc1sRW4IqfRz4yPXhmeKio1rCipZY2a4WCwMiTqK8EQLytecoezry3XDekJ6OiTGJ/jPrHoZRYE/1OVhZDum0IYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"flow\"\n        title=\"\"\n        src=\"/static/ebff249f14a266fa7fbdc0f601d37a08/1cfc2/flow.png\"\n        srcset=\"/static/ebff249f14a266fa7fbdc0f601d37a08/3684f/flow.png 225w,\n/static/ebff249f14a266fa7fbdc0f601d37a08/fc2a6/flow.png 450w,\n/static/ebff249f14a266fa7fbdc0f601d37a08/1cfc2/flow.png 900w,\n/static/ebff249f14a266fa7fbdc0f601d37a08/21482/flow.png 1350w,\n/static/ebff249f14a266fa7fbdc0f601d37a08/d61c2/flow.png 1800w,\n/static/ebff249f14a266fa7fbdc0f601d37a08/90eea/flow.png 2254w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Netty의 <code class=\"language-text\">EventLoop</code>가 client로부터 오는 모든 요청을 다 받는다.</p>\n<ol>\n<li><strong>gRPC는 NonBlocking으로 처리</strong></li>\n<li><strong>REST는 Tomcat이 Blocking으로 처리</strong>\n<ul>\n<li>서블릿 스레드는 Armeria의 <code class=\"language-text\">BlockingTaskExecutor</code>이다</li>\n<li><code class=\"language-text\">EventLoop</code>가 해당 request를 처리하라는 작업을 <code class=\"language-text\">BlockingTaskExecutor</code>에게 위임</li>\n<li><code class=\"language-text\">BlockingTaskExecutor</code>에서 어댑터를 이용해 서블릿 컨테이너를 호출</li>\n</ul>\n</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 448px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8943dd5097e3110b3ec831856ba0d15c/33b38/blockNonBlockThread.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABG0lEQVR42j1R7XKCMBDkcTq2ts70d6sYQgKB8C0iglp9/1fY3p2lPzK3bG43O0uQag2blbBpju+dQmwdTJJBmxRKW5oO+8ggzQrh+SidIFQGRdUiL2rR8v7reoPAGQvna7nY7TUSVxBukPmKsJfJgrLuCNfwZSs7sc1QNb3sLgHeN58Ihq7HMN1wnn9IdMDxdCF8x+l8xTBehO+HCfP1QdwN0+VO/ExmR8IPjNPzvutHChQjSGMjCTlJqGJ5nZPw5GQurxDFiUxOzJXwd1F1xJWULkd7GIRbvX0gsFEkHSYux9d2L4KlEz6Mt2EkkzsNlZZOfdkQ5wXXbS+GL6s1G2qYtJDXF0PGSy+Mn8m9iNjgadj+JeQuD/8/5RcCG+GpqeQkfQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"blockNonBlockThread\"\n        title=\"\"\n        src=\"/static/8943dd5097e3110b3ec831856ba0d15c/33b38/blockNonBlockThread.png\"\n        srcset=\"/static/8943dd5097e3110b3ec831856ba0d15c/3684f/blockNonBlockThread.png 225w,\n/static/8943dd5097e3110b3ec831856ba0d15c/33b38/blockNonBlockThread.png 448w\"\n        sizes=\"(max-width: 448px) 100vw, 448px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>EventLoop는 변경되지 않는 하나의 Thread로 움직이며,<br>\n작업 (Runnable 또는 Callable)을 EventLoop 구현으로 직접 제출해 즉시 또는 예약 실행할 수 있다.<br>\n구성과 사용 가능한 코어에 따라서는 리소스 활용을 최적화하기 위해 여러 EventLoop가 생성되고,<br>\n여러 Channel에 서비스를 제공하기 위해 단일 EventLoop가 할당되는 경우도 있다.</p>\n<ul>\n<li><strong>네티인액션</strong></li>\n</ul>\n</blockquote>\n<h1 id=\"grpc-통신-종류\" style=\"position:relative;\">gRPC 통신 종류<a href=\"#grpc-%ED%86%B5%EC%8B%A0-%EC%A2%85%EB%A5%98\" aria-label=\"grpc 통신 종류 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><a href=\"https://github.com/jdalma/armeria-grpc-kotlin/blob/master/src/test/java/com/example/armeriaserver/grpc/SampleServiceTest.java#L58\">테스트 코드</a>에서 확인할 수 있다.<br>\n또는 <a href=\"https://grpc.io/docs/languages/java/basics/\">공식 문서 Basics Tutorial</a>에서도 확인 가능하다.</p>\n<p>protocol buffer는 이진 부호화 라이브러리이며 부호화할 데이터를 위한 스키마를 <code class=\"language-text\">proto</code>언어를 통해 아래와 같이 메세지를 정의하고 protocol buffer compiler를 통해 원하는 언어로 <a href=\"https://protobuf.dev/programming-guides/proto3/#generated\">generate</a> 할 수 있다.<br>\n생성된 코드를 호출해 부호화하고 복호화할 수 있다.</p>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">syntax = &quot;proto3&quot;;\n\npackage grpc.hello;\n\noption java_multiple_files = true;\noption java_package = &quot;stub.hello&quot;;\n\nmessage HelloRequest {\n  string message = 1;\n}\n\nmessage HelloResponse {\n  string message = 1;\n}\n\nservice HelloService {\n  rpc SimpleRPC (HelloRequest) returns (HelloResponse) {}\n  rpc ClientSideStreaming (stream HelloRequest) returns (HelloResponse) {}\n  rpc ServerSideStreaming (HelloRequest) returns (stream HelloResponse) {}\n  rpc BidirectionalStreaming (stream HelloRequest) returns (stream HelloResponse) {}\n}</code>\n        </deckgo-highlight-code>\n<p><code class=\"language-text\">HelloService</code>의 내용과 같이 이 메시지를 통하여 어떤 통신을 사용할 것인지 정의할 수 있다.<br>\n각 통신 방법마다 지원하는 요청-응답 방식이 다르다.</p>\n<blockquote>\n<p>Async는 비동기-논블로킹 통신, Future는 동기-논블로킹 통신</p>\n</blockquote>\n<ul>\n<li>\n<p><strong>Simple</strong> : 단일 요청, 단일 응답</p>\n<ul>\n<li>Future Stub</li>\n<li>Blocking Stub</li>\n<li>기본(Async) Stub</li>\n</ul>\n</li>\n<li>\n<p><strong>ServerSideStreaming</strong> : 서버 → 클라이언트 스트림 통신</p>\n<ul>\n<li><code class=\"language-text\">not support</code> Future Stub</li>\n<li>Blocking Stub</li>\n<li>기본(Async) Stub</li>\n</ul>\n</li>\n<li>\n<p><strong>ClientSideStreaming</strong> : 클라이언트 → 서버 스트림 통신</p>\n<ul>\n<li><code class=\"language-text\">not support</code> Future Stub</li>\n<li><code class=\"language-text\">not support</code> Blocking Stub</li>\n<li>기본(Async) Stub</li>\n</ul>\n</li>\n<li>\n<p><strong>BidirectionalStreaming</strong> : 양방향 스트림 통신</p>\n<ul>\n<li><code class=\"language-text\">not support</code> Future Stub</li>\n<li><code class=\"language-text\">not support</code> Blocking Stub</li>\n<li>기본(Async) Stub</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"armeria의-server-thread는-어떻게-처리될까\" style=\"position:relative;\">Armeria의 Server Thread는 어떻게 처리될까?<a href=\"#armeria%EC%9D%98-server-thread%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%B2%98%EB%A6%AC%EB%90%A0%EA%B9%8C\" aria-label=\"armeria의 server thread는 어떻게 처리될까 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/03f8e242df029769652d8a7aa43df5f7/705cc/expect.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABlUlEQVR42mVSWXbjMAzzfRpb1Oo1XpOmTe5/HhSkJ7O8+cCzRNEgSKLqhw5OGngvhCOa/yCMv+HDv2f/9xtRNY4X8SQVBuU3SWByCCRjMc3x3qNuaite143lO3F8O9+VQ8+VssacEGJg4AL3C03zcX4Jrb5s24l1wf3xwOP5wrytmNcV63FDaYsVr7zUiClCW9+3Bet6JWbcbjuOY8O+L4ZxGk11jIKcA7q+Q0qeELRdS0HaXY1KSJhyZLCg7ws6fjcSf34euN8P+z6fX/h+vfiWkVNAKQmpZHbwQVUXBAp6z/8kZIJW0cqlREPij/M8kfCGZZnw+P6yAuPYYRh7U6wKMzGo+uj/KCxU1bb5TCCptqWY5wHX62DKZ85OVWhOaU8BMTobwzCOPJNQjPBi7Wob52YFA+e5LFcj0Ng09diO3QjexXQJduZ76Vv7z1puXE0/BXhuWYPvoWsBPeuw1Q4S1AW1bdzs471ZyKltRMw6zrYctUW1TSLxOQcdg8JMLWrswCLFfKoIgUuxu7d7jJFOyUb+A0WpQjpfCD9CAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"expect\"\n        title=\"\"\n        src=\"/static/03f8e242df029769652d8a7aa43df5f7/1cfc2/expect.png\"\n        srcset=\"/static/03f8e242df029769652d8a7aa43df5f7/3684f/expect.png 225w,\n/static/03f8e242df029769652d8a7aa43df5f7/fc2a6/expect.png 450w,\n/static/03f8e242df029769652d8a7aa43df5f7/1cfc2/expect.png 900w,\n/static/03f8e242df029769652d8a7aa43df5f7/705cc/expect.png 1071w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1a839906e933a6d47cb6711d8d54e93c/77672/real.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABbElEQVR42nVSW3KDMAzkQAVLfoAxr5BASyYfbe9/GFWSA6Wd9mPH2rG8WskqUopkoDqA+BcMGVMq0BoC5pVwyT9zPgtJAkQCQL60mvBbsDJGcwyAxmXFxQ0oL/m9cGsd3wEVImAdkq9rrQRQHm4AXg4eU0uX242GaaRpnun+eNCyrjSMmU/zhc2IoLooKTSBxiHRPHPC1NM4dkcs6LqWQu3JO6AQLMU2Mncae2+pjo12o4LiomUHXRcVIvb6eqNtW+l+f1N8fL7TdbmqgKDtEr/LbwUueJ11sc9JKuzJNVcW0ZQadSdOl3Wh7b5pLPfSetN4jeVMffp2KIj8294jOW5JzoHbb9uGek4ULnN2wakbyW+4o/MHyox/CKa+e84DdSaWk89OL/PEY4lacG9ZcnZE4VmQdwwM+RC4YnZ4hnyY808B79Wp/CY6dougXE50XnUKXRXeP+Cd+n8P897lXcwGkGNEm+9Ains9vwBJh0JZg038fgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"real\"\n        title=\"\"\n        src=\"/static/1a839906e933a6d47cb6711d8d54e93c/1cfc2/real.png\"\n        srcset=\"/static/1a839906e933a6d47cb6711d8d54e93c/3684f/real.png 225w,\n/static/1a839906e933a6d47cb6711d8d54e93c/fc2a6/real.png 450w,\n/static/1a839906e933a6d47cb6711d8d54e93c/1cfc2/real.png 900w,\n/static/1a839906e933a6d47cb6711d8d54e93c/77672/real.png 1060w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>클라이언트의 메인 스레드에서 다른 서비스로 요청해도 모든 요청을 처리하는 스레드는 서버 스레드 한 개이다\n<ul>\n<li>Sample, Hello 서로 다른 서비스로 요청을 보내도 요청을 처리하는 스레드는 한 개이다</li>\n</ul>\n</li>\n<li>위와 같은 테스트를 두 개의 클라이언트에서 각각 한 번씩 보내도 똑같은 결과다\n<ul>\n<li><strong>결국 서버에서 받는 모든 요청들은 각 클라이언트의 소켓에 맞는 서버의 스레드들이 처리한다</strong></li>\n</ul>\n</li>\n<li>한 개의 클라이언트의 메인 스레드에서 자식 스레드 여러 개를 서버에 요청 전송하여도 한 개의 서버 스레드가 처리한다.</li>\n</ol>\n<blockquote>\n<p>위와 같은 결과가 나오는 이유를 이해하려면 이벤트 루프, 멀티플렉싱에 대한 이해가 필요하다.<br>\n<a href=\"https://github.com/jdalma/footprints/blob/main/%EC%A0%95%EB%A6%AC/%EB%A9%80%ED%8B%B0%ED%94%8C%EB%A0%89%EC%8B%B1.md\">EventLoop와 멀티플렉싱에 대해 정리한 글</a>을 참고하자</p>\n</blockquote>\n<p>EventLoop는 단일 스레드로 요청과 응답을 처리하므로 해당 스레드를 블록하면 EventLoop 자체를 블록하는 것과 같다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/084f82f52f6b152b7a175bdb3bc733ab/561da/blockingTaskExecutor.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 34.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA7UlEQVR42pWRSW7DMAxFdY7WQ2IN1izbQpw6qwK9/5l+KSnu2l08EBxA8pNsWTO+jx98pQNcOwhlIeaCq0xSQ3CBWTZk4Z1TJoCrViu1xzgpsJQyXvuBHBKUDdAu/THbWK1xFLe+YlyE8S1XbGOpvjIebDYOz8cLwUT0k8RwFxjvsjIQ3cjxWRgmfAy8+t04Vf+ke+cLzNEG2/ZEDBmSJsjZt2k6kIxAxQL97Tqsv0mkTA23HUtpvO6Iy6NaHzPJWUlKpFvaS7Ce1jVugQ0bXNxqg4KmmKBtuSqPuQ4rdzqPWh5QGrQ78X9JPSX/AkqfyygqbdphAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"blockingTaskExecutor\"\n        title=\"\"\n        src=\"/static/084f82f52f6b152b7a175bdb3bc733ab/1cfc2/blockingTaskExecutor.png\"\n        srcset=\"/static/084f82f52f6b152b7a175bdb3bc733ab/3684f/blockingTaskExecutor.png 225w,\n/static/084f82f52f6b152b7a175bdb3bc733ab/fc2a6/blockingTaskExecutor.png 450w,\n/static/084f82f52f6b152b7a175bdb3bc733ab/1cfc2/blockingTaskExecutor.png 900w,\n/static/084f82f52f6b152b7a175bdb3bc733ab/561da/blockingTaskExecutor.png 969w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ee84d55503ee3e11c8d3623ef8b53226/129e9/armeriaThread.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACeElEQVR42nVSy2oUQRTtj3MnSkSJuHAn+AE+l4ILMREj6MalEgyCEOLCBwTduBAEH5CoSZxEyTg909PPqn7Uo7uPp2okKsSGy7l1u+rUOfdW8OnLFna297D9dQ97YYjz0X3Mh0s4O72HU9ktzJWLOCGJYgFzkrlYJC7gpLiN0+kS5rMlnMnu4Fh6E0/Ktwjer67h89pzfHn6AtvPXmJ94zVWd95hef0Vrn14jAubD3FlcxmXth7h8scHuEi8urGCc4O7OFrcwPGEF2WLOJJcx4p8g6CuahhGb1q0WYao2EdkY4RVxMgwFSkmjMjleUzMEYkMo3KCQRtioEPsmhDfzAhZKxFAKcBawBhiCwgBE6YoEw0jFIqpu9CgiCoo6dYl6kKhThlx48/o3KCZ1IA2CKJhjjxTsLrDOKxQ5xW6pkGtLGTVoKw0qkb7ddsBynTQtvOo6Mp91tWVoUsS6togSWkjmkJQQVdTMQn7vvebteZldNBSSdu26BhFkWM0GqEspa/5/1TnXAbJVCIcsz9xhvFEQgtKV47Q83GPmRErKq1ot24gpcR4PGZes07rFGB/ty4oSailpk2DMm1gMvkPodbaq1DKofVqXJRlhSROPPmBQkuF/mTXo+/YCLjcNUQfWHYKXe6i4z9L664mhMRwOERDlS2ba3nGK8Rh31+EM4Ude8gh0JahEkfsaoIvIo5j9lSgO1B4KKH6o1DPyHu6QD9z0rpnxqUk4e7uAGmawrKPfiiH8fVUqDT71CgflmQNn4jDms9DcjDKvT+q7niJq7uh/ZewmRbIfiSoJjkSoooLj3XE+n7KeoHiZ8ZIAU6+igTy7zH6usEviGfRJsFy3hEAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"armeriaThread\"\n        title=\"\"\n        src=\"/static/ee84d55503ee3e11c8d3623ef8b53226/1cfc2/armeriaThread.png\"\n        srcset=\"/static/ee84d55503ee3e11c8d3623ef8b53226/3684f/armeriaThread.png 225w,\n/static/ee84d55503ee3e11c8d3623ef8b53226/fc2a6/armeriaThread.png 450w,\n/static/ee84d55503ee3e11c8d3623ef8b53226/1cfc2/armeriaThread.png 900w,\n/static/ee84d55503ee3e11c8d3623ef8b53226/129e9/armeriaThread.png 1161w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>Event Loop가 처리하는 기준</strong></p>\n<ul>\n<li>한 호스트의 동일한 Port에서 10초 간격으로 요청을 보내면 한 개의 Armeria Server Thread로 처리하지만</li>\n<li>11초 간격으로 보내면 클라이언트의 Port가 바뀌면서 각기 다른 Armeria Server Thread가 처리한다</li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc7540#section-6.8\"><code class=\"language-text\">GOAWAY</code> 프레임</a>을 통해 서로 데이터를 다 보냈다는 확인을 한다.</li>\n<li>마지막 <strong>RST flag</strong>를 보내면서 서버에서 Socket이 닫히고 TCP 커넥션을 끊는다.</li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0000c7780b5d9a5ecc10f5a4a85f67c7/4ef3c/packet.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACKElEQVR42jWRW1PaUBSF8/+nfXDaUVvbh9qXUsRaL0BIuCQQEohAguGWcBNUKNQBLzii1a8Hpj0z66x19sxas/c+kpXNY6R1lLjCwf4hJ0fRNaLHMY4PT4SOcfSPD34cEY8mSCtp9JSGkclRzBcYd9r0/Rbz+RzJq59Rb9bQTYOfsghRZBQthaolkdPKWseSCRIZVbBMOqdh2hZ2+RT3zKEmvFeBT6VQYH5zg2TpHlbWQz4xCH2LEw7J7EdSRCJJwmGVyF6SkKjtCb3i48Oc6NIkKdtkU47w1rmoNenWPRaLBVLw+5729YKCPyRqOSilGik3IOn66PUOxe6QvN+n0Blg+D2qF1Nak9s1gukdvvDfzuYsRdiflxekwX3AxUOHUr9ItBgXIRlUR0VvZMg2M1jtHGagi2BDBGp44wqjxy7DRVsg4Oqxx3QyoNVoMpvNkC7FNRKzO+0OqVKJ3JmH7lbRHRelaKNVXFGrYoqRzJpHSSy/N5nQGY/oTsYEgu9v5jwtH1kul0j9S5/zK5+yZ5PJJ8WvJbGKGpYrOippOA2bcr3AqWeusdLdYZP2oE5n0BDc4GE6gudnXgHJ7ftUzwPSjk1ETZBSZVRDI1HKEzU1lNM8sm0Qt3OCc6hlk0q3hdvzcXqCz9tc/xrxcHfH6kjl3e9UvobJfvpCbHMbdfMDia2PJLZ3iG2J985nYhubnLx5R/Tte5SNbcq7IVa+/5i3Al6fluvAv/O6Y4OsC0+WAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"packet\"\n        title=\"\"\n        src=\"/static/0000c7780b5d9a5ecc10f5a4a85f67c7/1cfc2/packet.png\"\n        srcset=\"/static/0000c7780b5d9a5ecc10f5a4a85f67c7/3684f/packet.png 225w,\n/static/0000c7780b5d9a5ecc10f5a4a85f67c7/fc2a6/packet.png 450w,\n/static/0000c7780b5d9a5ecc10f5a4a85f67c7/1cfc2/packet.png 900w,\n/static/0000c7780b5d9a5ecc10f5a4a85f67c7/21482/packet.png 1350w,\n/static/0000c7780b5d9a5ecc10f5a4a85f67c7/d61c2/packet.png 1800w,\n/static/0000c7780b5d9a5ecc10f5a4a85f67c7/4ef3c/packet.png 2863w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li><strong>SETTINGS 프레임</strong> 을 통해 초기 흐름 제어 창 크기와 최대 동시 스트림 수를 전송한다.</li>\n<li><strong>WINDOW_UPDATE 프레임</strong> 을 통해 수신자를 압도하지 않도록 전송하는 데이터의 양을 조절하기 위해 창 크기를 업데이트한다.</li>\n<li><strong>HEADERS 프레임</strong> 으로 HTTP/2 요청을 전송하고 <strong>DATA 프레임</strong> 으로 응답을 받는다.</li>\n<li>응답이 처리되고 클라이언트가 더 이상의 데이터를 기다리지 않으면 클라이언트는 <strong>GOAWAY 프레임</strong> 을 보내 연결을 종료한다.</li>\n</ol>\n<h1 id=\"소감과-무지-목록\" style=\"position:relative;\">소감과 무지 목록<a href=\"#%EC%86%8C%EA%B0%90%EA%B3%BC-%EB%AC%B4%EC%A7%80-%EB%AA%A9%EB%A1%9D\" aria-label=\"소감과 무지 목록 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>proto를 작성해서 generate된 stub들을 이용하여 client ↔︎ server 스트림 통신을 테스트해보는 간단한 테스트 코드를 작성해보았다.<br>\n그리고 새로운 서비스를 개발할 때 다른 팀원들이 템플릿처럼 사용할 수 있도록 회사 레포에 등록해두었다.<br>\n이벤트 루프를 블로킹하지 않는 주변 인프라가 더 많이 필요하며, 클라이언트와 서버 둘 다 수정이 필요하여 기존 서비스들에 적용하기에는 큰 도전일 것으로 예상된다.<br>\n이 기술들을 한 번에 적용하기 보다는 <a href=\"https://spring.io/blog/2015/03/22/using-google-protocol-buffers-with-spring-mvc-based-rest-services\">JSON을 proto로 바꿔보는 단계</a>를 밟는것도 좋을 것 같다.</p>\n<p>해당 프로젝트에는 처음 접하는 기술적인 키워드들이 많이 포함되어 있었고, 네트워크 지식이 부족하다고 느꼈다.<br>\n<strong>무지 목록</strong></p>\n<ol>\n<li>Netty에 대한 이해</li>\n<li>TCP 소켓 프로그래밍에 대한 이해</li>\n<li>HTTP/2에 대한 이해</li>\n<li>Armeria 아키텍처</li>\n</ol>","frontmatter":{"title":"Armeria + gRPC 사용해보기","date":"2022-12-15","update":"2022-12-15","description":null,"tags":["Armeria","gRPC","HTTP/2"]},"tableOfContents":"<ul>\n<li><a href=\"#armeria%EC%99%80-tomcat%EC%9D%84-%ED%95%9C-%EA%B0%9C%EC%9D%98-%ED%8F%AC%ED%8A%B8%EB%A1%9C\">Armeria와 Tomcat을 한 개의 포트로?</a></li>\n<li><a href=\"#grpc-%ED%86%B5%EC%8B%A0-%EC%A2%85%EB%A5%98\">gRPC 통신 종류</a></li>\n<li><a href=\"#armeria%EC%9D%98-server-thread%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%B2%98%EB%A6%AC%EB%90%A0%EA%B9%8C\">Armeria의 Server Thread는 어떻게 처리될까?</a></li>\n<li><a href=\"#%EC%86%8C%EA%B0%90%EA%B3%BC-%EB%AC%B4%EC%A7%80-%EB%AA%A9%EB%A1%9D\">소감과 무지 목록</a></li>\n</ul>"},"previous":{"fields":{"slug":"/2022y/iterator/"},"frontmatter":{"title":"Iterator?Enumerator?Iterable?"}},"next":{"fields":{"slug":"/2022y/yearend/"},"frontmatter":{"title":"2022년 회고"}}},"pageContext":{"id":"e289b6e1-1c61-5810-b7d7-f485a6333ffc","previousPostId":"6f2690f4-01db-5f44-84fc-d64d74856f71","nextPostId":"cb0167c3-fcfd-5461-8a47-ee07eda45e60"}},"staticQueryHashes":["230163734","3589320610"],"slicesMap":{}}