{"componentChunkName":"component---src-templates-blog-post-js","path":"/2024y/rwseparate/","result":{"data":{"site":{"siteMetadata":{"title":"코딩 주머니"}},"markdownRemark":{"id":"325cd622-d35f-5e04-ace5-dd06550f6571","excerpt":"IDC 환경의 MySQL 서버를 AWS로 마이그레이션하면서 스프링에서 읽기/쓰기 분리를 스프링에서 제공하는 LazyConnectionDataSourceProxy 클래스를 활용해서 해결하였다. 이번 글을 통해 JDBC와 스프링이 제공하는 PSA…","html":"<p>IDC 환경의 MySQL 서버를 AWS로 마이그레이션하면서 <a href=\"https://jdalma.github.io/2024y/mysqlMigration/#%EC%8A%A4%ED%94%84%EB%A7%81%EC%97%90%EC%84%9C-%EC%9D%BD%EA%B8%B0%EC%93%B0%EA%B8%B0-%EB%B6%84%EB%A6%AC\">스프링에서 읽기/쓰기 분리</a>를 스프링에서 제공하는 <a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jdbc/datasource/LazyConnectionDataSourceProxy.html\">LazyConnectionDataSourceProxy</a> 클래스를 활용해서 해결하였다.</p>\n<p>이번 글을 통해 JDBC와 스프링이 제공하는 PSA에 대해 정리해보고 어떤 원리로 읽기/쓰기가 분리된 것인지 이해해보려한다.</p>\n<h1 id=\"jdbc\" style=\"position:relative;\">JDBC<a href=\"#jdbc\" aria-label=\"jdbc permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/57d01e37159315a501e82468a2eb06d9/54c3a/jdbcApi.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABJUlEQVR42n2PTU7CUBSFuxKGLIABTlgFMzZnQDZQwoCBEyoJIGgCDUIlBSliQovYf7CU9rM8okNfcnPey333fPdI/X6fl+mUaVaqqrJcLDiezkRJyn8nSRKh3W6XcrlMpVJB13UkPTN4zkyVdpuHToe1YRDGZzZBjBmlPA2HyI0Gr/M5o9GIXq/HBRVGsdBqrUYulyOfz3NZTrpQrO2W2WyG53uCmqYpQZyycL8ZDB65b7XQJhPU8VgkCc9ghhGf2d/bao1CoUCxeCNgwlDTNOr1O97eN+xP8BGcMA9xtuk1VhAeiffZeBT9AX8jy7IsDEulEuMMKLmug7E2WK2WWDsLy3bxPZfAu6pt2+z2X9ieh+044u24rrh7vo9pmjSbTRRFEb0f7S5gaxbjceUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jdbcApi\"\n        title=\"\"\n        src=\"/static/57d01e37159315a501e82468a2eb06d9/1cfc2/jdbcApi.png\"\n        srcset=\"/static/57d01e37159315a501e82468a2eb06d9/3684f/jdbcApi.png 225w,\n/static/57d01e37159315a501e82468a2eb06d9/fc2a6/jdbcApi.png 450w,\n/static/57d01e37159315a501e82468a2eb06d9/1cfc2/jdbcApi.png 900w,\n/static/57d01e37159315a501e82468a2eb06d9/54c3a/jdbcApi.png 1257w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>우리가 쉽게 접하고 사용하는 MyBatis와 하이버네이트에서도 기저에는 JDBC API를 사용하여 데이터베이스와 통신하기에 먼저 JDBC가 무엇인지 이해할 필요가 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 350px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/db6eac85a5d94264e0b8039c94e2bbe8/13ae7/jdbcArchitecture.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 111.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAIAAABPIytRAAAACXBIWXMAAAPoAAAD6AG1e1JrAAACkklEQVR42oXUaU+aURAF4Pf//wc/SGKMxjQKAu47SBFcse4L7rgraowL7eN7I7Y2rfPhzWXuzJyZc+YS/Xy3RqPhe3p6WiqVVlZWfvxpvb29t7e3zbBg0afkWq22v78vuVwuq1IoFHzPz89TqZSrr5OLxWLp3WZmZvxcWlpqa2vT1D+TmzY7Ozs6Ojo9PZ3NZoeHh3O53MTExPj4+N3d3RfJT09PZ2dn+jQhzNXV1ZubGx7fv2E+ty0O1OTkpJm/x5bP51VB2PX19RczA0wmkx0dHe3t7Z2xJRKJrq6ulpYWdf+X/Pr66nBxcYEnM6OaSLqYn5+X6bYR20fyJ9fV1dXh4eH9/X3QPBzq9frx8XGTsGASP5AfHh5OTk4uLy+btQge5mQvLy/ABTw+Pn4ga2xvb69arRKGntvb24KQDApVCwsLbtfX1+m/u7ur/4GBgYODg62trY2NjQiTlUpFkCoyR0ZGiCzahvC4cs5kMiZfW1ubm5uzfIJFIjISRIZkbJYB2tTUlEZU6enp6evrCxWRBzmEARdAiAiriulneXkZCNixsTEt7ezsVGI7OjoyEWQe4ywuLnIaqrW1NYJmBzUGXxo0EUKV9xikDQ0NudIzfGfI2pFC/AiNeFMVvsPz8zOqfZ3xh/BAdfOLI3KGn5FQMobX97tOVs1EHklzKwlLCN0hkq5vUkkwLSVcOLgIDxNsLTYM44ITc7qzf9SG7xu5CI/We0Bbf38/TIQJ5YQsaHBwEIZIfmFBKhREfuv5W2y8QSd3CiGsu7t7c3MTfzLx4pHhid9Zxcgmawb1OrQ3oj3p8E9EJE6DiDYwFRQSaefRYfi33VaVYNoQBDMwKTk40+m0fQzL75H7S4Fpunq9/gtKPIDr1PEtjAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jdbcArchitecture\"\n        title=\"\"\n        src=\"/static/db6eac85a5d94264e0b8039c94e2bbe8/13ae7/jdbcArchitecture.png\"\n        srcset=\"/static/db6eac85a5d94264e0b8039c94e2bbe8/3684f/jdbcArchitecture.png 225w,\n/static/db6eac85a5d94264e0b8039c94e2bbe8/13ae7/jdbcArchitecture.png 350w\"\n        sizes=\"(max-width: 350px) 100vw, 350px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>JDBC(Java Database Connectivity)</strong> 는 클라이언트가 모든 종류의 표 형식 데이터, 특히 관계형 데이터베이스에 액세스할 수 있는 방법을 정의하는 Java용 응용 프로그래밍 인터페이스이다.<br>\nJava 애플리케이션과 데이터베이스 간의 <strong>중간 계층 인터페이스 역할</strong> 을 하며, 데이터 소스에 연결하거나 쿼리를 실행하고 데이터베이스 질의 결과를 처리하기 위한 가이드이다.</p>\n<p><strong>JDBC 드라이버</strong> 는 Java 애플리케이션의 요청을 DBMS가 이해할 수 있는 프로토콜로 변환하는 <code class=\"language-text\">클라이언트 측 어댑터</code>이다.<br>\n즉, JDBC 드라이버는 Java 애플리케이션과 데이터베이스가 상호 작용할 수 있도록 JDBC API의 인터페이스를 구현하는 소프트웨어 구성 요소이다.<br>\n이 드라이버의 유형에는 Sun Microsystem에서 정의한 4개의 유형이 있다.<br>\n(자세한 설명은 <a href=\"https://www.geeksforgeeks.org/jdbc-drivers/\">JDBC 드라이버</a>를 참고하자.)</p>\n<ol>\n<li>Type-1 드라이버 또는 JDBC-ODBC 브리지 드라이버</li>\n<li>Type-2 드라이버 또는 Native-API 드라이버</li>\n<li>Type-3 드라이버 또는 네트워크 프로토콜 드라이버</li>\n<li><strong>Type-4 드라이버 또는 Thin 드라이버(완전 Java 드라이버)</strong> : 데이터베이스에 직접 연결하여 JDBC 호출을 데이터베이스별 호출로 변환한다.</li>\n</ol>\n<p>데이터베이스마다 고유한 프로토콜이 필요하다는 단점이 있긴 하지만, 데이터베이스 서버에 직접 연결하면 다른 Type에 비해 더 나은 성능을 제공하는 장점이 있는 Type-4가 가장 일반적으로 사용된다.</p>\n<h2 id=\"jdbc-api-사용하기\" style=\"position:relative;\">JDBC API 사용하기<a href=\"#jdbc-api-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"jdbc api 사용하기 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 710px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/32a5df3c23949ec622af96963a1873d2/7131f/jdbc.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACxElEQVR42nVT224SURTlG/2JGh+8xKS+Wa3amBh9MMa+VkwAi22hpaRVQqClV6AU2oECM9zKwAyXggzMcO3ynI3TxISeZGXtGeZs1tpnHYsxGENp6Whqfcg3XYYeNGMIvm4xXfpwglxNh9zuY2K+vGdZUpUuzksdxBkS1xrVgqxRs2q1img0iouLC5zH40gwTiQSiLO63+/PbvhyI4un9is8/3GFeWcazxyMV9PQ+mOcRSP4urwMh8MBm83G2A6r1YqVlRV0Op2pi9v/JVvkVh/5hsEs9SCpXVYza63pv/9ptyFJEsrlMkGWKygWi4TRaDRb4YedAl65RbzzSHjNeMElEvcGE5RLRezt7yMcDuPk5ASnp6fER0dHMAxjtsJQ9ga/hQZ8SQahTnXgqokx+67dakEURVJUKBTuOJ/P36+QN3DHanCdKdiMKYxVeM5VjCZgm/Pw+/04Pj4mcIUHBwfYZ6pNhZPJhFSasHz2FbHE7C55cnjvzeHNlsTsi9CZ5aRwCbvdAZfLRXC73VhfX6da07TZlq+bBqS6DlHpIlvVILG88Xd88U38MCqVCoHHSJZlqnmjZrMJQRCQTqeRSqVoPJYXPzOY+ybg0fck5qxJPPgSw0P2zGOTl0Ts7OySzVAohMPDQwSDQfh8PrLMG9ntdqytrcHpdMLr9Zqx0VGo91BqMNwYqLAbwZ2Mx2MKMN/Moes6PZuhNhVydclkkiJm+bRbwFs2twVXlsL92JaaxmZ4i1KxQIfCo2LGhqvkau+NjZ9FZDtRhyeuws1OeOOshl+XDQxZbrp8hmxmtVoNqqoSK4pCs+TqZ8aGb/bE69iKqXCGK1gNK9iO1yg27XYL2WwWuVzuDtwWZ96wxXLKLWcyGbJNlj8yy4ubIsVl3pnBE3avF5ll/Z/lYHAPkUiELJs3hlseDAakNBAI0O/84Dj/BU1OMu3fQ/HOAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jdbc\"\n        title=\"\"\n        src=\"/static/32a5df3c23949ec622af96963a1873d2/7131f/jdbc.png\"\n        srcset=\"/static/32a5df3c23949ec622af96963a1873d2/3684f/jdbc.png 225w,\n/static/32a5df3c23949ec622af96963a1873d2/fc2a6/jdbc.png 450w,\n/static/32a5df3c23949ec622af96963a1873d2/7131f/jdbc.png 710w\"\n        sizes=\"(max-width: 710px) 100vw, 710px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">    // 1. JDBC 드라이버 로드는 JDBC4.0부터 클래스 경로에 있는 모든 드라이버가 자동으로 로드되기 때문에 직접 Class.forName을 호출할 필요가 없다.\n    public Member findById(String memberId) throws SQLException {\n        String sql = &quot;select * from member where member_id = ?&quot;;\n\n        Connection con = null;\n        PreparedStatement pstmt = null;\n        ResultSet rs =  null;\n\n        try {\n            // 2. 데이터베이스 연결 (커넥션 생성)\n            con = getConnection();\n\n            // 3. SQL 명령을 전송하기 위한 Statement 준비 (PreparedStatement 또는 CallableStatment)\n            pstmt = con.prepareStatement(sql);\n            pstmt.setString(1, memberId);\n\n            // 4. SQL문 전송\n            // 5. 질의문 결과(ResultSet) 생성\n            rs = pstmt.executeQuery();\n            if (rs.next()) {\n                Member member = new Member();\n                member.setMemberId(rs.getString(&quot;member_id&quot;));\n                member.setMoney(rs.getInt(&quot;money&quot;));\n                return member;\n            } else {\n                throw new NoSuchElementException(&quot;member not found memberId = {}&quot; + memberId);\n            }\n        } catch (SQLException e) {\n            log.error(&quot;db error&quot;, e);\n            throw e;\n        } finally {\n            // 6. 연결 해제 (사용된 리소스 해제)\n            close(con, pstmt, rs);\n        }\n    }\n\n    public Connection getConnection() {\n        try {\n            Connection connection = DriverManager.getConnection(URL, USERNAME, PASSWORD);\n            log.info(&quot;get connection = {}, class = {}&quot;, connection, connection.getClass());\n            return connection;\n        } catch (SQLException e) {\n            throw new IllegalStateException(e);\n        }\n    }</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/898fb4670e3f3fb1f814df9e31154f25/c2d9c/sequence.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmUlEQVR42n2P309ScRjGz3/RVl1oEmAl4K+FuS7sopuu/StKUfMXbl2RGvh/uBDlyEVOo+U6evCg44Qo57QWuCkH0VyCtWKw+enL7MKrnu2zPXufvXvfR0ql0szPh1mWl4lGoyxEZE5Ov9NQPL5OeCFCLCaL+RJy7B21Wo3/SRqbeMXNWy10tXfgcbm4Y2vjk6JSrF7y9Fk/LXcd9Hg92B338XQ+5vTfsXq9TqVywfn5FeVyhT/VKlIulyehJlhTNBRVQ9OSGMUzLmqXmIYhMo1VJcmGmmQ3naYqlhpaVxI473XT2+ul70kPzeKRwHQIqVEv/y1P0shhfhUIf/xDXPv1k6zxhUxmn487GfTdfbJZg8OTMw7Kv9nc1hkdnWR80o9/aooB3whvwxGk1zMhbty24XZ3Ym914XzQhba1hWmatLU/osnmwPuwVWROmu1u5JX3lEolCkeHFIsWVkFgWVfeKiAtLi4RCEwTDIaYmX1DMDTHpqqK6hrjE36evxhkeHiIgUEfvqGXfIjH2dvLkErp6HqDz9fQ+QuNFWqRUbGraAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sequence\"\n        title=\"\"\n        src=\"/static/898fb4670e3f3fb1f814df9e31154f25/1cfc2/sequence.png\"\n        srcset=\"/static/898fb4670e3f3fb1f814df9e31154f25/3684f/sequence.png 225w,\n/static/898fb4670e3f3fb1f814df9e31154f25/fc2a6/sequence.png 450w,\n/static/898fb4670e3f3fb1f814df9e31154f25/1cfc2/sequence.png 900w,\n/static/898fb4670e3f3fb1f814df9e31154f25/c2d9c/sequence.png 1326w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ul>\n<li><strong>DriverManager와 Driver</strong>\n<ul>\n<li>DriverManager가 모든 Driver를 로드한 다음, 연결 요청이 있을 때마다 각 드라이버에 차례대로 대상 URL에 연결을 시도하도록 요청한다. (<a href=\"https://www.baeldung.com/java-spi\">Service Provider Interface</a>)</li>\n<li>Driver는 모든 드라이버 클래스가 구현해야 하는 인터페이스이며, 실질적으로 데이터베이스에 연결을 시도하고 Connection을 반환하는 <code class=\"language-text\">connect()</code> 메서드가 있다.</li>\n</ul>\n</li>\n<li><strong>Connection</strong>\n<ul>\n<li>특정 데이터베이스와의 연결(세션)을 유지하며, SQL문이 실행되고 결과가 반환되는 컨텍스트이다.</li>\n<li>데이터베이스의 메타정보를 조회하거나 트랜잭션의 격리 수준과 커밋 모드 등을 수정하는 책임을 가지고 있다.</li>\n</ul>\n</li>\n<li><strong>PreparedStatement</strong>\n<ul>\n<li>SQL문을 나타내는 객체이며, 파라미터를 바인딩할 수 있다.</li>\n<li>SQL문을 실행하고 결과를 반환하는 책임이 있다.</li>\n</ul>\n</li>\n<li><strong>ResultSet</strong>\n<ul>\n<li>데이터베이스 결과 집합을 나타내며, 결과 집합의 데이터 행을 가리키는 커서를 유지한다.</li>\n<li>레코드의 데이터를 특정 데이터 타입으로 가져오는 방법을 제공한다.</li>\n</ul>\n</li>\n</ul>\n<p>아래와 같이 사용하는 데이터베이스 드라이버에 따라 다른 구현체가 선택되어 실행된다.</p>\n<table>\n<thead>\n<tr>\n<th>JDBC API</th>\n<th>H2</th>\n<th>MySQL</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>java.sql.Driver</td>\n<td>org.h2.Driver</td>\n<td>com.mysql.cj.jdbc.NonRegisteringDriver</td>\n</tr>\n<tr>\n<td>java.sql.Connection</td>\n<td>org.h2.jdbc.JdbcConnection</td>\n<td>com.mysql.cj.jdbc.ConnectionImpl</td>\n</tr>\n<tr>\n<td>java.sql.PreparedStatement</td>\n<td>org.h2.jdbc.JdbcPreparedStatement</td>\n<td>com.mysql.cj.jdbc.ClientPreparedStatement</td>\n</tr>\n<tr>\n<td>java.sql.ResultSet</td>\n<td>org.h2.jdbc.ResultSet</td>\n<td>com.mysql.cj.jdbc.result.ResultSetInternalMethods</td>\n</tr>\n</tbody>\n</table>\n<h1 id=\"커넥션-생성-추상화\" style=\"position:relative;\">커넥션 생성 추상화<a href=\"#%EC%BB%A4%EB%84%A5%EC%85%98-%EC%83%9D%EC%84%B1-%EC%B6%94%EC%83%81%ED%99%94\" aria-label=\"커넥션 생성 추상화 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 816px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/661794a0a401f3f85d631b3888725674/b4098/individualConnection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 33.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABH0lEQVR42l2Q6YrCUAyF+/6PJShuoNAFrT9cumgXtSrutmf4ApWZCYTk5ibnnMSZTCaaz+fmo9FIw+FQvu/rfr/rdrtZbPPX66WmafR+v/X5fISRP59Pe/Pn0IRvNht5nvf1KIq03W6tvl6vtVwuFYahsixTHMdKkkRFUajf76vT6WixWBiBMx6Pdblc1O12TSXNgADIUK/XUxAEGgwGpj7PcwMFDAK2OZ1ORo5K53q9qq5rU5CmqXa7nSmEEV+tVgYCEfWyLO293++/9fP5bCTgOMhkZRgw7oChcDqd/qkxxD0RQQQApfQeDgerGSAfrFdVlfnxeDTnFCghJ9Lz2yBqyYi2MmA8Ho+HDbbyXdfVbDazlbgRf/TQy8x/b+s/P5kOSM7JLvYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"individualConnection\"\n        title=\"\"\n        src=\"/static/661794a0a401f3f85d631b3888725674/b4098/individualConnection.png\"\n        srcset=\"/static/661794a0a401f3f85d631b3888725674/3684f/individualConnection.png 225w,\n/static/661794a0a401f3f85d631b3888725674/fc2a6/individualConnection.png 450w,\n/static/661794a0a401f3f85d631b3888725674/b4098/individualConnection.png 816w\"\n        sizes=\"(max-width: 816px) 100vw, 816px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이전에 알아보았던 <code class=\"language-text\">DriverManager.getConnection(...)</code>을 통한 커넥션 생성은 항상 새로운 커넥션을 생성한다.<br>\n이런 비효율적인 작업을 <strong>Connection Pool을 통해 개선할 수 있다.</strong><br>\n하지만 Connection Pool을 사용해서 Connection을 얻어오는 방법과 DriverManager를 사용해서 Connection을 얻어오는 방법이 서로 다를 수 있기에 자바는 <strong>Connection을 획득하는 방법을 추상화 시킬 수 있는 <code class=\"language-text\">javax.sql.DataSource</code> 인터페이스를 제공한다.</strong><br>\nJDBC API처럼 드라이버 공급업체에서 해당 DataSource 인터페이스를 구현해놓았다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c8a39f4b73a98fcfdcd300564cc7f77f/a3bed/dataSource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 40.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABXUlEQVR42o2RTUvDQBCGF/pz/AHevNSD9OzNi/gH9OpZ8CYeRagHwYMaLwUFEVtBpEmgYJuDaNOkpiEfhSa1janbfPS1WawkBbEDw+zOzjy8s0OwgE0mExZt20a1WoUoihAEAfV6HbquQ1EUOI7DnCTFaZ8HpfPNpgynP8CIBgjCGHJLQa1WA8dx7J1SCrKIwjAM8en78IYDuLYG19LQN9vwnC7irAYQ0zSZ7E6n8xs1TWNnVVXhui6GQ28qN4Le/cDGwQPW929R2LvHOW8mc2SgxPM8GIYBy7LQaDQgyzIqlQokSQLP8+xO6XjaF6IsvoGsniCXPwLJX2LzWE0GzQLTcoMgYPCZ93o9lvP9EeI4hv9FURLa4J4UnJVf8PpuZ5bGgP8tJbEoihHQESTZwMruDZZ3LrC0fY3DOyP54b8Vzm92Box/Oh6fVZDCKXKFIsjaFbaKrWl2jCgF/AZBXU6tROQwFQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dataSource\"\n        title=\"\"\n        src=\"/static/c8a39f4b73a98fcfdcd300564cc7f77f/1cfc2/dataSource.png\"\n        srcset=\"/static/c8a39f4b73a98fcfdcd300564cc7f77f/3684f/dataSource.png 225w,\n/static/c8a39f4b73a98fcfdcd300564cc7f77f/fc2a6/dataSource.png 450w,\n/static/c8a39f4b73a98fcfdcd300564cc7f77f/1cfc2/dataSource.png 900w,\n/static/c8a39f4b73a98fcfdcd300564cc7f77f/21482/dataSource.png 1350w,\n/static/c8a39f4b73a98fcfdcd300564cc7f77f/a3bed/dataSource.png 1721w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">    @Test\n    void dataSourceDriverManager() throws SQLException {\n        DataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);\n        \n        useDataSource(dataSource);\n    }\n\n    @Test\n    void dataSourceConnectionPool() throws SQLException {\n        HikariDataSource dataSource = new HikariDataSource();\n        dataSource.setJdbcUrl(URL);\n        dataSource.setUsername(USERNAME);\n        dataSource.setPassword(PASSWORD);\n        dataSource.setMaximumPoolSize(10);\n        dataSource.setPoolName(&quot;My Pool!!!&quot;);\n\n        useDataSource(dataSource);\n    }\n\n    private void useDataSource(DataSource dataSource) throws SQLException {\n        Connection con1 = dataSource.getConnection();\n        Connection con2 = dataSource.getConnection();\n        ...\n    }</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">// DrivetManager를 통한 요청할 때마다 Connection 새로 생성\n[main] DEBUG o.s.j.d.DriverManagerDataSource -- Creating new JDBC DriverManager Connection to [..]\n[main] DEBUG o.s.j.d.DriverManagerDataSource -- Creating new JDBC DriverManager Connection to [..]\n\n// HikariCP 초기화를 위한 Connection 생성\n[main] INFO  com.zaxxer.hikari.pool.HikariPool -- My Pool!!! - Added connection conn0: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn1: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn2: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn3: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn4: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn5: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn6: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn7: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn8: ...\n[connection adder] DEBUG ...HikariPool -- My Pool!!! - Added connection conn9: ...</code>\n        </deckgo-highlight-code>\n<p>이 추상화 덕분에 클라이언트 입장에서는 인터페이스에만 의존하기 때문에 Connection을 반환하는 DataSource의 구현체가 변경되어도 상관없다.</p>\n<h1 id=\"스프링-서비스-추상화\" style=\"position:relative;\">스프링 서비스 추상화<a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%B6%94%EC%83%81%ED%99%94\" aria-label=\"스프링 서비스 추상화 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>Connection에 대한 추상화를 통해 데이터베이스 의존성에 대한 결합도가 약해졌지만 아직 문제가 있다.</p>\n<ol start=\"3\">\n<li>데이터 접근 기술(JDBC, JPA...)마다 다른 트랜잭션 사용 방법은 어떻게 통일할 수 있을까? → <strong>트랜잭션 추상화</strong></li>\n<li>애플리케이션의 서비스 로직에 DB 트랜잭션 경계 설정을 사용하기 위해서는 어떻게 해야 할까? → <strong>리소스 동기화</strong></li>\n<li>반복되는 JDBC API 코드는 어떻게 해결할 수 있을까? → <strong>트랜잭션 AOP</strong></li>\n</ol>\n<p>스프링은 이미 모두 해결해놓았다.</p>\n<h2 id=\"트랙잭션-추상화\" style=\"position:relative;\">트랙잭션 추상화<a href=\"#%ED%8A%B8%EB%9E%99%EC%9E%AD%EC%85%98-%EC%B6%94%EC%83%81%ED%99%94\" aria-label=\"트랙잭션 추상화 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>Spring 프레임워크는 트랜잭션 관리를 위한 일관된 추상화를 제공한다. 대표적인 인터페이스들을 알아보자.<br>\n트랜잭션 상태를 질의할 수 있고 트랜잭션 Commit,Rollback에 사용되는 <code class=\"language-text\">TransactionStatus</code> 인터페이스를 제공한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4b988c7e14f0a66e7ac4d3ba40607a45/fbf76/transactionStatus.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABk0lEQVR42nVS25ajIBD0N1au4iVoIAJmzs5sJiLiZTP//0Hb6mw2L3tOnabFKrpoOrGdtd3VbsvVuTdIykq21hjbwafW5iRr6xzsm51q3dV1b835QmiW3MPHvfdxnuM6hTEOY2yUuvl3H/3yWH++37S53MPt9tmPyzQuse8HoIEeE56kiKWIIswI54gyAOEiJYxkHGcsJZSwDG9gmDPMeJrSg0+ZSBgXjOeMbSBEyKaJa++HsP5+zMu6rg/IM1FSKg7ORuY5KDfxsRwgJINYSVmUstaqVqo61UUlweEr7Yl/YmiAKErdXqAZZ9U2Sp+VPnKlW57l/xHvzkEs6ybM9wGaNsY4f8XlKwxhmhdwLvISmPsFxdN5QghHiEEDEKaY5ikpAD9QxkrDTwazApEc0RJhvnM2pDt/E5+0+xWnYQhQEMr4EIcQ47Q4d4VzoYL7HDwQQvQ+gIXeB3gqeF2RV0leNQoGwLjWdi0MB0TjYBLqRsNF4Hip7cV8779GnhXfttMD+G+C2LPDGL/8PYDgqTfbfwAyBWv2hBAolwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"transactionStatus\"\n        title=\"\"\n        src=\"/static/4b988c7e14f0a66e7ac4d3ba40607a45/1cfc2/transactionStatus.png\"\n        srcset=\"/static/4b988c7e14f0a66e7ac4d3ba40607a45/3684f/transactionStatus.png 225w,\n/static/4b988c7e14f0a66e7ac4d3ba40607a45/fc2a6/transactionStatus.png 450w,\n/static/4b988c7e14f0a66e7ac4d3ba40607a45/1cfc2/transactionStatus.png 900w,\n/static/4b988c7e14f0a66e7ac4d3ba40607a45/fbf76/transactionStatus.png 1252w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>그리고 DataSource와 TransactionStatus를 사용하는 <code class=\"language-text\">PlatformTransactionManager</code> 인터페이스를 제공한다.<br>\n<code class=\"language-text\">org.springframework.transaction.PlatformTransactionManager</code> 인터페이스는 명령형 트랜잭션 관리를 위한   트랜잭션 추상화의 핵심이다.<br>\n(반응형을 위한 ReactiveTransactionManager 인터페이스도 존재한다.)</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">public interface PlatformTransactionManager extends TransactionManager {\n\n    TransactionStatus getTransaction(TransactionDefinition definition) \n        throws TransactionException;\n    void commit(TransactionStatus status) throws TransactionException;\n    void rollback(TransactionStatus status) throws TransactionException;\n}</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f0f039ea5f89657df54fda01d9f03f06/22284/platformTransactionManager.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA5UlEQVR42k2QCY7DMAhFc48m3rJ6iW0wTtK0c/9rDWnVqtKTBZgPXzRCmi+d0CGu5/m435/Oh3Faptm9sFL1v51vmk6wxghlpL7efhxp35Dq4ixWSrlAISTS/SAVC/SHl5hXIRKUwh1rzFyaFj9MVpmxYy/S3FoldZ8AMhLWI0PBsvXDfGtlwx82RCACpARY6uGBQsL9eG7Hn424QqXtBNpLPUOuCTcsOzuaF8e2Ne/hnTFTTBhj5tTa4H1kxsku1nu/csW56wqz9dYFHyIfohFCs8OEBS4/lafwuLZTb37jT6q/8T+c3DjL4t5WcQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"platformTransactionManager\"\n        title=\"\"\n        src=\"/static/f0f039ea5f89657df54fda01d9f03f06/1cfc2/platformTransactionManager.png\"\n        srcset=\"/static/f0f039ea5f89657df54fda01d9f03f06/3684f/platformTransactionManager.png 225w,\n/static/f0f039ea5f89657df54fda01d9f03f06/fc2a6/platformTransactionManager.png 450w,\n/static/f0f039ea5f89657df54fda01d9f03f06/1cfc2/platformTransactionManager.png 900w,\n/static/f0f039ea5f89657df54fda01d9f03f06/21482/platformTransactionManager.png 1350w,\n/static/f0f039ea5f89657df54fda01d9f03f06/d61c2/platformTransactionManager.png 1800w,\n/static/f0f039ea5f89657df54fda01d9f03f06/22284/platformTransactionManager.png 2428w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2 id=\"리소스-동기화\" style=\"position:relative;\">리소스 동기화<a href=\"#%EB%A6%AC%EC%86%8C%EC%8A%A4-%EB%8F%99%EA%B8%B0%ED%99%94\" aria-label=\"리소스 동기화 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>스프링은 Connection 동기화를 위해 <code class=\"language-text\">ThreadLocal</code>을 사용하는 <strong>TransactionSynchronizationManager</strong> 를 제공한다.<br>\nAbstractPlatformTransactionManager와 이 추상 클래스를 상속하고 있는 하위 클래스는 템플릿 메서드 패턴으로 협력하며, TransactionSynchronizationManager를 이용한다.</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">public class MemberService {\n\n    private final PlatformTransactionManager transactionManager;\n\n    public void accountTransfer(String fromId, String toId, int money) {\n        // TransactionStatus를 생성하면서 트랜잭션을 시작한다.\n        TransactionStatus status = transactionManager.getTransaction(\n            new DefaultTransactionDefinition()\n        );\n\n        try {\n            bizLogic(fromId, toId, money);\n            transactionManager.commit(status);\n        } catch (Exception e) {\n            transactionManager.rollback(status);\n            throw new IllegalStateException(e);\n        }\n    }\n    ...\n}</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ceb7c0749bcfbdac796575bc45f62089/1c181/transactionSynchronization.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABt0lEQVR42nWS227iUAxF+f/vQTwj8VAQggppWkBcCoWQEEJCroTc1tinoepoZo7kWMmJl+1td/jfaRo4nWD/+eUdB85nqjDEEb/dbNiIrddroihqQxo6Pxl5nuN5nsQ6BEFAld8pAp/d+zt4F7hcqOX99WVEt9tlOByyXC65Xq9/A+u6lgLOTKdTer0e8/kc7+RQJSlhnFDUUIrdC7C9CN/3sSwL27ZNhff73dg3sKoqacXlbb5gNBzxJlU57pVM7qy4YevDIYT4AYlAmzbuKFDtShOEIkeHsqQp5K+qJLmF2HuL+HjAl2qLNAW5q8qKSgi16tqSVJLD4cBkMmG1WhlolmUClMfjFhNrG15K5CdEbkAaZoR+Sh5EBqqcoiiMzqqV6rZYLOj3+0amZ5Wm5Vqzi4/yhs1qy6/pK57rfQndtlZKJ67rcrvdDEyrUc2N1i1ME3ae0zFtJA/so0WZpZxVcFkXDVK7yIQ1UI9ugbZ7au+f8Xo6z5UzwLRk/bEjkCq22w8zRQ3WyhQwGAyYzWaMx2MzWR2kmm6IQr/X5slPHjW745n90cbx/D8yq3YK1m/qFfSv8xuiKPpAxN4VpAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"transactionSynchronization\"\n        title=\"\"\n        src=\"/static/ceb7c0749bcfbdac796575bc45f62089/1cfc2/transactionSynchronization.png\"\n        srcset=\"/static/ceb7c0749bcfbdac796575bc45f62089/3684f/transactionSynchronization.png 225w,\n/static/ceb7c0749bcfbdac796575bc45f62089/fc2a6/transactionSynchronization.png 450w,\n/static/ceb7c0749bcfbdac796575bc45f62089/1cfc2/transactionSynchronization.png 900w,\n/static/ceb7c0749bcfbdac796575bc45f62089/21482/transactionSynchronization.png 1350w,\n/static/ceb7c0749bcfbdac796575bc45f62089/d61c2/transactionSynchronization.png 1800w,\n/static/ceb7c0749bcfbdac796575bc45f62089/1c181/transactionSynchronization.png 2696w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p><code class=\"language-text\">DataSourceUtils.getConnection()</code> : TransactionSynchronizationManager가 관리하는 Connection이 있으면 해당 Connection을 반환한다. 없으면 생성해서 반환한다.<br>\n<code class=\"language-text\">DataSourceUtils.releaseConnection()</code> : 동기화된 Connection은 닫지 않고, 동기화되지 않은 Connection은 닫아버린다.</p>\n</blockquote>\n<h2 id=\"트랜잭션-aop\" style=\"position:relative;\">트랜잭션 AOP<a href=\"#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-aop\" aria-label=\"트랜잭션 aop permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>서비스 추상화를 통해 유연해졌고, 트랜잭션 동기화 매니저를 통해 Connection도 동기화하였다.<br>\n하지만 아직 서비스 계층에서 트랜잭션 관련 코드가 남아있는데, 이 문제를 <code class=\"language-text\">@Transacitonal</code>을 통해 해결할 수 있다.<br>\n일반적으로 데이터베이스, 트랜잭션 관련 API를 직접 사용하는 것보다 Spring 추상화를 통한 작업이 훨씬 더 유연하기 때문에 DataSourceUtils나 다른 헬퍼 클래스 사용을 자제하는 것이 좋다.</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">// [4]\npublic interface Service {\n    // [3]\n    void method1();\n    // [3]\n    void method2();\n}\n\n// [2]\npublic class ServiceImpl implements Service {\n    // [1]\n    public void method1(){ ... }\n    // [1]\n    public void method2() { ... }\n}</code>\n        </deckgo-highlight-code>\n<p><code class=\"language-text\">@Transactional</code>을 적용할 때 <strong>4단계의 대체정책</strong> 을 이용한다.<br>\n타깃 오브젝트의 메소드 → 타깃 클래스 → 선언 메소드 → 선언 클래스(또는 인터페이스)의 순서에 따라서 적용됐는지 차례대로 확인하고,\n가장 먼저 발견되는 속성정보를 사용하게된다.<br>\n그리고 <code class=\"language-text\">public</code>으로 정의된 메서드만 트랜잭션이 걸리게 스프링이 제한해놓았다.</p>\n<p>이 AOP를 적용하기 위해 아래의 클래스가 제공된다.</p>\n<ol>\n<li><strong>어드바이저</strong> : <code class=\"language-text\">BeanFactoryTransactionAttributeSourceAdvisor</code></li>\n<li><strong>포인트컷</strong> : <code class=\"language-text\">TransactionAttributeSourcePointcut</code></li>\n<li><strong>어드바이스</strong> : <code class=\"language-text\">TransactionInterceptor</code></li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/49c8549d53cd8118065147c65dac8727/50f29/transactionalAOP.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.111111111111114%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9ElEQVR42mWPy3KEIBBF/ZDogCiCgLxEZ5GqSVZj/v+DbhomySaLW5fu0y+6fuCQSsM6j+E2/lPlbz1vXuNFrRiFfMXDizMuoLSBUgZdLXKbRy4FYpLUzFrR74BpXjDPqr1vTCDmTEMNeqqrTNDw2pfyTiroBCV9TAiU0Ktr2wUNqD7JBWkvKOcd86JRa3M56IBIC0dYvyGmHcY6yt9p2YlunmaY1cLaAE3f8Z4gXeHpamsMgg+IIcMZh3XViDE2xtkIMU6Np3iQRyip0F17wjN6XDk2fZHelURhAw7O8eHsH3vo5SfPcI4Mn8SeKZCIk19hwzeDEZUva0tLfQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"transactionalAOP\"\n        title=\"\"\n        src=\"/static/49c8549d53cd8118065147c65dac8727/1cfc2/transactionalAOP.png\"\n        srcset=\"/static/49c8549d53cd8118065147c65dac8727/3684f/transactionalAOP.png 225w,\n/static/49c8549d53cd8118065147c65dac8727/fc2a6/transactionalAOP.png 450w,\n/static/49c8549d53cd8118065147c65dac8727/1cfc2/transactionalAOP.png 900w,\n/static/49c8549d53cd8118065147c65dac8727/21482/transactionalAOP.png 1350w,\n/static/49c8549d53cd8118065147c65dac8727/d61c2/transactionalAOP.png 1800w,\n/static/49c8549d53cd8118065147c65dac8727/50f29/transactionalAOP.png 3038w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4b3bc8b5068ee8ed290789cdd4624700/fe6cb/transactional.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8ElEQVR42oVTa2/aQBD0//9FqZR8AjUKEUmkBgOC2Bgwxg9e5mH8nM5cYtRUlXrScvZ5b3ZmdrHwn1VVFc7nM47HI06nE+rLBXUQ4Oy6AHesVkAUKdHkW/ppmuYbSFMUaK5XgJe3cYzxeIyH+3vYwyHSJMGV4do26rJEmecomV/y+QZY1zWyLDNMtFcMbDYmouUS/ZcX/Li7Q+/5Gcl6bYDsfh+z2Qwh2SliFs4JbgATVhyNRhgMBvj1/o5AcnhJvBsWU2JBFiqmdSFz5Ym5TaYu8xeLhbHEAK7oxVOvhzcy+fn4CPfjAzcr/rKj9TU9HJCmKSaTCcIwpI2RKWqJiaJm9Wa///RPZzL5y+jW4z+9Fqh8W9ISyRWgClgFfSp3O+TcL/yYcS8IXPAs226NDHkrADG4slnyXDZNp1N0Oh0jW++ywsqZpBUTbPz6isj3b0w2BNywQEBLNDZ6Fos9C4qVgLrdLobsvnKMh6Jds3pAoBVj7s1MtYDzpXc1RHIcxzFdFbDPczVoRxUqUn81TkQsyah4sKax3nzOjs0MgEBluJh4nmcANQVz5kiqvutM4Ac2qF3WJzKwCGI43hJ+mNCvGu04yTOBik17sWVllFDqN0C96IJPiQN64nBklCSfNA6aNUmVRMkViEj86x8mwN/6XJBgmdiPlQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"transactional\"\n        title=\"\"\n        src=\"/static/4b3bc8b5068ee8ed290789cdd4624700/1cfc2/transactional.png\"\n        srcset=\"/static/4b3bc8b5068ee8ed290789cdd4624700/3684f/transactional.png 225w,\n/static/4b3bc8b5068ee8ed290789cdd4624700/fc2a6/transactional.png 450w,\n/static/4b3bc8b5068ee8ed290789cdd4624700/1cfc2/transactional.png 900w,\n/static/4b3bc8b5068ee8ed290789cdd4624700/21482/transactional.png 1350w,\n/static/4b3bc8b5068ee8ed290789cdd4624700/d61c2/transactional.png 1800w,\n/static/4b3bc8b5068ee8ed290789cdd4624700/fe6cb/transactional.png 2879w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Spring AOP 덕분에 비즈니스 로직까지 모두 해결하였다. 프록시 생성에 대한 자세한 내용은 <a href=\"https://jdalma.github.io/2024y/postprocessor/#%EB%B9%88-%ED%9B%84%EC%B2%98%EB%A6%AC%EA%B8%B0%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%9E%90%EB%8F%99-%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%83%9D%EC%84%B1%EA%B8%B0\">빈 후처리기를 이용한 프록시 생성에 대해</a>를 참고하자.</p>\n<hr>\n<h1 id=\"spring-61-이전-읽기쓰기-분리\" style=\"position:relative;\">Spring 6.1 이전 읽기/쓰기 분리<a href=\"#spring-61-%EC%9D%B4%EC%A0%84-%EC%9D%BD%EA%B8%B0%EC%93%B0%EA%B8%B0-%EB%B6%84%EB%A6%AC\" aria-label=\"spring 61 이전 읽기쓰기 분리 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>JDBC부터 스프링이 Connection을 가져오는 방법을 추상화한 것과 ThreadLocal + TransactionSynchronizationManager를 통해 리소스 동기화를 하는 방법 그리고 스프링 AOP를 통해 트랜잭션 관련 로직과 비즈니스 로직을 완벽히 분리해내는 것까지 알아보았다.<br>\n이제 본론으로 돌아가서 읽기/쓰기 분리한 방법에 대해 알아보자.<br>\n테스트 환경은 Spring Boot 3.2.2, 도커 컨테이너로 직접 실행한 MySQL 컨테이너 2개, JdbcTemplate을 사용하였다.<br>\n자세한 예제는 <a href=\"https://github.com/jdalma/datasource-routing-test\">datasource-routing-test</a>에서 확인할 수 있다.</p>\n<deckgo-highlight-code language=\"yml\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">spring:\n  datasource:\n    primary:\n      driverClassName: com.mysql.cj.jdbc.Driver\n      jdbcUrl: jdbc:mysql://localhost:3306/test\n      username: root\n      password: root\n    secondary:\n      driverClassName: com.mysql.cj.jdbc.Driver\n      jdbcUrl: jdbc:mysql://localhost:3307/test\n      username: root\n      password: root</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@Configuration\nclass ReplicationDataSourceConfig {\n    @Bean\n    @Primary\n    @DependsOn(&quot;primaryDataSource&quot;, &quot;secondaryDataSource&quot;, &quot;routingDataSource&quot;)\n    fun dataSource(): DataSource = LazyConnectionDataSourceProxy(routingDataSource())\n\n    @Bean\n    fun routingDataSource(): DataSource = RoutingDataSource(primaryDataSource(), secondaryDataSource())\n\n    @Bean\n    @ConfigurationProperties(prefix = &quot;spring.datasource.primary&quot;)\n    fun primaryDataSource(): DataSource {\n        return DataSourceBuilder.create().build()\n    }\n\n    @Bean\n    @ConfigurationProperties(prefix = &quot;spring.datasource.secondary&quot;)\n    fun secondaryDataSource(): DataSource {\n        return DataSourceBuilder.create().build()\n    }\n}</code>\n        </deckgo-highlight-code>\n<p>각 DB로 라우팅 역할을 하는 <code class=\"language-text\">RoutingDataSource</code>에 primary, secondary DataSource를 주입하고 <code class=\"language-text\">LazyConnectionDataSourceProxy</code>로 감싼 DataSource를 <code class=\"language-text\">@Primary</code>로 등록한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5233d78fec13777390de802c6374de46/64ef0/lazyConnection.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABkklEQVR42pWST2+CQBTE/f4fyIs9a+KhXmqtghFEUFH+KCqCsNMZQlOb0kM3eexulp0377evh9sNyHM0c7s+7XbYWBbWjHC9RlUU0DDG4PF4oK6qJiqG9s+jl18ucFYrJFEE8GJNQddx8D6f4202w3yxQMZ/NLIsQ8T/7OUSHzx3XRdxHON+v38LGmWRkDLVtWwgSRJs6MznhcD3UbYOb0zmBwE8CnpM6noegu32h8seOobRh4kgZ8JAZ3LPmzCHA0BREAu0fhITkk7BnE7k0LVtpHRr5FxlMWoKV5oZBRMWWvNcPDX/EtTBgZlHoxH6/T4sMsyPxwZHQbGYCU7nM0o6i8hvv983Bm6sRIx/CSqLGC4I/XUygUNO9/ZRApb6MhhgOBzCJ1vtPZ7LgJJtybOzZImKh7gZlZymAF2ldHq9Xhsn0+kU4/EYNrHsyFOiFtusU/DrYdQB4mbEjwlSXpKYKgjDsMGjUiXk8NUl/qdg1zjTpZyXZdkI1y1XJbgQy5Lt9G/Bou1JNbPKl0OF9mr6T5feUCOP3qmLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lazyConnection\"\n        title=\"\"\n        src=\"/static/5233d78fec13777390de802c6374de46/1cfc2/lazyConnection.png\"\n        srcset=\"/static/5233d78fec13777390de802c6374de46/3684f/lazyConnection.png 225w,\n/static/5233d78fec13777390de802c6374de46/fc2a6/lazyConnection.png 450w,\n/static/5233d78fec13777390de802c6374de46/1cfc2/lazyConnection.png 900w,\n/static/5233d78fec13777390de802c6374de46/21482/lazyConnection.png 1350w,\n/static/5233d78fec13777390de802c6374de46/d61c2/lazyConnection.png 1800w,\n/static/5233d78fec13777390de802c6374de46/64ef0/lazyConnection.png 4071w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>대략적인 구조는 위와 같다.<br>\n일반적으로는 <code class=\"language-text\">4. getConnection()</code>에서 반환되는 것이 <code class=\"language-text\">java.sql.Connection</code>의 구현체가 반환되지만 <code class=\"language-text\">LazyConnectionDataSourceProxy</code>를 사용하면 Proxy를 반환한다.</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">// Statement(또는 PreparedStatement나 CallableStatement)에 대한 요청이 있을 때 실제 JDBC Connection을 느리게 가져오는 Connection 핸들을 반환합니다.\n// 반환된 Connection 핸들은 ConnectionProxy 인터페이스를 구현하여 기본 대상 Connection을 검색할 수 있습니다.\n@Override\npublic Connection getConnection() throws SQLException {\n    checkDefaultConnectionProperties();\n    return (Connection) Proxy.newProxyInstance(\n        ConnectionProxy.class.getClassLoader(),\n        new Class&lt;?&gt;[] {ConnectionProxy.class},\n        new LazyConnectionInvocationHandler()\n    );\n}</code>\n        </deckgo-highlight-code>\n<p>어떤 흐름으로 사용할 Connection을 선택하는지 확인해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3ad8ce5ae7adb9b6b42c9ec6b7057f1e/7798c/dataSourceProxy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABpUlEQVR42oVS2W7bMBDU/39U+upXB25sJz7g1pKtIyJFk7p4TIeMkyIJihJYSKKWwzk2w/+Wc+ilhFEKfpqAYQCaBraqUF4uOO73OO52+HU8Yv/8jOzr+fAVjyBnHvh9OGDoOkBr4HbDxHeR51BFAUlgdb0iZ1/2DuJDQAjhG8F5nhOLzXoNE8FYoW0BVn8+Q5O5IWvnfaqsnzyE9ijEjFpZqMHDur/AloAtJTeUOUS59zWS+Xq7xY+HB6xWKxhj0n4mlcblWqF5bVHVr6mm2d31Ezj6RhZhHD/ZIXnJMM1ohGK/hRAyKcy0NqjKEsvlEtvthvbcMPQjEP0SIgUi6zqVvrNIgNFD1ePpUBJUp+8EKGSH0+mExWKRfKp4cDCUxidodAQ6MMHdywuainvefQDmxQVPGwZ2ztHy8iS5o+SSDOu6YdXJq3Gyb3JZ0egQZRPAMoiBEt3NwNHbaI33gcVA3NtFWQzAxvHQPdw4w/o4euFjgFqC/KTpq8dHFGQ087+1PvX470PBsYlM6BuuJVkIBCc/NcT0Cs5awVnrGM57Vv9afwBeiwL+2ajGhwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"dataSourceProxy\"\n        title=\"\"\n        src=\"/static/3ad8ce5ae7adb9b6b42c9ec6b7057f1e/1cfc2/dataSourceProxy.png\"\n        srcset=\"/static/3ad8ce5ae7adb9b6b42c9ec6b7057f1e/3684f/dataSourceProxy.png 225w,\n/static/3ad8ce5ae7adb9b6b42c9ec6b7057f1e/fc2a6/dataSourceProxy.png 450w,\n/static/3ad8ce5ae7adb9b6b42c9ec6b7057f1e/1cfc2/dataSourceProxy.png 900w,\n/static/3ad8ce5ae7adb9b6b42c9ec6b7057f1e/7798c/dataSourceProxy.png 1183w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>targetDataSource의 Connection을 통해 DB 세션의 자동 커밋 유무와 트랜잭션 격리수준을 저장한다. 이때 최초 Connection을 생성(커넥션 풀 준비)하고 동기화를 위해 바인딩하게 된다.</li>\n<li>ConnectionProxy를 구현한 타겟 클래스를 <code class=\"language-text\">LazyConnectionInvocationHandler</code> 구현체로 동적 프록시를 생성하여 Connection 타입으로 반환한다.</li>\n<li>생성한 Connection 타입의 동적 프록시를 반환하면서 ThreadLocal에 저장한다.</li>\n<li>데이터 로직 처리에서 Query를 실행한다.</li>\n<li>바인딩되어 있는 Connection을 조회하여 반환한다.</li>\n<li>반환받은 Connection으로 Statement를 요청한다.</li>\n<li>RoutingDataSource를 생성할 때 <code class=\"language-text\">setTargetDataSources()</code>를 통해 정의해놓은 <code class=\"language-text\">resolvedDataSources</code>필드인 라우팅 맵을 이용하여 사용할 Connection을 조회한다.</li>\n</ol>\n<p><code class=\"language-text\">2번</code>단계는 Connection이 최초 사용되는 경우라면 LazyConnectionDataSourceProxy의 auto-commit 유무와 격리수준 레벨을 세팅하기 위한 Connection을 최초로 생성하는 과정이 발생한다.<br>\n이때 구현 드라이버에 따라 Connectipn Pool이 준비된다. 준비된 ConnectionPool은 바인딩된다.<br>\n(나는 readonly가 아닌 경우에는 항상 primary DB를 사용하도록 하여서 primary HikariCP가 먼저 준비되었다.)</p>\n<p>일반적인 경우에는 <code class=\"language-text\">3번</code>단계에서 바인딩되는 DataSource는 사용할 DataSource 그 자체가 저장되지만, LazyConnectionDataSourceProxy를 이용하여 감싼 DataSource를 저장하여 <strong>Statement를 생성할 때 사용할 DataSource 라우팅을 통해 결정하는 것이 핵심이다.</strong></p>\n<p>즉, <strong><code class=\"language-text\">4번</code>과 같이 query가 실행되어 실제로 Connection이 필요한 경우에만 <code class=\"language-text\">7번</code>을 통해 DataSource를 라우팅하는 RoutingDataSource가 오버라이딩한 <code class=\"language-text\">determineCurrentLookupKey()</code> 메소드를 통해 어떤 DataSource를 사용할지 결정하는 것이다.</strong></p>\n<h1 id=\"datasource-router-not-initialized-예외-발생\" style=\"position:relative;\">DataSource router not initialized 예외 발생<a href=\"#datasource-router-not-initialized-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D\" aria-label=\"datasource router not initialized 예외 발생 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>조금 더 깔끔하게 작성하고 싶어 DataSource를 등록할 때 <code class=\"language-text\">LazyConnectionDataSourceProxy</code>와 <code class=\"language-text\">RoutingDataSource</code>를 한 번에 등록하면 아래와 같이 예외가 발생한다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@Configuration\nclass ReplicationDataSourceConfig {\n    @Bean\n    @Primary\n    @DependsOn(&quot;primaryDataSource&quot;, &quot;secondaryDataSource&quot;)\n    fun routingDataSource(): DataSource = LazyConnectionDataSourceProxy(\n        RoutingDataSource(primaryDataSource(), secondaryDataSource())\n    )\n\n    ...\n}</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">java.lang.IllegalArgumentException: DataSource router not initialized\n...lookup.AbstractRoutingDataSource.determineTargetDataSource(AbstractRoutingDataSource.java:255)\n...lookup.AbstractRoutingDataSource.getConnection(AbstractRoutingDataSource.java:213)\n...LazyConnectionDataSourceProxy.checkDefaultConnectionProperties(LazyConnectionDataSourceProxy.java:212)</code>\n        </deckgo-highlight-code>\n<p>원인은 RoutingDataSource가 상속받은 <code class=\"language-text\">AbstractRoutingDataSource</code>의 <code class=\"language-text\">resolvedDataSource</code> 필드가 초기화되지 않아 발생한 문제다.<br>\n초기화되는 시점은 <code class=\"language-text\">InitializingBean</code> 인터페이스를 통한 <code class=\"language-text\">afterPropertiesSet()</code> 시점에 (RoutingDataSource 초기화 시점에 정의한) <code class=\"language-text\">targetDataSource</code>를 복사하여 <code class=\"language-text\">resolvedDataSource</code>를 초기화한다.</p>\n<p><a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/beans/factory/BeanFactory.html\">Interface BeanFactory</a>를 보면 BeanFactory에서 12번째 단계에서 <code class=\"language-text\">afterPropertiesSet()</code>를 호출하여 준다.<br>\n즉, <strong>AbstractRoutingDataSource를 상속한 RoutingDataSource 자체가 Bean으로 정의되지 않아 BeanFactory를 통한 작업 과정이 생략되었기에 위와 같은 예외가 발생하는 것이다.</strong><br>\n그렇기에 꼭 Bean으로 등록해주여야 한다.</p>\n<h1 id=\"spring-61-이후-추가된-읽기쓰기-분리-개선\" style=\"position:relative;\">Spring 6.1 이후 추가된 읽기/쓰기 분리 개선<a href=\"#spring-61-%EC%9D%B4%ED%9B%84-%EC%B6%94%EA%B0%80%EB%90%9C-%EC%9D%BD%EA%B8%B0%EC%93%B0%EA%B8%B0-%EB%B6%84%EB%A6%AC-%EA%B0%9C%EC%84%A0\" aria-label=\"spring 61 이후 추가된 읽기쓰기 분리 개선 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>이번에 Spring 6.1.2 부터 <code class=\"language-text\">setReadOnlyDataSource()</code> 메소드가 추가되었으며, 자세한 히스토리는 아래의 이슈 내용을 확인하길 바란다.</p>\n<ul>\n<li><a href=\"https://github.com/spring-projects/spring-framework/issues/31785\">#31785 Support for a read-only DataSource in LazyConnectionDataSourceProxy</a></li>\n<li><a href=\"https://github.com/spring-projects/spring-framework/issues/21415\">#21415 Document LazyConnectionDataSourceProxy setup for routing datasource to act on transaction definition read-only flag</a></li>\n</ul>\n<p>이전에 사용했던 읽기/쓰기 분리 기준을 정의해 놓았던 <code class=\"language-text\">RoutingDataSource</code>는 필요하지 않고 아래와 같이 작성하면 끝이다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@Configuration\nclass ReplicationDataSourceConfig {\n    @Bean\n    @Primary\n    @DependsOn(&quot;primaryDataSource&quot;, &quot;secondaryDataSource&quot;)\n    fun dataSource(): DataSource = LazyConnectionDataSourceProxy(primaryDataSource()).apply {\n        setReadOnlyDataSource(secondaryDataSource())\n    }\n}</code>\n        </deckgo-highlight-code>\n<p>Connection을 생성할 DataSource를 결정할 때 추가된 <code class=\"language-text\">getDataSourceToUse()</code> 메소드로 가져오게 된다.</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">public class LazyConnectionDataSourceProxy extends DelegatingDataSource {\n    private DataSource readOnlyDataSource;\n    ...\n\n    private class LazyConnectionInvocationHandler implements InvocationHandler {\n        private boolean readOnly = false;\n\n        private DataSource getDataSourceToUse() {\n            return (this.readOnly &amp;&amp; readOnlyDataSource != null ? \n                readOnlyDataSource : obtainTargetDataSource()\n            );\n        }\n        ...\n    }\n}</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b8d37cbee21c6d8847ad1011bf546150/b1c31/readonlyDataSource.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABoUlEQVR42o1S2ZLCMAzj//9vC7NQoNBy9E56kTaNVg6wwwN7eMZN48SypXihLheoLMNhvcaeLv9dUcBZCzvPGG43FGUJ3TSYJGYMwBiGAWBMHY9QaQrwTGxRclPlOcrrFcVuh3K/hyaAB2w0TF0hPxygzidYrTC1Ldw4AvSJwDnz0vMZYHEPKB/nHGJWipno5IB7sZ7A4km4QZ7EMCzQVxW7uSeP04SS+1wYPXIW8mPZTc/KPatZ0vCHjHWM6a7DibJkPGuZPApVKSrUuY5aY1TKdywx32Fd11itVvikV9TQ8RKEGim5m7kXmCza6wXpdossimB4Dyw29z1m3hUXXT2gIXJJahWBbww6XpLL3rk3BOu5ZqQWUucojjExp+N5GIbY8DEbAXxq+M4sm6rISpNJUTdYBh9YLpcIggAROxyFIjufyWImdc+C/g0ogaewz72dmcBQrVsvS8qJEJduBtFNxoeaexdWv3X4ak3b4XzNfGenJPHyDA8A/0Ayg69j85cJvapWyNldwcfwQ86ReWf/AhRtnOGLc2xkAmbR7wf7AtmAVZ0aJr+yAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"readonlyDataSource\"\n        title=\"\"\n        src=\"/static/b8d37cbee21c6d8847ad1011bf546150/1cfc2/readonlyDataSource.png\"\n        srcset=\"/static/b8d37cbee21c6d8847ad1011bf546150/3684f/readonlyDataSource.png 225w,\n/static/b8d37cbee21c6d8847ad1011bf546150/fc2a6/readonlyDataSource.png 450w,\n/static/b8d37cbee21c6d8847ad1011bf546150/1cfc2/readonlyDataSource.png 900w,\n/static/b8d37cbee21c6d8847ad1011bf546150/21482/readonlyDataSource.png 1350w,\n/static/b8d37cbee21c6d8847ad1011bf546150/b1c31/readonlyDataSource.png 1413w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">1 ~ 3번</code>은 스프링이 초기화하면서 <code class=\"language-text\">SpringTransactionAnnotationParser</code>에서 <code class=\"language-text\">TransactionAttribute</code>를 생성하며 생성에 성공한다면 해당 <code class=\"language-text\">TransactionAttribute</code>를 캐싱한다.<br>\n캐싱되는 내용은 간략하게 아래와 같다. 자세한 내용은 <a href=\"https://github.com/spring-projects/spring-framework/blob/main/spring-tx/src/main/java/org/springframework/transaction/annotation/SpringTransactionAnnotationParser.java#L59\">SpringTransactionAnnotationParser #L59</a>를 확인하면 된다.<br>\n<code class=\"language-text\">4 ~ 5번</code>은 캐시되어 있는 <code class=\"language-text\">TransactionAttribute</code> 목록에서 현재 실행되고 있는 메소드 또는 클래스 기준으로 캐시 정보를 조회하며, 준비 작업을 한다.<br>\n이때 <code class=\"language-text\">LazyConnectionDataSourceProxy</code>의 <code class=\"language-text\">readonly</code> 속성을 <code class=\"language-text\">TransactionAttribute</code> 기준으로 업데이트 해준다.</p>\n<blockquote>\n<p>TransactionAttribute에는 Transaction의 격리 수준, 전파 속성, <strong>읽기 전용 유무</strong> , 타임아웃, 롤백할 클래스 이름 등이 저장되어 있다.<br>\n한마디로 <code class=\"language-text\">@Transactional</code>에서 기입할 수 있는 정보들을 묶어 놓은 것이다.</p>\n</blockquote>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">{MethodClassKey@10042} &quot;...MemberService.findAllPrimary() -&gt; \n    {RuleBasedTransactionAttribute@10043} &quot;PROPAGATION_REQUIRED,ISOLATION_DEFAULT&quot;\n{MethodClassKey@9559} &quot;...MemberService.findAllSecondary() -&gt; \n    {RuleBasedTransactionAttribute@9560} &quot;PROPAGATION_REQUIRED,ISOLATION_DEFAULT,readOnly&quot;</code>\n        </deckgo-highlight-code>\n<p><code class=\"language-text\">7번</code>의 동적 프록시 <code class=\"language-text\">LazyConnectionInvocationHandler</code>는 매 요청마다 매번 새로 생성된다.<br>\n<code class=\"language-text\">8번</code> 과정에서 DataSource를 가져올 때 <code class=\"language-text\">readOnly</code>와 <code class=\"language-text\">readOnlyDataSource</code> 유무를 기준으로 어떤 DataSource를 사용할지 결정된다.</p>\n<p>즉, <strong><code class=\"language-text\">readOnlyDataSource</code> 관리를 <code class=\"language-text\">LazyConnectionDataSourceProxy</code>가 해주면서 추가적인 작업이 필요없어졌다.</strong><br>\n만약 읽기 전용으로 라우팅할 것이 아니라면 이전 방법으로 해야 한다.</p>\n<h1 id=\"참고\" style=\"position:relative;\">참고<a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<ol>\n<li><a href=\"https://etutorials.org/SQL/Postgresql/Part+II+Programming+with+PostgreSQL/Chapter+13.+Using+PostgreSQL+from+a+Java+Client+Application/JDBC+Architecture+Overview/\">JDBC Architecture Overview</a></li>\n<li><a href=\"https://www.baeldung.com/java-jdbc\">Introduction to JDBC</a></li>\n<li><a href=\"https://www.baeldung.com/java-jdbc-loading-drivers\">Loading JDBC Drivers</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=ONYVhJGl48U&#x26;ab_channel=%EC%9A%B0%EC%95%84%ED%95%9C%ED%85%8C%ED%81%AC\">[10분 테코톡] 코코닥의 JDBC</a></li>\n<li><a href=\"https://jiwondev.tistory.com/291\">JDBC Connection 에 대한 이해, HikariCP 설정 팁</a></li>\n<li><a href=\"https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-db-1\">스프링 DB 1편 - 데이터 접근 핵심 원리</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/reference/data-access/transaction/tx-resource-synchronization.html\">Synchronizing Resources with Transactions</a></li>\n<li><a href=\"https://docs.spring.io/spring-framework/reference/data-access/transaction/strategies.html#page-title\">Understanding the Spring Framework Transaction Abstraction</a></li>\n</ol>","frontmatter":{"title":"Spring RW분리를 이해하기 위한 여정 (+ JDBC, 서비스 추상화)","date":"July 14, 2024","description":null,"tags":["Lab","Spring","Transaction"]},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#jdbc\">JDBC</a></p>\n<ul>\n<li><a href=\"#jdbc-api-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\">JDBC API 사용하기</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%BB%A4%EB%84%A5%EC%85%98-%EC%83%9D%EC%84%B1-%EC%B6%94%EC%83%81%ED%99%94\">커넥션 생성 추상화</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8A%A4%ED%94%84%EB%A7%81-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%B6%94%EC%83%81%ED%99%94\">스프링 서비스 추상화</a></p>\n<ul>\n<li><a href=\"#%ED%8A%B8%EB%9E%99%EC%9E%AD%EC%85%98-%EC%B6%94%EC%83%81%ED%99%94\">트랙잭션 추상화</a></li>\n<li><a href=\"#%EB%A6%AC%EC%86%8C%EC%8A%A4-%EB%8F%99%EA%B8%B0%ED%99%94\">리소스 동기화</a></li>\n<li><a href=\"#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98-aop\">트랜잭션 AOP</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#spring-61-%EC%9D%B4%EC%A0%84-%EC%9D%BD%EA%B8%B0%EC%93%B0%EA%B8%B0-%EB%B6%84%EB%A6%AC\">Spring 6.1 이전 읽기/쓰기 분리</a></p>\n</li>\n<li>\n<p><a href=\"#datasource-router-not-initialized-%EC%98%88%EC%99%B8-%EB%B0%9C%EC%83%9D\">DataSource router not initialized 예외 발생</a></p>\n</li>\n<li>\n<p><a href=\"#spring-61-%EC%9D%B4%ED%9B%84-%EC%B6%94%EA%B0%80%EB%90%9C-%EC%9D%BD%EA%B8%B0%EC%93%B0%EA%B8%B0-%EB%B6%84%EB%A6%AC-%EA%B0%9C%EC%84%A0\">Spring 6.1 이후 추가된 읽기/쓰기 분리 개선</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2024y/invokedynamic/"},"frontmatter":{"title":"invokedynamic 이란?"}},"next":null},"pageContext":{"id":"325cd622-d35f-5e04-ace5-dd06550f6571","previousPostId":"2275afde-24fc-5e5f-a733-7848b131695e","nextPostId":null}},"staticQueryHashes":["230163734","3589320610"],"slicesMap":{}}