{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025y/webclient/","result":{"data":{"site":{"siteMetadata":{"title":"코딩 주머니"}},"markdownRemark":{"id":"e0b1b946-ea07-5d47-9d52-4627d912ebd9","excerpt":"문제 발견 모니터링을 통해 1,2주 간격으로 한 번씩 PrematureCloseException 예외가 발생하는 것을 확인했다. 외부 서비스를 초당 300 ~ 40…","html":"<h1 id=\"문제-발견\" style=\"position:relative;\">문제 발견<a href=\"#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EA%B2%AC\" aria-label=\"문제 발견 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>모니터링을 통해 1,2주 간격으로 한 번씩 PrematureCloseException 예외가 발생하는 것을 확인했다.<br>\n외부 서비스를 초당 300 ~ 400회 정도, 요청하고 응답을 기다리지 않는 비동기 방식으로 부하가 몰릴 때 발생하는 것을 추가로 확인할 수 있었다.</p>\n<p>예외의 원인을 확실하게 이해하기 위해 WebClient의 커넥션 풀이 어떻게 관리되는지 정상적인 케이스를 먼저 확인해보자.</p>\n<h1 id=\"webclient-connection-상태-변화\" style=\"position:relative;\">WebClient Connection 상태 변화<a href=\"#webclient-connection-%EC%83%81%ED%83%9C-%EB%B3%80%ED%99%94\" aria-label=\"webclient connection 상태 변화 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0f2eb4eb48b8b415d28cbf06c49185ad/2d3cc/network-sequence.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 108.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADmklEQVR42n1Va3PdNBDN//8RfOALHQqddtLCDC2FNuRCmlI6+QQ0TW58/X7bkiz5IR+OZS65bVo0c0b2rnS82j1aH4FjECNUrCGIeqfQt+NixjxjnYm0N/CEhNcK7DqNadDQuQ+VBxDJFroI3MojRygnkkk0wQ6Nt0Nfp/RVwFgCU4mhz+FXHrb5e3jlFfzWw6RDqOSC+95CJn9DV4mL4Gj9PsekYNtHgHwCqMf/wapjJNFX8C/voaseYZLHtO39T7jnG1j9J/ZnOTo8WttWkLKB7gQ6dYs8S1EWGZRoUBU5jFbOrrV09nEcsB//Eq6Mdd2SUMOYAcMwESNGzllaIggSCKlQVa3zd50h4YCybEk4fY6wgVKKCzWiKEHgR4ijFEWxRK7QNK3DOI7ohx7WTrRLTNMdwv2RJQl7Eo581g5SGkY0ctMMIbQjWIaVOyriGJn/HZLtQ+IxZjscFGXWGNvnnE6A/heWfsMqb6iAl2iSZyjCH9Ckz1i7F/RvMMvv0edfwmRfQJc/w0ifgU1rhOtgXurfSXABWb5GnZ5BFOdo83Nkwa8oojOUyRnnDW2vUKWvKJ2/YNoLajL7uMprlFkhULcWeTkgyQziVCNONPygJQSipMPWq51/8VHjyAvtcvpBDvcR6uYcXfMavXjjMKi3jOY3RDcvEFz/hGR3wlPs/X9At2/QZKewfXwY4W0OhyWHHXOoT1eYU9pOmL+nyIOnqOMfKeyXB/4NRkGbufmcsDt02q7oeL8JYyakWYUwpLC7HkVJQdOmOuacc140d2WDWTHBHmL/AnnEoojUCXyRiKQuFx2GYUxRN8jzwmlVCMFZ0ld+SOiCm0LU4UMElw+Qbu+hl+8xWZrH0S1ebsJEQ98PUBT4UsTFvswL+SeEvZ65qmqkaeZuSZYWfM4Rx3wPE4ckyZgKjcM9y/v/EAqXR6UM0bnFgtrwd6EjLnn0qqyZ1975tDYuHZ8gXHRkUVcFJDuO7to1f0sz8AMEJAwZ9fXWc8TLx4RY/aXL4aEOJwkR3OedfIB4+zVS7z7Sm2+hVeGqb6c1f8vLxO6jZLe2z8XGoe4e2cLUMUQUoA481P6OjTShom4XuU409kg6iZA9MR8MLN/HltEWIe9yhFGWt0fuG3aX0LDSlMhW8AN3/ykBm+5VmeOauGqpvZ7SiS7RxFeogneQqbf/Baw75+EAdsbHY5gtNGEs5WPt+pnJYB4Nu5J2rWuJ8B+t35bXjKLX7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"network sequence\"\n        title=\"\"\n        src=\"/static/0f2eb4eb48b8b415d28cbf06c49185ad/1cfc2/network-sequence.png\"\n        srcset=\"/static/0f2eb4eb48b8b415d28cbf06c49185ad/3684f/network-sequence.png 225w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/fc2a6/network-sequence.png 450w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/1cfc2/network-sequence.png 900w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/21482/network-sequence.png 1350w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/d61c2/network-sequence.png 1800w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/2d3cc/network-sequence.png 3529w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>8080포트의 서버에서 9090포트의 서버로 요청을 보내고 1초 후에 응답하는 API를 테스트해보았다.<br>\n(keep-alive timeout = 3000ms)</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5ea0ecd5cd827df7dd23f51fa247aae4/0ad08/success_network_log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABP0lEQVR42iWP3UvCcBiF+/8v+4IuIkuzkbp0mzO/m/v4mW6OzMwsJCuhAiXSUst6mvbC4XmuDuddIzi/2UbRi5QMgeW4FMo2tvCoWDV0SUY/kNDDx2Qiy8RWfhqwcCRT1/Is7vssngb8zL9YWxbWm5fI2RxFR2C73oqi4SM8n0Q0hrR7QCx0SCIcRY5IxAMuXTuWsTMFZrc95r0+s+my8Bc6vS4VX9C4a9F+7OIH7AzuuB7ccuZaFEQ5oIm4FFRbVawLC+fCxu24dB9ueBt9MB1/BtN+g8LXV/xsFiUaJWcYGOdVchUDs17DrNVQ0ipyUkZRUyhaEk1XV1TTKbL5DFdNn+/3MYsgTCb/L3uNNknFoFT2MM0mxZKH41zh2C3Se3GUzX3U7QjyeojUVpiTjdDK9R2JtmbAyzMMhzAa8Qe64k2+vcc34QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"success network log\"\n        title=\"\"\n        src=\"/static/5ea0ecd5cd827df7dd23f51fa247aae4/1cfc2/success_network_log.png\"\n        srcset=\"/static/5ea0ecd5cd827df7dd23f51fa247aae4/3684f/success_network_log.png 225w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/fc2a6/success_network_log.png 450w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/1cfc2/success_network_log.png 900w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/21482/success_network_log.png 1350w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/d61c2/success_network_log.png 1800w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/0ad08/success_network_log.png 2978w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>WebClient를 생성할 때 metrics를 활성화하여 로그를 확인해볼 수 있다.</p>\n<details>\n<summary>💡 WebClient Connection Pool 로그 자세히보기</summary>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">val httpClient = HttpClient.create(connectionProvider)\n    .metrics(true) { uriTagValue -&gt; uriTagValue }\n    .doOnConnected { conn -&gt;\n        conn.channel().closeFuture().addListener {\n            logger.info(&quot;[Connection Closed] : $conn&quot;)\n        }\n        logger.info(&quot;[New Connection] : $conn&quot;)\n    }\n    .doOnConnect { config -&gt;\n        logger.info(&quot;[Connection Attempt] Attempting to connect...&quot;)\n    }\n\nreturn WebClient.builder()\n    .baseUrl(&quot;http://localhost:9090&quot;)\n    .clientConnector(ReactorClientHttpConnector(httpClient))\n    .build()</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">Creating a new [my-provider] client pool [PoolFactory{evictionInterval=PT0S, leasingStrategy=fifo, maxConnections=1, maxIdleTime=-1, maxLifeTime=-1, metricsEnabled=false, pendingAcquireMaxCount=2, pendingAcquireTimeout=45000}] for [localhost/&lt;unresolved&gt;:9090]\n[1965a96f] Created a new pooled channel, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[1965a96f] REGISTERED\n[1965a96f] CONNECT: localhost/127.0.0.1:9090\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Registering pool release on close event for channel\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Channel connected, now: 1 active connections, 0 inactive connections and 0 pending acquire requests.\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] ACTIVE\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}, [connected])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=null, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [configured])\n[New Connection] : GET{uri=null, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Handler is being applied: {uri=http://localhost:9090/internal/delay/1, method=GET}\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [request_prepared])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] WRITE: 102B GET /internal/delay/1 HTTP/1.1\nuser-agent: ReactorNetty/1.1.22\nhost: localhost:9090\naccept: */*\n\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] FLUSH\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] WRITE: 0B\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] FLUSH\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [request_sent])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] READ: 142B HTTP/1.1 200 \nContent-Type: text/plain;charset=UTF-8\nContent-Length: 28\nDate: Tue, 23 Sep 2025 06:09:17 GMT\n\n\ndelay api success. seconds=1\n15:09:17.136+09:00 --- [r-http-kqueue-2] r.n.http.client.HttpClientOperations     : [1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Received response (auto-read:false) : RESPONSE(decodeResult: success, version: HTTP/1.1)\nHTTP/1.1 200 \nContent-Type: &lt;filtered&gt;\nContent-Length: &lt;filtered&gt;\nDate: &lt;filtered&gt;\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [response_received])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] [terminated=false, cancelled=false, pending=0, error=null]: subscribing inbound receiver\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Received last HTTP packet\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [response_completed])\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [disconnecting])\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Releasing channel\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Channel cleaned, now: 0 active connections, 1 inactive connections and 0 pending acquire requests.\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] READ COMPLETE\n\n-- 3초 이후 --\n\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[Connection Closed] : GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090]}}\n[1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090] INACTIVE\n[1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090]}, [disconnecting])\n[1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090] UNREGISTERED</code>\n        </deckgo-highlight-code>\n</details>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5668a456313ea5b13ed9a1731a3afd3d/0a47e/connection-statediagram.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 280%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"connection statediagram\"\n        title=\"\"\n        src=\"/static/5668a456313ea5b13ed9a1731a3afd3d/0a47e/connection-statediagram.png\"\n        srcset=\"/static/5668a456313ea5b13ed9a1731a3afd3d/3684f/connection-statediagram.png 225w,\n/static/5668a456313ea5b13ed9a1731a3afd3d/fc2a6/connection-statediagram.png 450w,\n/static/5668a456313ea5b13ed9a1731a3afd3d/0a47e/connection-statediagram.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>로그와 다이어그램을 통해 Connection의 상태가 변화되는 단계를 확인해볼 수 있었다.<br>\n이제 PrematureCloseException이 발생하는 원인에 대해 더 자세하게 확인해보자.</p>\n<h1 id=\"prematurecloseexception이-발생하는-케이스\" style=\"position:relative;\">PrematureCloseException이 발생하는 케이스<a href=\"#prematurecloseexception%EC%9D%B4-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EC%BC%80%EC%9D%B4%EC%8A%A4\" aria-label=\"prematurecloseexception이 발생하는 케이스 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><code class=\"language-text\">HttpClientOperations.onInboundClose()</code>는 원격 서버에서 FIN 패킷을 보내어 수신 서버에서 EOF 이벤트를 감지하여 정상적으로 연결을 닫는 경우 호출된다.</p>\n<ol>\n<li>(테스트 환경이 mac이라서) KQueueEventLoop 에서 FIN 패킷을 EV_EOF 이벤트로 감지</li>\n<li>EV_EOF 이벤트로 인해 EOF 처리, Half-closure 설정에 따라 입력만 종료 또는 전체 종료 결정</li>\n<li>Channel inputShutdown 플래그 설정 + 시스템 레벨 소켓 수신 부분 종료</li>\n<li>실제 소켓 fd 닫기 + closeInitiated 플래그 설정</li>\n<li>channelInactive 이벤트가 파이프라인 통해 전파 EventLoop에서 채널 등록 해제</li>\n<li><strong>ChannelHandler.channelInactive() 프로토콜별 정리 작업에서 onInboundClose() 호출</strong> -> HTTP 프로토콜 레벨에서 어떤 단계에서 문제가 발생했는지 구분해서 적절한 예외를 발생시킨다.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e0e7f9a29c48c31fdd0971949c15ba2f/fe7a3/onInboundClose.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABy0lEQVR42m1S7W7bMAz0W2xtYsu2vizHi/xtt07cBh2QAkP/7P3f5XZyAgTY9uNAiiKPPEqRVhq+cihdhaLqYH+0sEUJbUooUyBXBlmmN6SZQn73hciR3CFSiafnBE07IEp4yKWBP3q4soINxMUBh6qGox9IlS4gld3ItSxgpCO5/D+h4EWYxrBIa0ewwDooNpG5vsWMg1UlrCw3K9LHdP8S8qC0RdsMaOsB3jeUfkTGiVKSplIjodQkfWBPwr14ICbHt10CHwhjTpgxqWVhbyx6yg3wJKtJ6nMJtxd/Ib0hvtkyzqC/77DUHaKKsj6THGcWL/aAM/f2QsKRu5ood2B84O562n6zBoO+x9i0pz9yEM+BfvEdIp8bfJHwQ1qcmHDmxTuJ30l6IfnK5EUbLMbgdPdP1uCVeNMaPyn/lTVTkuGr7REZyp2ExMjH6Jjc8wEGW26de8aC3/GlW5J1/GINFfXK0XeYqaLe9quxexZouhFRwYU2nGzl35sp64UyA2ZKmtg5xGYST8EybyDhGEB/pLqaOQGHWODS8VEuHPUqMlx0ias94rM44kpcSLKycOUnXrmONTSlXXJFSCxSbvbM88rmc5LidzfiD2XNJlv0V0AGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onInboundClose\"\n        title=\"\"\n        src=\"/static/e0e7f9a29c48c31fdd0971949c15ba2f/1cfc2/onInboundClose.png\"\n        srcset=\"/static/e0e7f9a29c48c31fdd0971949c15ba2f/3684f/onInboundClose.png 225w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/fc2a6/onInboundClose.png 450w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/1cfc2/onInboundClose.png 900w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/21482/onInboundClose.png 1350w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/d61c2/onInboundClose.png 1800w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/fe7a3/onInboundClose.png 8106w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<ol>\n<li>요청 헤더 전송</li>\n<li>요청 바디 전송   ← 여기서 닫히면 <code class=\"language-text\">\"while sending request body\"</code> <strong>아직 요청도 완전히 못 보낸 상태</strong></li>\n<li>요청 완료</li>\n<li>서버 처리 중     ← 여기서 닫히면 <code class=\"language-text\">\"BEFORE response\"</code> <strong>요청은 보냈지만 응답을 아직 못 받은 상태</strong></li>\n<li>응답 헤더 수신</li>\n<li>응답 바디 수신   ← 여기서 닫히면 <code class=\"language-text\">\"DURING response\"</code> <strong>응답을 받기 시작했지만 응답이 완전히 안 온 상태</strong></li>\n<li>응답 완료</li>\n</ol>\n</blockquote>\n<h2 id=\"1-while-sending-request-body\" style=\"position:relative;\">1. while sending request body<a href=\"#1-while-sending-request-body\" aria-label=\"1 while sending request body permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>클라이언트 서버가 요청을 보내고 있는 경우 커넥션이 닫히면 발생한다.</p>\n<h2 id=\"2-before-response\" style=\"position:relative;\">2. BEFORE response<a href=\"#2-before-response\" aria-label=\"2 before response permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>송신 서버와 수신 서버가 연결된 이후에 수신 서버가 일방적으로 커넥션을 닫는 경우다.<br>\n즉, ChannelActive 상태까지 도달한 후 클라이언트가 응답을 대기하고 있지만 서버가 해당 채널을 닫아버리는 경우이다.</p>\n<details>\n<summary>💡 Netty 예제 코드 및 로그 자세히 보기</summary>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">fun main() {\n    val parentGroup = NioEventLoopGroup()\n    val workerGroup = NioEventLoopGroup()\n\n    try {\n        ServerBootstrap()\n            .group(parentGroup, workerGroup)\n            .channel(NioServerSocketChannel::class.java)\n            .childHandler(object : ChannelInitializer&lt;SocketChannel&gt;() {\n                override fun initChannel(ch: SocketChannel) {\n                    ch.pipeline().addLast(RudeServerHandler())\n                }\n            })\n            .bind(8080).sync()\n            .channel().closeFuture().sync()\n    } finally {\n        parentGroup.shutdownGracefully()\n        workerGroup.shutdownGracefully()\n    }\n}\n\nprivate class RudeServerHandler : ChannelInboundHandlerAdapter() {\n\n    private val logger = org.slf4j.LoggerFactory.getLogger(this::class.java)\n\n    override fun channelRegistered(ctx: ChannelHandlerContext) {\n        logger.info(&quot;[REGISTERED] Channel registered: ${ctx.channel()}&quot;)\n        super.channelRegistered(ctx)\n    }\n\n    override fun channelUnregistered(ctx: ChannelHandlerContext) {\n        logger.info(&quot;[UNREGISTERED] Channel unregistered: ${ctx.channel()}&quot;)\n        super.channelUnregistered(ctx)\n    }\n\n    override fun channelActive(ctx: ChannelHandlerContext) {\n        logger.info(&quot;[ACTIVE] Channel active (connected): ${ctx.channel()}&quot;)\n        super.channelActive(ctx)\n    }\n\n    override fun channelInactive(ctx: ChannelHandlerContext) {\n        logger.info(&quot;[INACTIVE] Channel inactive (disconnected): ${ctx.channel()}&quot;)\n        super.channelInactive(ctx)\n    }\n\n    override fun channelRead(ctx: ChannelHandlerContext, msg: Any) {\n        logger.info(&quot;[READ] Data received from client: ${ctx.channel()}&quot;)\n        logger.info(&quot;[READ] Message content: ${msg}&quot;)\n\n        // 데이터를 받자마자 즉시 연결을 끊음 (FIN 패킷 전송)\n        ctx.close()\n        logger.info(&quot;[READ] Connection close initiated&quot;)\n    }\n\n    override fun channelReadComplete(ctx: ChannelHandlerContext) {\n        logger.info(&quot;[READ_COMPLETE] Channel read complete: ${ctx.channel()}&quot;)\n        super.channelReadComplete(ctx)\n    }\n}</code>\n        </deckgo-highlight-code>\n</details>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">[REGISTERED] Channel registered: [id: 0x19ba8155, L:/127.0.0.1:8080 - R:/127.0.0.1:58625]\n[ACTIVE] Channel active (connected): [id: 0x19ba8155, L:/127.0.0.1:8080 - R:/127.0.0.1:58625]\n[READ] Data received from client: [id: 0x19ba8155, L:/127.0.0.1:8080 - R:/127.0.0.1:58625]\n[READ] Message content: PooledUnsafeDirectByteBuf(ridx: 0, widx: 159, cap: 2048)\n[READ] Connection close initiated\n[READ_COMPLETE] Channel read complete: [id: 0x19ba8155, L:/127.0.0.1:8080 ! R:/127.0.0.1:58625]\n[INACTIVE] Channel inactive (disconnected): [id: 0x19ba8155, L:/127.0.0.1:8080 ! R:/127.0.0.1:58625]\n[UNREGISTERED] Channel unregistered: [id: 0x19ba8155, L:/127.0.0.1:8080 ! R:/127.0.0.1:58625]</code>\n        </deckgo-highlight-code>\n<ol>\n<li><code class=\"language-text\">ChannelRegistered</code> : Channel 이 Event Loop에 등록됨</li>\n<li><code class=\"language-text\">ChannelActive</code> : Channel이 활성화됨, 이제 데이터를 주고받을 수 있음</li>\n<li><code class=\"language-text\">Channellnactive</code> : Channel이 원격 피어로 연결되지 않음</li>\n<li><code class=\"language-text\">ChannelUnregistered</code>: Channel이 생성됐지만 Event Loop에 등록되지 않음</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0021a9ec656e7946c29270483c4b3a9c/60708/beforeResponse.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 12.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAlUlEQVR42h3KywqCQACFYZ+/G0FEEJlpRQiRpaMRWU0tLEbLZkoJyoXZe5xGFz/nWxxluMzQMxOoiw9UK4NBCvTnL4zJT/oL3c7RnQl0phztyQONEUdNi9EyBOraHU2dVx5YOcxNAeV0DOGuKShlKB2xJ3w/wDVMwC4C5yCGTfayHTz5K3flbOF6h8qOjEjfohSpeOMPuld/EmQl+bUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"beforeResponse\"\n        title=\"\"\n        src=\"/static/0021a9ec656e7946c29270483c4b3a9c/1cfc2/beforeResponse.png\"\n        srcset=\"/static/0021a9ec656e7946c29270483c4b3a9c/3684f/beforeResponse.png 225w,\n/static/0021a9ec656e7946c29270483c4b3a9c/fc2a6/beforeResponse.png 450w,\n/static/0021a9ec656e7946c29270483c4b3a9c/1cfc2/beforeResponse.png 900w,\n/static/0021a9ec656e7946c29270483c4b3a9c/21482/beforeResponse.png 1350w,\n/static/0021a9ec656e7946c29270483c4b3a9c/d61c2/beforeResponse.png 1800w,\n/static/0021a9ec656e7946c29270483c4b3a9c/60708/beforeResponse.png 2872w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>송신 서버 (클라이언트)는 reactor.netty.http.client.PrematureCloseException: Connection prematurely closed BEFORE response 예외를 전달받지만 패킷상으로는 정상적인 통신이 완료된 것을 확인할 수 있다.</p>\n<h2 id=\"3-during-response\" style=\"position:relative;\">3. DURING response<a href=\"#3-during-response\" aria-label=\"3 during response permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>송신 서버가 수신 서버에게 헤더를 정상적으로 응답받고 바디를 대기하는 도중 커넥션이 송신 서버가 커넥션을 일방적으로 닫는 경우이다.<br>\n즉 송신 서버가 헤더를 정상적으로 받고 바디를 완전히 받기 위해 대기하는 중에 수신 서버가 일방적으로 커넥션을 종료하는 경우이다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@GetMapping(&quot;/abort-connection&quot;)\nfun abortConnection(response: HttpServletResponse) {\n    logger.info(&quot;Starting abort connection...&quot;)\n    \n    try {\n        val writer = response.writer\n        \n        // 응답 데이터를 한 번 전송하여 클라이언트가 정상적으로 읽기 시작하도록 유도\n        writer.write(&quot;Starting response...&quot;)\n        writer.flush()\n\n        Thread.sleep(100)\n\n        // 일방적으로 종료! FIN 패킷 전달\n        response.outputStream.close()\n\n        writer.write(&quot;This should not be sent&quot;)\n        \n    } catch (e: IOException) {\n        logger.error(&quot;IOException during abort: ${e.message}&quot;)\n    }\n}</code>\n        </deckgo-highlight-code>\n<details>\n<summary>💡 WebClient Connection Pool 로그 자세히보기</summary>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">Creating a new [my-provider] client pool [PoolFactory{evictionInterval=PT0S, leasingStrategy=fifo, maxConnections=1, maxIdleTime=-1, maxLifeTime=-1, metricsEnabled=false, pendingAcquireMaxCount=2, pendingAcquireTimeout=45000}] for [localhost/&lt;unresolved&gt;:9090]\n[551113d8] Created a new pooled channel, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[551113d8] REGISTERED\n[551113d8] CONNECT: localhost/127.0.0.1:9090\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Registering pool release on close event for channel\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Channel connected, now: 1 active connections, 0 inactive connections and 0 pending acquire requests.\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] ACTIVE\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}, [connected])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=null, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [configured])\n[New Connection] : GET{uri=null, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Handler is being applied: {uri=http://localhost:9090/force/abort-connection, method=GET}\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [request_prepared])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] WRITE: 108B GET /force/abort-connection HTTP/1.1\nuser-agent: ReactorNetty/1.1.22\nhost: localhost:9090\naccept: */*\n\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] FLUSH\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] WRITE: 0B\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] FLUSH\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [request_sent])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] READ: 108B HTTP/1.1 200 \nTransfer-Encoding: chunked\nDate: Sat, 27 Sep 2025 05:28:01 GMT\n14\nStarting response...    // 첫 번째 청킹 데이터 정상적으로 응답받음\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Received response (auto-read:false) : RESPONSE(decodeResult: success, version: HTTP/1.1)\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [response_received])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] [terminated=false, cancelled=false, pending=0, error=null]: subscribing inbound receiver\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] Channel closed, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[Connection Closed] : GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090]}}\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] INACTIVE\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090]}}, [response_incomplete])\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] UNREGISTERED\nServlet.service() for servlet [dispatcherServlet] in context with path [] threw exception \n[Request processing failed: org.springframework.web.reactive.function.client.WebClientResponseException: 200 OK from GET http://localhost:9090/force/abort-connection, \nbut response failed with cause: reactor.netty.http.client.PrematureCloseException: Connection prematurely closed DURING response] with root cause</code>\n        </deckgo-highlight-code>\n</details>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ff6649ca3efa0906969b2bcf54dd3e52/d9ed5/duringResponse.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.44444444444445%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABZklEQVR42h2Q2Y7TQBBF/feDeOCBRTzAMNIgFAmJJcRx7MRxvLsd2x07jj1LMgogtr841PTD0a1WVd2+3VZaN3hxQlLXBj0MBIVCjyPbbk8puNK3g5BFFOPnGas8ZV3kLNMEX9QTLdqWuu+x0qrB2UREZWXQhwE/zdG9GLZ7lO6YS3+6WjMX05m/McaPIZwwlMti0Yi4qskajbXdHVlFDaq5o9T3jLe/SdTBaDf8YNef8WONu9maOXdTmdpPNF64NbWzVtTtifvTP6w4vcH2KsJ4IEpGqurMKuio6u+o8oFcHXGWDVNHYbsVs8WWz7PM1N/miqmt+GLnsj9Sy451NT3zctLz5tNJeODa/sPrj7dG39u/ePf1J68mA8+udzK35/mHjou3NU+vOp5c7ri41IYXkzvZ+SsJE/n0ZUkYtQalblgHjdE8H8iyA95KnuUpFjL3iL3IWcjZ8QpJmjN3C/xAS8Ij/wELcYjpVb2JLQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"duringResponse\"\n        title=\"\"\n        src=\"/static/ff6649ca3efa0906969b2bcf54dd3e52/1cfc2/duringResponse.png\"\n        srcset=\"/static/ff6649ca3efa0906969b2bcf54dd3e52/3684f/duringResponse.png 225w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/fc2a6/duringResponse.png 450w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/1cfc2/duringResponse.png 900w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/21482/duringResponse.png 1350w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/d61c2/duringResponse.png 1800w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/d9ed5/duringResponse.png 2880w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"커널-tcp-소켓-상태에-따른-처리\" style=\"position:relative;\">커널 TCP 소켓 상태에 따른 처리<a href=\"#%EC%BB%A4%EB%84%90-tcp-%EC%86%8C%EC%BC%93-%EC%83%81%ED%83%9C%EC%97%90-%EB%94%B0%EB%A5%B8-%EC%B2%98%EB%A6%AC\" aria-label=\"커널 tcp 소켓 상태에 따른 처리 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>이때까지 정상적인 종료인 FIN 패킷만 보았는데, 4-way handshake 중에 해당 커넥션으로 데이터를 재전송하게 되면 RST 패킷을 전송하게 되는 경우도 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fcb9f339dfde65490a7ecb3b01faf28a/9a1cf/4way-handshake.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB2klEQVR42m1Sa3ObMBDk//+zfmrS5otjM1OIjYTAoPcTRNdo4glNd2yNpNPe7t1Rrevq7ajlTUyt4o2cG6evwasNyOuWc15z0JoTwpqGU4pV9cxrnbetWpY1eKbFhXWvd/ZGrj+DrWMQ287Gf1nXqLUmHT1f+PXW17WmNBqDtJUxVvBxGq987tRMghq8pEv023BfT3V+rzfKYgiQitbKaXJaO6Wi98hbzfPcM0YI7dmAJI5LL1RUJkm1GRO56P989FcSHker71OCVYg+bOVqX3d7y+L3fAj7GKz3xpqBq9dz87v+0D4gZK1Fj7ZPVPkTuI0xbkes64LLFGHZonDG2LhjmibOefXl3ZOcY0qTUOMsQlqeoRBC4aBSrEqpA7nYBlxMNRl/Xdq70CmGlFJxCz5ocCGlfNj+TsZTbPphxM+h1Jwh65wrziml0O/7Hu8rQsjtdmvbFmcEjDEpRW1sTe4v55ZOwhjtvEfGhyPnDg3DAQE0DGowgw2OeCSEVFoXzhMQx1CeA6pAgDKcdF0HZbQBWcoLzBMNCzGVceAGvg7KyA0CUmAVQsQduMTasOnH23s78K/KB/JzBzXEiqVSi7Z2FlIoFXb8R/n7F/YPSjuA0mrUeDqdyqj+Aia9YZP7zMFVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4way handshake\"\n        title=\"\"\n        src=\"/static/fcb9f339dfde65490a7ecb3b01faf28a/1cfc2/4way-handshake.png\"\n        srcset=\"/static/fcb9f339dfde65490a7ecb3b01faf28a/3684f/4way-handshake.png 225w,\n/static/fcb9f339dfde65490a7ecb3b01faf28a/fc2a6/4way-handshake.png 450w,\n/static/fcb9f339dfde65490a7ecb3b01faf28a/1cfc2/4way-handshake.png 900w,\n/static/fcb9f339dfde65490a7ecb3b01faf28a/9a1cf/4way-handshake.png 924w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>Active Closer의 정상적인 상태 진행</strong> ESTABLISHED → FIN_WAIT1 → FIN_WAIT2 → TIME_WAIT → CLOSE</p>\n<ol>\n<li><code class=\"language-text\">FIN-WAIT-1</code>: 원격 TCP 피어의 연결 종료 요청을 기다리거나, 자신이 보낸 종료 요청에 대한 승인을 기다리는 상태</li>\n<li><code class=\"language-text\">CLOSE-WAIT</code>: 응용프로그램이 더 이상 데이터 송수신이 필요 없다고 close() 또는 연결 종료(종료 관련 API 호출 등)를 실행할 때까지 기다리는 상태를 의미 (연결 종료 요청을 기다리는 상태)</li>\n<li><code class=\"language-text\">FIN-WAIT-2</code>: 원격 TCP 피어의 연결 종료 요청을 기다리는 상태</li>\n<li><code class=\"language-text\">LAST-ACK</code>: 원격 TCP 피어에게 보낸 종료 요청에 대한 승인을 기다리는 상태</li>\n<li><code class=\"language-text\">TIME-WAIT</code>: 상대방이 종료 요청에 대한 승인을 수신했음을 확실히 하고, <strong>이전 연결에서 지연된 세그먼트가 새 연결에 영향을 주지 않도록 일정 시간 대기하는 상태</strong></li>\n<li><code class=\"language-text\">CLOSED</code>: 연결이 완전히 없는 상태</li>\n</ol>\n<p><a href=\"https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_ipv4.c#L1905\">tcp_ipv4.c <code class=\"language-text\">tcp_v4_do_rcv(...)</code></a>함수를 보면 소켓이 <code class=\"language-text\">TCP_ESTABLISHED</code> 상태가 아닌 경우 <code class=\"language-text\">tcp_rcv_state_process(...)</code>를 통해 처리한다.</p>\n<deckgo-highlight-code language=\"c\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">int tcp_v4_do_rcv(struct sock *sk, struct sk_buff *skb)\n{\n    enum skb_drop_reason reason;\n    struct sock *rsk;\n\n    // 1. 수신된 데이터를 사용자 영역에 전달할 수 있는 상태인 경우\n    if (sk-&gt;sk_state == TCP_ESTABLISHED) { /* Fast path */\n        // ...\n        tcp_rcv_established(sk, skb);\n        return 0;\n    }\n\n    // 2. 연결 요청을 기다리는 상태인 경우\n    if (sk-&gt;sk_state == TCP_LISTEN) {\n        // ...\n    } else\n        sock_rps_save_rxhash(sk, skb);\n\n    // 3. 그 외의 상태인 경우\n    reason = tcp_rcv_state_process(sk, skb);\n    if (reason) {\n        rsk = sk;\n        goto reset;\n    }\n    return 0;\n\n// RST 패킷 전송\nreset:\n    tcp_v4_send_reset(rsk, skb, sk_rst_convert_drop_reason(reason));\n\ntcp_rcv_state_process(struct sock *sk, struct sk_buff *skb)\n{\n    ... (중략) ...\n    switch (sk-&gt;sk_state) {\n    case TCP_CLOSE:\n        ... (중략) ...\n\n    case TCP_LISTEN:\n        if (th-&gt;ack)\n            return 1;\n\n        if (th-&gt;rst) {\n            ... (중략) ...\n        }\n        if (th-&gt;syn) {\n            ... (중략) ...\n        }\n        goto discard;\n\n    case TCP_SYN_SENT:\n        ... (중략) ...\n        return 0;\n    }\n    ... (중략) ...\n\n    switch (sk-&gt;sk_state) {\n    case TCP_SYN_RECV:\n        ... (중략) ...\n    case TCP_FIN_WAIT1:\n    case TCP_FIN_WAIT2:\n        if (sk-&gt;sk_shutdown &amp; RCV_SHUTDOWN) {\n            // 서버가 close()를 호출했으므로 RCV_SHUTDOWN이 설정됨\n            if (TCP_SKB_CB(skb)-&gt;end_seq != TCP_SKB_CB(skb)-&gt;seq &amp;&amp;\n                after(TCP_SKB_CB(skb)-&gt;end_seq - th-&gt;fin, tp-&gt;rcv_nxt)) {\n                // 데이터가 포함된 패킷이면\n                NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPABORTONDATA);\n                tcp_reset(sk, skb);  // ← RST 전송!\n                return SKB_DROP_REASON_TCP_ABORT_ON_DATA;\n            }\n        }\n        ... (중략) ...\n    case TCP_CLOSING:\n        ... (중략) ...\n    case TCP_LAST_ACK:\n        ... (중략) ...\n    }\n}</code>\n        </deckgo-highlight-code>\n<ol>\n<li>TCP_FIN_WAIT1, TCP_FIN_WAIT2 상태 : 데이터가 포함되어 있다면 즉시 RST 패킷 전송</li>\n<li>TCP_TIME_WAIT 상태 : RST 패킷 전송 <a href=\"https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_minisocks.c#L99\">tcp_minisocks.c#L99</a>\n<ul>\n<li>TIME_WAIT은 마지막 ACK가 유실될 경우를 대비하여 상대방이 FIN을 재전송하는 경우 대응하기 위한 상태이다.</li>\n</ul>\n</li>\n</ol>\n<h1 id=\"원인\" style=\"position:relative;\">원인<a href=\"#%EC%9B%90%EC%9D%B8\" aria-label=\"원인 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 582px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/426261f739ff0c2e9925d9b256aae296/7c1cd/timeout.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuUlEQVR42oVS227TQBDNtyLxH7zxhPgEitQHnkEUibwAEhIVAdI6obXj2F4bO3jje9L4lvVhdu0mKUJirLPy7OyembMzIwiBjrDnIVr/F/ZrDnRdj1PrhFzwPxuJokBjL1GbBhrHQr0wILJ04KBkRNwdyLuD30MM6PoYfSORZRA2g3B9tMxB49J/EKCj/WNxe4jQQFdtDsR/mxiIR9K5ZBcY6+e4WX3Btf8R+mqCPEmw2RTgSYbEmKA5f4xq/BwJXyHNc/hegDn7hneLM0yDT/gZXioowgvjDK+0Z7hNvoIVN0i3EZjrwqNqb00b1ufXqF4+QvHmKRazH1hYFq6+X+PD9C1eTJ9gEoyxTK+Q7H73hNKqssLSNhGs/F7U8C5KTlPiTnuPmtuD4qPksiwpOVN3D5Kl5STDth3EUXxCeLS9bMI/ulrXFRhzwRz2kLBtWwTUjIK6ntD7xXGskKYpUvJNwwAPQ+WfxrM8A6dR2263/dicZtvtdliv1+qg4zgqQRRFCvLCPVFIxKZpKlUyxjmncRYPCe8lutQMeVjXdQWLGuB5nqpc0zQVk3sy4Xw+V7HZbKbeUhL+AVgX9OGkHTBxAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"timeout\"\n        title=\"\"\n        src=\"/static/426261f739ff0c2e9925d9b256aae296/7c1cd/timeout.png\"\n        srcset=\"/static/426261f739ff0c2e9925d9b256aae296/3684f/timeout.png 225w,\n/static/426261f739ff0c2e9925d9b256aae296/fc2a6/timeout.png 450w,\n/static/426261f739ff0c2e9925d9b256aae296/7c1cd/timeout.png 582w\"\n        sizes=\"(max-width: 582px) 100vw, 582px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>WebClient를 생성할 때 maxIdleTime을 지정해주지 않아 무제한으로 설정되어, B서버의 keep-alive timeout이 초과한 경우 클라이언트가 stale connection을 사용할 경우가 생기기 때문이다.</p>\n<ol>\n<li>클라이언트가 요청 완료 후 커넥션을 풀에 반환 (시각 <code class=\"language-text\">T0</code>)</li>\n<li>서버의 keep-alive timeout은 <code class=\"language-text\">20</code>초로 설정됨</li>\n<li>클라이언트 maxIdleTime은 무제한</li>\n<li><code class=\"language-text\">T0 + 20</code>초에 클라이언트가 해당 커넥션을 다시 사용하려고 시도</li>\n<li>서버는 이미 커넥션을 닫았거나 닫는 과정에 있거나 클라이언트가 응답을 완전하게 받지 못한 경우</li>\n<li><strong>PrematureCloseException 발생</strong></li>\n</ol>\n<p>서버가 커넥션을 닫기 전에 클라이언트가 proactive하게 커넥션을 정리해서 race condition을 방지할 수 있기에 maxIdleTime을 서버의 keep-alive timeout보다 작게 지정해주는 것이 좋다.</p>\n<h1 id=\"정리-필요\" style=\"position:relative;\">정리 필요<a href=\"#%EC%A0%95%EB%A6%AC-%ED%95%84%EC%9A%94\" aria-label=\"정리 필요 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<ol>\n<li>maxIdleTime을 지정해줘서 해결될 거라고 판단</li>\n<li>하지만 커넥션 풀 고갈 문제 발생 (커넥션을 할당받기 위해 대기하다가 예외 발생. 이 예외로 인해 일반 Job 코루틴 스코프가 멈춤)</li>\n</ol>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">Exception in thread &quot;DefaultDispatcher-worker-5&quot; Exception in thread &quot;DefaultDispatcher-worker-1&quot; Exception in thread &quot;DefaultDispatcher-worker-7&quot; Exception in thread &quot;DefaultDispatcher-worker-10&quot; Exception in thread &quot;DefaultDispatcher-worker-3&quot; org.springframework.web.reactive.function.client.WebClientRequestException: Pending acquire queue has reached its maximum size of 32</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">// 기본값\nConnectionProvider.create()  // 기본 설정 사용 시\n    .maxIdleTime(-1)         // 무제한 ⚠️\n    .maxLifeTime(-1)         // 무제한 ⚠️  \n    .evictInBackground(0)    // 비활성 ⚠️\n    .maxConnections(500)     // 제한 있음\n    .pendingAcquireMaxCount(32)  // 제한 있음</code>\n        </deckgo-highlight-code>\n<ul>\n<li>커넥션 풀의 맥스 커넥션 수만큼 Flow로 배압조절한다면 커넥션 고갈 문제는 없지 않을까? 근데 버퍼가 어느정도 감당가능한지?</li>\n<li>커넥션을 먼저 끊는 Active Closer는 TIME_WAIT 소켓을 보유하게 되는 것을 이해했다</li>\n</ul>\n<blockquote>\n<p>참고</p>\n<ol>\n<li><a href=\"https://brewagebear.github.io/linux-kernel-internal-3/\">[Kernel] 커널과 함께 알아보는 소켓과 TCP Deep Dive</a></li>\n<li><a href=\"https://blog.cjlee.io/post/webclient-timeout/\">헷갈리는 WebClient Timeout</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc9293#name-state-machine-overview\">RFC9293: Transmission Control Protocol (TCP) State Matchine Overview</a></li>\n<li><a href=\"https://projectreactor.io/docs/netty/release/reference/faq.html#faq.connection-closed\">How can I debug \"Connection prematurely closed BEFORE response\"?</a></li>\n<li><a href=\"https://www.baeldung.com/spring-webflux-concurrency\">Concurrency in Spring WebFlux</a></li>\n<li><a href=\"https://www.cs.unh.edu/cnrg/people/gherrin/linux-net.html\">Linux IP Networking: A Guide to the Implementation and Modification of the Linux Protocol Stack</a></li>\n</ol>\n</blockquote>","frontmatter":{"title":"WebClient PrematureCloseException 원인 분석하기","date":"2025-09-22","update":"2025-09-22","description":null,"tags":["deep-dive","network","nio","postmortem"]},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EA%B2%AC\">문제 발견</a></p>\n</li>\n<li>\n<p><a href=\"#webclient-connection-%EC%83%81%ED%83%9C-%EB%B3%80%ED%99%94\">WebClient Connection 상태 변화</a></p>\n</li>\n<li>\n<p><a href=\"#prematurecloseexception%EC%9D%B4-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EC%BC%80%EC%9D%B4%EC%8A%A4\">PrematureCloseException이 발생하는 케이스</a></p>\n<ul>\n<li><a href=\"#1-while-sending-request-body\">1. while sending request body</a></li>\n<li><a href=\"#2-before-response\">2. BEFORE response</a></li>\n<li><a href=\"#3-during-response\">3. DURING response</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%BB%A4%EB%84%90-tcp-%EC%86%8C%EC%BC%93-%EC%83%81%ED%83%9C%EC%97%90-%EB%94%B0%EB%A5%B8-%EC%B2%98%EB%A6%AC\">커널 TCP 소켓 상태에 따른 처리</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%9B%90%EC%9D%B8\">원인</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%A0%95%EB%A6%AC-%ED%95%84%EC%9A%94\">정리 필요</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2025y/coroutinescope/"},"frontmatter":{"title":"API가 왜 멈췄을까? 코루틴 이해하기"}},"next":null},"pageContext":{"id":"e0b1b946-ea07-5d47-9d52-4627d912ebd9","previousPostId":"44185076-e856-5646-974d-b8c8a058bc63","nextPostId":null}},"staticQueryHashes":["230163734","3589320610"],"slicesMap":{}}