{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025y/webclient/","result":{"data":{"site":{"siteMetadata":{"title":"코딩 주머니"}},"markdownRemark":{"id":"e0b1b946-ea07-5d47-9d52-4627d912ebd9","excerpt":"문제 발견 모니터링을 통해 12주 간격으로 한 번씩  예외가 발생하는 것을 확인했다. 외부 서비스로 초당 30040…","html":"<h1 id=\"문제-발견\" style=\"position:relative;\">문제 발견<a href=\"#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EA%B2%AC\" aria-label=\"문제 발견 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>모니터링을 통해 1<del>2주 간격으로 한 번씩 <code class=\"language-text\">PrematureCloseException</code> 예외가 발생하는 것을 확인했다. 외부 서비스로 초당 300</del>400회 요청을 보내고, 응답을 기다리지 않는 비동기 방식으로 처리하는 중 부하가 몰릴 때 발생하는 것을 추가로 확인할 수 있었다.</p>\n<p>예외의 원인을 확실하게 이해하기 위해 WebClient의 커넥션 풀이 어떻게 관리되는지 정상적인 케이스를 먼저 확인해보자.</p>\n<h1 id=\"webclient-connection-상태-변화\" style=\"position:relative;\">WebClient Connection 상태 변화<a href=\"#webclient-connection-%EC%83%81%ED%83%9C-%EB%B3%80%ED%99%94\" aria-label=\"webclient connection 상태 변화 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0f2eb4eb48b8b415d28cbf06c49185ad/2d3cc/network-sequence.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 108.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAAAsTAAALEwEAmpwYAAADmklEQVR42n1Va3PdNBDN//8RfOALHQqddtLCDC2FNuRCmlI6+QQ0TW58/X7bkiz5IR+OZS65bVo0c0b2rnS82j1aH4FjECNUrCGIeqfQt+NixjxjnYm0N/CEhNcK7DqNadDQuQ+VBxDJFroI3MojRygnkkk0wQ6Nt0Nfp/RVwFgCU4mhz+FXHrb5e3jlFfzWw6RDqOSC+95CJn9DV4mL4Gj9PsekYNtHgHwCqMf/wapjJNFX8C/voaseYZLHtO39T7jnG1j9J/ZnOTo8WttWkLKB7gQ6dYs8S1EWGZRoUBU5jFbOrrV09nEcsB//Eq6Mdd2SUMOYAcMwESNGzllaIggSCKlQVa3zd50h4YCybEk4fY6wgVKKCzWiKEHgR4ijFEWxRK7QNK3DOI7ohx7WTrRLTNMdwv2RJQl7Eo581g5SGkY0ctMMIbQjWIaVOyriGJn/HZLtQ+IxZjscFGXWGNvnnE6A/heWfsMqb6iAl2iSZyjCH9Ckz1i7F/RvMMvv0edfwmRfQJc/w0ifgU1rhOtgXurfSXABWb5GnZ5BFOdo83Nkwa8oojOUyRnnDW2vUKWvKJ2/YNoLajL7uMprlFkhULcWeTkgyQziVCNONPygJQSipMPWq51/8VHjyAvtcvpBDvcR6uYcXfMavXjjMKi3jOY3RDcvEFz/hGR3wlPs/X9At2/QZKewfXwY4W0OhyWHHXOoT1eYU9pOmL+nyIOnqOMfKeyXB/4NRkGbufmcsDt02q7oeL8JYyakWYUwpLC7HkVJQdOmOuacc140d2WDWTHBHmL/AnnEoojUCXyRiKQuFx2GYUxRN8jzwmlVCMFZ0ld+SOiCm0LU4UMElw+Qbu+hl+8xWZrH0S1ebsJEQ98PUBT4UsTFvswL+SeEvZ65qmqkaeZuSZYWfM4Rx3wPE4ckyZgKjcM9y/v/EAqXR6UM0bnFgtrwd6EjLnn0qqyZ1975tDYuHZ8gXHRkUVcFJDuO7to1f0sz8AMEJAwZ9fXWc8TLx4RY/aXL4aEOJwkR3OedfIB4+zVS7z7Sm2+hVeGqb6c1f8vLxO6jZLe2z8XGoe4e2cLUMUQUoA481P6OjTShom4XuU409kg6iZA9MR8MLN/HltEWIe9yhFGWt0fuG3aX0LDSlMhW8AN3/ykBm+5VmeOauGqpvZ7SiS7RxFeogneQqbf/Baw75+EAdsbHY5gtNGEs5WPt+pnJYB4Nu5J2rWuJ8B+t35bXjKLX7AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"network sequence\"\n        title=\"\"\n        src=\"/static/0f2eb4eb48b8b415d28cbf06c49185ad/1cfc2/network-sequence.png\"\n        srcset=\"/static/0f2eb4eb48b8b415d28cbf06c49185ad/3684f/network-sequence.png 225w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/fc2a6/network-sequence.png 450w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/1cfc2/network-sequence.png 900w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/21482/network-sequence.png 1350w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/d61c2/network-sequence.png 1800w,\n/static/0f2eb4eb48b8b415d28cbf06c49185ad/2d3cc/network-sequence.png 3529w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>8080포트의 서버에서 9090포트의 서버로 요청을 보내고 1초 후에 응답하는 API를 테스트해보았다.<br>\n(keep-alive timeout = 3000ms)</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5ea0ecd5cd827df7dd23f51fa247aae4/0ad08/success_network_log.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAABP0lEQVR42iWP3UvCcBiF+/8v+4IuIkuzkbp0mzO/m/v4mW6OzMwsJCuhAiXSUst6mvbC4XmuDuddIzi/2UbRi5QMgeW4FMo2tvCoWDV0SUY/kNDDx2Qiy8RWfhqwcCRT1/Is7vssngb8zL9YWxbWm5fI2RxFR2C73oqi4SM8n0Q0hrR7QCx0SCIcRY5IxAMuXTuWsTMFZrc95r0+s+my8Bc6vS4VX9C4a9F+7OIH7AzuuB7ccuZaFEQ5oIm4FFRbVawLC+fCxu24dB9ueBt9MB1/BtN+g8LXV/xsFiUaJWcYGOdVchUDs17DrNVQ0ipyUkZRUyhaEk1XV1TTKbL5DFdNn+/3MYsgTCb/L3uNNknFoFT2MM0mxZKH41zh2C3Se3GUzX3U7QjyeojUVpiTjdDK9R2JtmbAyzMMhzAa8Qe64k2+vcc34QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"success network log\"\n        title=\"\"\n        src=\"/static/5ea0ecd5cd827df7dd23f51fa247aae4/1cfc2/success_network_log.png\"\n        srcset=\"/static/5ea0ecd5cd827df7dd23f51fa247aae4/3684f/success_network_log.png 225w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/fc2a6/success_network_log.png 450w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/1cfc2/success_network_log.png 900w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/21482/success_network_log.png 1350w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/d61c2/success_network_log.png 1800w,\n/static/5ea0ecd5cd827df7dd23f51fa247aae4/0ad08/success_network_log.png 2978w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>WebClient를 생성할 때 metrics를 활성화하여 로그를 확인해볼 수 있다.</p>\n<details>\n<summary>💡 WebClient Connection Pool 로그 자세히보기</summary>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">val httpClient = HttpClient.create(connectionProvider)\n    .metrics(true) { uriTagValue -&gt; uriTagValue }\n    .doOnConnected { conn -&gt;\n        conn.channel().closeFuture().addListener {\n            logger.info(&quot;[Connection Closed] : $conn&quot;)\n        }\n        logger.info(&quot;[New Connection] : $conn&quot;)\n    }\n    .doOnConnect { config -&gt;\n        logger.info(&quot;[Connection Attempt] Attempting to connect...&quot;)\n    }\n\nreturn WebClient.builder()\n    .baseUrl(&quot;http://localhost:9090&quot;)\n    .clientConnector(ReactorClientHttpConnector(httpClient))\n    .build()</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">Creating a new [my-provider] client pool [PoolFactory{evictionInterval=PT0S, leasingStrategy=fifo, maxConnections=1, maxIdleTime=-1, maxLifeTime=-1, metricsEnabled=false, pendingAcquireMaxCount=2, pendingAcquireTimeout=45000}] for [localhost/&lt;unresolved&gt;:9090]\n[1965a96f] Created a new pooled channel, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[1965a96f] REGISTERED\n[1965a96f] CONNECT: localhost/127.0.0.1:9090\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Registering pool release on close event for channel\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Channel connected, now: 1 active connections, 0 inactive connections and 0 pending acquire requests.\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] ACTIVE\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}, [connected])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=null, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [configured])\n[New Connection] : GET{uri=null, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Handler is being applied: {uri=http://localhost:9090/internal/delay/1, method=GET}\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [request_prepared])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] WRITE: 102B GET /internal/delay/1 HTTP/1.1\nuser-agent: ReactorNetty/1.1.22\nhost: localhost:9090\naccept: */*\n\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] FLUSH\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] WRITE: 0B\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] FLUSH\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [request_sent])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] READ: 142B HTTP/1.1 200 \nContent-Type: text/plain;charset=UTF-8\nContent-Length: 28\nDate: Tue, 23 Sep 2025 06:09:17 GMT\n\n\ndelay api success. seconds=1\n15:09:17.136+09:00 --- [r-http-kqueue-2] r.n.http.client.HttpClientOperations     : [1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Received response (auto-read:false) : RESPONSE(decodeResult: success, version: HTTP/1.1)\nHTTP/1.1 200 \nContent-Type: &lt;filtered&gt;\nContent-Length: &lt;filtered&gt;\nDate: &lt;filtered&gt;\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [response_received])\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] [terminated=false, cancelled=false, pending=0, error=null]: subscribing inbound receiver\n[1965a96f-1, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Received last HTTP packet\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [response_completed])\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090]}}, [disconnecting])\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Releasing channel\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] Channel cleaned, now: 0 active connections, 1 inactive connections and 0 pending acquire requests.\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] READ COMPLETE\n\n-- 3초 이후 --\n\n[1965a96f, L:/127.0.0.1:59768 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[Connection Closed] : GET{uri=/internal/delay/1, connection=PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090]}}\n[1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090] INACTIVE\n[1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0x1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090]}, [disconnecting])\n[1965a96f, L:/127.0.0.1:59768 ! R:localhost/127.0.0.1:9090] UNREGISTERED</code>\n        </deckgo-highlight-code>\n</details>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 600px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5668a456313ea5b13ed9a1731a3afd3d/0a47e/connection-statediagram.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 280%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAA4CAYAAAD959hAAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFlklEQVR42q1YWXPiZhDk/z/kOQ/JY97zC1KVVGWzW7HXsbEx5r4EAnQiCdBFp/vjCLv4kitUqYTRqtUz09Mz2hqe+ex2O3MejUbYbDao8ql9D7RaRYiiCOtkjdFwDMdxsV6vEYYrZFleDXC73WI+X8KybIwGY9xc3eHhoYXJZIbZbIEgWB0e/G7A1DC0rBl6vZE5+v0x2u0+fD8g0001hpvNFmmanf5W6Hm+DzPLMsRxUh1QN+6Zxgx1anIooDwvqgMqpDRNmasQA4ba7Q7RavUwHk8N0yiKqwGK3SqMkJBJwirrrGrru36vzFCfnNIQsBipOCpSURTImNvda+V9CdBxPNj2ktUd4fr6Dvf3T7Apmel0TuCyGmBZloiZJ2lRUul2Bmg+ttGnfJRXMa0MqHyVvFFV9TzfFEq/qyAfBlT+dLasKVzXMy0Xx7F5SDXAYg+oFuv1huh0B2g9db8pzgfMITbhRYdzHCUmr57rVwc0ssn3slFF5/O5AVWoCruybMRO8pjPHbrLDPW7Bh4fO4e/F3CW3utW8z2g8ue6AQaDCYbDCRqNNjqUjvIpbYbh23m86GVVU5pTEcYjCy6FriKZvL5DOt8AHl1F8tEnCAKkWXaKUteLvKgWsg7lSy7dbHaM66hTlN8kSd7U4gVDhbpYuKZ/zWEvYE1sM1N0rRKg3ProiZKP8qnvkpHMV9d2VaosramSEcXseAFDbnPyTUy4YifQd+nw+NCQ1XQd32ix+dSjdTXN1JOE1CmytvINC3u2ysuFYyTT6fSNBjUCFHYSr6sX5VxnYRiepp65Hn1QNr4fmmM8trBg2ykNMdnFVYWtKkoeo6HFiTcwE+/o3GacRslHOiU/M4vV/xOyejYIIrLsm/miB0ky8shKDAUm6ag72gy3Xm+iQdlIRkqFjkqAy6VzchaxOh4StRxIC9PRON4EVJtpD1RriYUOfT+2mlY9XX+3Y59vWudFEtuE1V9SOsrp8TeF/xzbM4Zy4/8AxXC/fM7RH1i4vW/j+uqWUupTnzM6kmN6/kVA5SnLzwHLfe4o8MWhFQdcT7Tdqq+jgz9eACpDUdBG9/FXjHu/MWfFiaEYaFdU/hSqxC1HkoT0+3PbmAF07L/Ruv0RrfovBEr3gGcLpuoir/R9/zS/jw+8DFmVZHJ3pWZJcapqoQWTYc2mNoacgtLlzde6aUPZmeS1Poasew731V4qvxjIWEOy9Hn2aLxL5s5XXmXCMov4Uka1wnFQeC7KMNgfqxClRyMNfCy7Xfj9ASIuTavhENF0iogLwMq2MW+1sbEslHMbwshnU60dqGWdNtK7W2zv/kHafNwfjXtk93X4Xz5j/fUKebuFjNfz+zvkjw8ou22smw/Ie11kjQcDCr1yCDDnU/PxCAWfUNgzc855LnmsWk9IJ2PzW0o2/ue/EBM86XYwaTbhk2nK2b1hsbZsDOWx9lobnXePx5sn1OCEI7XVGeLTpytcfblBn75pcYaP2UVbOnztVKHvDwGaEZCpQvCZu5hupAqr0n3zljVCiwa85PDyWbCEuX+TobGrXcnwuLSXe4kdzVeDixf380frM0OvPf96y5065Fo367L1mFveGHBXzNmOe0vbr8s+Z7f8M2MThHoXfInhrszQqf+Emz9/QL/xM5KVi9XSpfaSfcgcrdp7Ogy3Xn/EnL0evMZQthS4TQTOA//hE7LthgwXJuRz//xm5L4GePmEAgFzKDeSAyns2cw2Dq4W3LLPQ++VkI/9qVyapJNJSIYrGqu2CoX6x++fTW9PuFUsmQ5fb/5vVfksqUY2cm5JJyRLScWjVyqva9qZR9DEdd8BeNDkhkPKU2UZutg6E8t0ilLhz3S2UVIN72N4xGbopemcHRYE2JItZH0aHQd9VgI8/y8Yl52RZtmFff0LlesAr1g4x00AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"connection statediagram\"\n        title=\"\"\n        src=\"/static/5668a456313ea5b13ed9a1731a3afd3d/0a47e/connection-statediagram.png\"\n        srcset=\"/static/5668a456313ea5b13ed9a1731a3afd3d/3684f/connection-statediagram.png 225w,\n/static/5668a456313ea5b13ed9a1731a3afd3d/fc2a6/connection-statediagram.png 450w,\n/static/5668a456313ea5b13ed9a1731a3afd3d/0a47e/connection-statediagram.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>로그와 다이어그램을 통해 Connection의 상태가 변화되는 주요 단계를 확인할 수 있다.<br>\n이제 PrematureCloseException이 발생하는 원인에 대해 더 자세하게 확인해보자.</p>\n<h1 id=\"prematurecloseexception이-발생하는-케이스\" style=\"position:relative;\">PrematureCloseException이 발생하는 케이스<a href=\"#prematurecloseexception%EC%9D%B4-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EC%BC%80%EC%9D%B4%EC%8A%A4\" aria-label=\"prematurecloseexception이 발생하는 케이스 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><code class=\"language-text\">PrematureCloseException</code>은 HTTP 통신 중 예상하지 못한 시점에 연결이 종료될 때 발생하는 예외다.<br>\n이 예외는 복잡한 네트워크 통신에서 발생하는 다양한 시나리오를 구분하여 더 구체적인 디버깅 정보를 제공한다.</p>\n<p><code class=\"language-text\">HttpClientOperations.onInboundClose()</code>는 원격 서버에서 FIN 패킷을 보내면 수신 서버가 EOF 이벤트를 감지하고 정상적으로 연결을 닫는 경우 호출된다.</p>\n<p><strong>연결 종료 감지 과정</strong></p>\n<ol>\n<li>(테스트 환경이 mac이라서) KQueueEventLoop에서 FIN 패킷을 EV_EOF 이벤트로 감지</li>\n<li>EV_EOF 이벤트로 인해 EOF 처리, Half-closure 설정에 따라 입력만 종료 또는 전체 종료 결정</li>\n<li>Channel inputShutdown 플래그 설정 + 시스템 레벨 소켓 수신 부분 종료</li>\n<li>실제 소켓 fd 닫기 + closeInitiated 플래그 설정</li>\n<li>channelInactive 이벤트가 파이프라인 통해 전파 EventLoop에서 채널 등록 해제</li>\n<li><strong>ChannelHandler.channelInactive() 프로토콜별 정리 작업에서 onInboundClose() 호출</strong> → HTTP 프로토콜 레벨에서 어떤 단계에서 문제가 발생했는지 구분해서 적절한 예외를 발생시킨다.</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e0e7f9a29c48c31fdd0971949c15ba2f/fe7a3/onInboundClose.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABy0lEQVR42m1S7W7bMAz0W2xtYsu2vizHi/xtt07cBh2QAkP/7P3f5XZyAgTY9uNAiiKPPEqRVhq+cihdhaLqYH+0sEUJbUooUyBXBlmmN6SZQn73hciR3CFSiafnBE07IEp4yKWBP3q4soINxMUBh6qGox9IlS4gld3ItSxgpCO5/D+h4EWYxrBIa0ewwDooNpG5vsWMg1UlrCw3K9LHdP8S8qC0RdsMaOsB3jeUfkTGiVKSplIjodQkfWBPwr14ICbHt10CHwhjTpgxqWVhbyx6yg3wJKtJ6nMJtxd/Ib0hvtkyzqC/77DUHaKKsj6THGcWL/aAM/f2QsKRu5ood2B84O562n6zBoO+x9i0pz9yEM+BfvEdIp8bfJHwQ1qcmHDmxTuJ30l6IfnK5EUbLMbgdPdP1uCVeNMaPyn/lTVTkuGr7REZyp2ExMjH6Jjc8wEGW26de8aC3/GlW5J1/GINFfXK0XeYqaLe9quxexZouhFRwYU2nGzl35sp64UyA2ZKmtg5xGYST8EybyDhGEB/pLqaOQGHWODS8VEuHPUqMlx0ias94rM44kpcSLKycOUnXrmONTSlXXJFSCxSbvbM88rmc5LidzfiD2XNJlv0V0AGAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"onInboundClose\"\n        title=\"\"\n        src=\"/static/e0e7f9a29c48c31fdd0971949c15ba2f/1cfc2/onInboundClose.png\"\n        srcset=\"/static/e0e7f9a29c48c31fdd0971949c15ba2f/3684f/onInboundClose.png 225w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/fc2a6/onInboundClose.png 450w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/1cfc2/onInboundClose.png 900w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/21482/onInboundClose.png 1350w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/d61c2/onInboundClose.png 1800w,\n/static/e0e7f9a29c48c31fdd0971949c15ba2f/fe7a3/onInboundClose.png 8106w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<ol>\n<li>요청 헤더 전송</li>\n<li>요청 바디 전송   ← 여기서 닫히면 <code class=\"language-text\">\"while sending request body\"</code> <strong>아직 요청도 완전히 못 보낸 상태</strong></li>\n<li>요청 완료</li>\n<li>서버 처리 중     ← 여기서 닫히면 <code class=\"language-text\">\"BEFORE response\"</code> <strong>요청은 보냈지만 응답을 아직 못 받은 상태</strong></li>\n<li>응답 헤더 수신</li>\n<li>응답 바디 수신   ← 여기서 닫히면 <code class=\"language-text\">\"DURING response\"</code> <strong>응답을 받기 시작했지만 응답이 완전히 안 온 상태</strong></li>\n<li>응답 완료</li>\n</ol>\n</blockquote>\n<h2 id=\"1-before-response-while-sending-request-body\" style=\"position:relative;\">1. BEFORE response while sending request body<a href=\"#1-before-response-while-sending-request-body\" aria-label=\"1 before response while sending request body permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>송신 서버의 요청을 수신 서버가 수신 중에 (바디를 완전히 받기 전에) 연결을 종료하는 경우에 발생한다.<br>\n<strong>테스트 시나리오</strong>: 스트리밍 바디를 전송하는 중에 서버가 두 번째 청크를 받으면 즉시 연결을 종료</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">// WebClient Body\nval chunkData = &quot;X&quot;.repeat(4096) // 4KB per chunk\nval streamingBody = Flux.interval(Duration.ofMillis(500))\n    .take(20)  // 20개 청크 = 80KB\n    .map { index -&gt;\n        logger.info(&quot;Preparing to send chunk ${index + 1}/20&quot;)\n        chunkData\n    }\n    .doOnNext {\n        logger.info(&quot;Sending chunk of ${it.length} bytes...&quot;)\n    }\n    .doOnComplete {\n        logger.info(&quot;All chunks sent&quot;)\n    }\n\n// Netty 서버\nfun main() {\n    val parentGroup = NioEventLoopGroup()\n    val workerGroup = NioEventLoopGroup()\n\n    try {\n        ServerBootstrap()\n            .group(parentGroup, workerGroup)\n            .channel(NioServerSocketChannel::class.java)\n            .handler(LoggingHandler(LogLevel.DEBUG))    // 서버 자체 이벤트 로깅 (bind, accept 등)\n            .childHandler(object : ChannelInitializer&lt;SocketChannel&gt;() {\n                override fun initChannel(ch: SocketChannel) {           // ch는 연결된 클라이언트 채널\n                    ch.pipeline().addLast(LoggingHandler(LogLevel.DEBUG))   // 클라이언트 데이터 송수신 체크\n                    ch.pipeline().addLast(RudeServerHandler())\n                }\n            })\n            .bind(9090).sync()\n            .channel()\n            .closeFuture().sync()\n    } finally {\n        parentGroup.shutdownGracefully()\n        workerGroup.shutdownGracefully()\n    }\n}\n\nprivate class RudeServerHandler : ChannelInboundHandlerAdapter() {\n    private val logger = org.slf4j.LoggerFactory.getLogger(&quot;RudeServer&quot;)\n    private var readCount = 0\n    private var totalBytesReceived = 0\n\n    override fun channelActive(ctx: ChannelHandlerContext) {\n        super.channelActive(ctx)\n        logger.info(&quot;Client connected: ${ctx.channel().remoteAddress()}&quot;)\n    }\n\n    override fun channelRead(ctx: ChannelHandlerContext, msg: Any) {\n        val buffer = msg as io.netty.buffer.ByteBuf\n        val readableBytes = buffer.readableBytes()\n        readCount++\n        totalBytesReceived += readableBytes\n        \n        logger.info(&quot;channelRead #$readCount: Received $readableBytes bytes (total: $totalBytesReceived)&quot;)\n        \n        // 첫 번째 read에서 헤더가 포함되어 있을 수 있음\n        // 두 번째 read는 바디 데이터\n        // 두 번째 청크를 받으면 연결 끊기\n        if (readCount &gt;= 2) {\n            logger.info(&quot;Received 2nd chunk, closing connection WITHOUT sending response!&quot;)\n            buffer.release()\n            ctx.close().await()\n        } else {\n            logger.info(&quot;Waiting for more data...&quot;)\n            buffer.release()\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<details>\n<summary>💡 WebClient와 Netty 로그 자세히보기</summary>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">&lt;Spring WebClient 로그&gt;\n\n[reactor-http-kqueue-7] DEBUG r.n.r.PooledConnectionProvider - [c437bfe8] Created a new pooled channel, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8] REGISTERED\n[reactor-http-kqueue-7] DEBUG i.n.r.dns.DnsNameResolverBuilder - resolveCache and TTLs are mutually exclusive. TTLs are ignored.\n[reactor-http-kqueue-7] DEBUG i.n.r.dns.DnsNameResolverBuilder - cnameCache and TTLs are mutually exclusive. TTLs are ignored.\n[reactor-http-kqueue-7] DEBUG i.n.r.dns.DnsNameResolverBuilder - authoritativeDnsServerCache and TTLs are mutually exclusive. TTLs are ignored.\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8] CONNECT: localhost/127.0.0.1:9090\n[reactor-http-kqueue-7] DEBUG r.n.r.DefaultPooledConnectionProvider - [c437bfe8, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] Registering pool release on close event for channel\n[reactor-http-kqueue-7] DEBUG r.n.r.PooledConnectionProvider - [c437bfe8, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] Channel connected, now: 1 active connections, 0 inactive connections and 0 pending acquire requests.\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] ACTIVE\n[reactor-http-kqueue-7] DEBUG r.n.r.DefaultPooledConnectionProvider - [c437bfe8, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0xc437bfe8, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090]}, [connected])\n[reactor-http-kqueue-7] DEBUG r.n.r.DefaultPooledConnectionProvider - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=null, connection=PooledConnection{channel=[id: 0xc437bfe8, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090]}}, [configured])\n[reactor-http-kqueue-7] DEBUG r.n.http.client.HttpClientConnect - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] Handler is being applied: {uri=http://localhost:9090/any-path, method=POST}\n[reactor-http-kqueue-7] DEBUG r.n.r.DefaultPooledConnectionProvider - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] onStateChange(POST{uri=/any-path, connection=PooledConnection{channel=[id: 0xc437bfe8, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090]}}, [request_prepared])\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] WRITE: 155B POST /any-path HTTP/1.1\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] FLUSH\n[parallel-6] INFO  e.s.PrematureCloseExceptionService - Preparing to send chunk 1/20\n[parallel-6] INFO  e.s.PrematureCloseExceptionService - Sending chunk of 4096 bytes...\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] WRITE: 6B 1000\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] WRITE: 4096B XXXX... // send data ...\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] WRITE: 2B \n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] FLUSH\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[reactor-http-kqueue-7] DEBUG r.n.r.PooledConnectionProvider - [c437bfe8-1, L:/127.0.0.1:52226 ! R:localhost/127.0.0.1:9090] Channel closed, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 ! R:localhost/127.0.0.1:9090] INACTIVE\n[reactor-http-kqueue-7] DEBUG r.n.r.DefaultPooledConnectionProvider - [c437bfe8-1, L:/127.0.0.1:52226 ! R:localhost/127.0.0.1:9090] onStateChange(POST{uri=/any-path, connection=PooledConnection{channel=[id: 0xc437bfe8, L:/127.0.0.1:52226 ! R:localhost/127.0.0.1:9090]}}, [response_incomplete])\n[reactor-http-kqueue-7] WARN  r.n.http.client.HttpClientConnect - [c437bfe8-1, L:/127.0.0.1:52226 ! R:localhost/127.0.0.1:9090] The connection observed an error\nreactor.netty.http.client.PrematureCloseException: Connection has been closed BEFORE response, while sending request body\n[reactor-http-kqueue-7] INFO  my-webclient - [c437bfe8-1, L:/127.0.0.1:52226 ! R:localhost/127.0.0.1:9090] UNREGISTERED\n[http-nio-8080-exec-2] ERROR o.a.c.c.C.[.[.[.[dispatcherServlet] - Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: org.springframework.web.reactive.function.client.WebClientRequestException: Connection has been closed BEFORE response, while sending request body] with root cause\nreactor.netty.http.client.PrematureCloseException: Connection has been closed BEFORE response, while sending request body</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">&lt;Netty 서버 로그&gt;\n\n-- 리스너 포트 등록 및 활성화 완료\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xc281fdae] REGISTERED\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xc281fdae] BIND: 0.0.0.0/0.0.0.0:9090\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xc281fdae, L:/[0:0:0:0:0:0:0:0]:9090] ACTIVE\n\n-- 요청 수신\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x5421fff9, L:/[0:0:0:0:0:0:0:0]:9090] READ: [id: 0x57861e0a, L:/127.0.0.1:9090 - R:/127.0.0.1:52226]\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x5421fff9, L:/[0:0:0:0:0:0:0:0]:9090] READ COMPLETE\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 - R:/127.0.0.1:52226] REGISTERED\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 - R:/127.0.0.1:52226] ACTIVE\n[nioEventLoopGroup-3-3] INFO  RudeServer - Client connected: /127.0.0.1:52226\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 - R:/127.0.0.1:52226] READ: 155B\n[nioEventLoopGroup-3-3] INFO  RudeServer - channelRead #1: Received 155 bytes (total: 155)\n[nioEventLoopGroup-3-3] INFO  RudeServer - Waiting for more data...\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 - R:/127.0.0.1:52226] READ COMPLETE\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 - R:/127.0.0.1:52226] READ: 2048B\n[nioEventLoopGroup-3-3] INFO  RudeServer - channelRead #2: Received 2048 bytes (total: 2203)\n[nioEventLoopGroup-3-3] INFO  RudeServer - Received 2nd chunk, closing connection WITHOUT sending response!\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 - R:/127.0.0.1:52226] CLOSE\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 ! R:/127.0.0.1:52226] READ COMPLETE\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 ! R:/127.0.0.1:52226] USER_EVENT: io.netty.channel.socket.ChannelInputShutdownReadComplete@6a0d7782\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 ! R:/127.0.0.1:52226] INACTIVE\n[nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 ! R:/127.0.0.1:52226] UNREGISTERED</code>\n        </deckgo-highlight-code>\n</details>\n<ol>\n<li><code class=\"language-text\">ChannelRegistered</code> : Channel 이 Event Loop에 등록됨</li>\n<li><code class=\"language-text\">ChannelActive</code> : Channel이 활성화됨, 이제 데이터를 주고받을 수 있음</li>\n<li><code class=\"language-text\">Channellnactive</code> : Channel이 원격 피어로 연결되지 않음</li>\n<li><code class=\"language-text\">ChannelUnregistered</code>: Channel이 생성됐지만 Event Loop에 등록되지 않음</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c89228419bd6fa200e076aae3d9f741b/d7ceb/whileSending.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 31.555555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABaklEQVR42i2QS2+bQBSF+f8/oFJXVSNVtgyOU2MMDMObCWADfudhx0m66KqNlEVVZfd1jLq4Oufec+48jrFYHQjzBWWzo2737O+fyatVj+v9iW77iMxr3KggSCtEUiKzSs8u/JYgK/ETRbO5xw9zDJGmjB1HL0R4caIPq7BF0GOslL6sYDxzGH6fYtoOluYTd86N72E6Nteam7MpodI+e4qxuXsjKZ9pd79YHX5zevmg6n7y9PrB4/kvu4f3XpfFkbR6IVJnRPqg8Yno9ky2+KG1E4fTHwqtG8XQRXy9phjMUQOXxgpJv9m0VkRjSsqhj7ya9J7gP86/mAjN3c8jPF2zTwOWI0lypV+4VhWZJ+nyknVRc2w2LJOCY7vlru44VA0qiLVHx+CHZL4kDySLNNN9QKH7S/U+EWEEOnBrHuJfAs9q1HKLEypUs9VfXBGXLRMv1nlJxm7U42gmuBExlnuZhT1GZYeIFf8A6EuHde0hP+QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"whileSending\"\n        title=\"\"\n        src=\"/static/c89228419bd6fa200e076aae3d9f741b/1cfc2/whileSending.png\"\n        srcset=\"/static/c89228419bd6fa200e076aae3d9f741b/3684f/whileSending.png 225w,\n/static/c89228419bd6fa200e076aae3d9f741b/fc2a6/whileSending.png 450w,\n/static/c89228419bd6fa200e076aae3d9f741b/1cfc2/whileSending.png 900w,\n/static/c89228419bd6fa200e076aae3d9f741b/21482/whileSending.png 1350w,\n/static/c89228419bd6fa200e076aae3d9f741b/d7ceb/whileSending.png 1446w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">-- Netty 서버 로그\n18:09:15.348 [nioEventLoopGroup-3-3] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x57861e0a, L:/127.0.0.1:9090 ! R:/127.0.0.1:52226] USER_EVENT: io.netty.channel.socket.ChannelInputShutdownReadComplete@6a0d7782\n\n-- RST 패킷\nUTC Arrival Time: Oct  1, 2025 09:09:15.348334000 UTC\nTransmission Control Protocol, Src Port: 9090, Dst Port: 52226, Seq: 2, Ack: 4260, Len: 0\nFlags: 0x014 (RST, ACK)</code>\n        </deckgo-highlight-code>\n<p>RST 플래그가 전송된 시점이 해당 USER_EVENT가 전송된 이후에 전송된 것을 확인할 수 있다.</p>\n<h2 id=\"2-before-response\" style=\"position:relative;\">2. BEFORE response<a href=\"#2-before-response\" aria-label=\"2 before response permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><code class=\"language-text\">BEFORE response while sending request body</code>와 비슷한 케이스이지만 요청 body가 없는 경우 이 메세지의 예외가 발생한다.<br>\n<strong>테스트 시나리오</strong>: 요청 헤더만 받고 즉시 연결을 종료</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">fun main() {\n    val parentGroup = NioEventLoopGroup()\n    val workerGroup = NioEventLoopGroup()\n\n    try {\n        ServerBootstrap()\n            .group(parentGroup, workerGroup)\n            .channel(NioServerSocketChannel::class.java)\n            .handler(LoggingHandler(LogLevel.DEBUG))    // 서버 자체 이벤트 로깅 (bind, accept 등)\n            .childHandler(object : ChannelInitializer&lt;SocketChannel&gt;() {\n                override fun initChannel(ch: SocketChannel) {           // ch는 연결된 클라이언트 채널\n                    ch.pipeline().addLast(LoggingHandler(LogLevel.DEBUG))   // 클라이언트 데이터 송수신 체크\n                    ch.pipeline().addLast(RudeServerHandler())\n                }\n            })\n            .bind(9090).sync()\n            .channel()\n            .closeFuture().sync()\n    } finally {\n        parentGroup.shutdownGracefully()\n        workerGroup.shutdownGracefully()\n    }\n}\n\nprivate class RudeServerHandler : ChannelInboundHandlerAdapter() {\n    private val logger = org.slf4j.LoggerFactory.getLogger(&quot;RudeServer&quot;)\n\n    override fun channelActive(ctx: ChannelHandlerContext) {\n        super.channelActive(ctx)\n        logger.info(&quot;Client connected: ${ctx.channel().remoteAddress()}&quot;)\n    }\n\n    override fun channelRead(ctx: ChannelHandlerContext, msg: Any) {\n        logger.info(&quot;Received message: $msg&quot;)\n        logger.info(&quot;Closing connection !!!&quot;)\n        ctx.close().await()\n    }\n}</code>\n        </deckgo-highlight-code>\n<details>\n<summary>💡 WebClient와 Netty 로그 자세히보기</summary>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">&lt;Spring WebClient 로그&gt;\n\n[reactor-http-kqueue-4] DEBUG r.n.r.PooledConnectionProvider - [ace71497] Created a new pooled channel, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497] REGISTERED\n[reactor-http-kqueue-4] DEBUG i.n.r.dns.DnsNameResolverBuilder - resolveCache and TTLs are mutually exclusive. TTLs are ignored.\n[reactor-http-kqueue-4] DEBUG i.n.r.dns.DnsNameResolverBuilder - cnameCache and TTLs are mutually exclusive. TTLs are ignored.\n[reactor-http-kqueue-4] DEBUG i.n.r.dns.DnsNameResolverBuilder - authoritativeDnsServerCache and TTLs are mutually exclusive. TTLs are ignored.\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497] CONNECT: localhost/127.0.0.1:9090\n[reactor-http-kqueue-4] DEBUG r.n.r.DefaultPooledConnectionProvider - [ace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] Registering pool release on close event for channel\n[reactor-http-kqueue-4] DEBUG r.n.r.PooledConnectionProvider - [ace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] Channel connected, now: 1 active connections, 0 inactive connections and 0 pending acquire requests.\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] ACTIVE\n[reactor-http-kqueue-4] DEBUG r.n.r.DefaultPooledConnectionProvider - [ace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0xace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090]}, [connected])\n[reactor-http-kqueue-4] DEBUG r.n.r.DefaultPooledConnectionProvider - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=null, connection=PooledConnection{channel=[id: 0xace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090]}}, [configured])\n[reactor-http-kqueue-4] DEBUG r.n.http.client.HttpClientConnect - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] Handler is being applied: {uri=http://localhost:9090/any-path, method=POST}\n[reactor-http-kqueue-4] DEBUG r.n.r.DefaultPooledConnectionProvider - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] onStateChange(POST{uri=/any-path, connection=PooledConnection{channel=[id: 0xace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090]}}, [request_prepared])\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] WRITE: 123B POST /any-path HTTP/1.1\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] FLUSH\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] WRITE: 5B 0\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] FLUSH\n[reactor-http-kqueue-4] DEBUG r.n.r.DefaultPooledConnectionProvider - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] onStateChange(POST{uri=/any-path, connection=PooledConnection{channel=[id: 0xace71497, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090]}}, [request_sent])\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497-1, L:/127.0.0.1:50390 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[reactor-http-kqueue-4] DEBUG r.n.r.PooledConnectionProvider - [ace71497-1, L:/127.0.0.1:50390 ! R:localhost/127.0.0.1:9090] Channel closed, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497-1, L:/127.0.0.1:50390 ! R:localhost/127.0.0.1:9090] INACTIVE\n[reactor-http-kqueue-4] DEBUG r.n.r.DefaultPooledConnectionProvider - [ace71497-1, L:/127.0.0.1:50390 ! R:localhost/127.0.0.1:9090] onStateChange(POST{uri=/any-path, connection=PooledConnection{channel=[id: 0xace71497, L:/127.0.0.1:50390 ! R:localhost/127.0.0.1:9090]}}, [response_incomplete])\n[reactor-http-kqueue-4] WARN  r.n.http.client.HttpClientConnect - [ace71497-1, L:/127.0.0.1:50390 ! R:localhost/127.0.0.1:9090] The connection observed an error\nreactor.netty.http.client.PrematureCloseException: Connection prematurely closed BEFORE response\n[reactor-http-kqueue-4] INFO  my-webclient - [ace71497-1, L:/127.0.0.1:50390 ! R:localhost/127.0.0.1:9090] UNREGISTERED\n[http-nio-8080-exec-6] ERROR o.a.c.c.C.[.[.[.[dispatcherServlet] - Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed: org.springframework.web.reactive.function.client.WebClientRequestException: Connection prematurely closed BEFORE response] with root cause\nreactor.netty.http.client.PrematureCloseException: Connection prematurely closed BEFORE response</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">&lt;Netty 서버 로그&gt;\n\n-- 리스너 포트 등록 및 활성화 완료\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x1828781c] REGISTERED\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x1828781c] BIND: 0.0.0.0/0.0.0.0:9090\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x1828781c, L:/[0:0:0:0:0:0:0:0]:9090] ACTIVE\n\n-- 요청 수신\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x1828781c, L:/[0:0:0:0:0:0:0:0]:9090] READ: [id: 0xb065a578, L:/127.0.0.1:9090 - R:/127.0.0.1:50390]\n[nioEventLoopGroup-2-1] DEBUG i.n.handler.logging.LoggingHandler - [id: 0x1828781c, L:/[0:0:0:0:0:0:0:0]:9090] READ COMPLETE\n[nioEventLoopGroup-3-2] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xb065a578, L:/127.0.0.1:9090 - R:/127.0.0.1:50390] REGISTERED\n[nioEventLoopGroup-3-2] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xb065a578, L:/127.0.0.1:9090 - R:/127.0.0.1:50390] ACTIVE\n[nioEventLoopGroup-3-2] INFO  RudeServer - Client connected: /127.0.0.1:50390\n[nioEventLoopGroup-3-2] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xb065a578, L:/127.0.0.1:9090 - R:/127.0.0.1:50390] READ: 128B\n[nioEventLoopGroup-3-2] INFO  RudeServer - Received message: PooledUnsafeDirectByteBuf(ridx: 0, widx: 128, cap: 2048)\n[nioEventLoopGroup-3-2] INFO  RudeServer - Closing connection !!!\n[nioEventLoopGroup-3-2] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xb065a578, L:/127.0.0.1:9090 - R:/127.0.0.1:50390] CLOSE\n[nioEventLoopGroup-3-2] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xb065a578, L:/127.0.0.1:9090 ! R:/127.0.0.1:50390] READ COMPLETE\n[nioEventLoopGroup-3-2] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xb065a578, L:/127.0.0.1:9090 ! R:/127.0.0.1:50390] INACTIVE\n[nioEventLoopGroup-3-2] DEBUG i.n.handler.logging.LoggingHandler - [id: 0xb065a578, L:/127.0.0.1:9090 ! R:/127.0.0.1:50390] UNREGISTERED</code>\n        </deckgo-highlight-code>\n</details>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f548df5c4bf745e84c88fd244cdd323f/b297c/beforeResponse.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAABn0lEQVR42iWR6Y7aQBCE/f5PkEirTUgWAsthsMEYbPAxNr4Bc0ssLEk2kXK8w5fB+VGqrqlqdbdG+dIboo4shhMHf5HT0Uy8IGUyC/DDrPKe2gMaXb1CUx1WeO4bNHo6Lcn1zoC27BtbHopmWUyFjxtHFNsNpueSb9aEeSZ1iRX4DGRGs220mY3hzZkIFyv0Gfv/a9N3cNOIVPYpmrFg7pUE0ZHd7ie2s2KzfSPLL+yldvyt3D7BmGaM7VxuXkgdV7VuxoymaaVn3hpX7FDGQuDlOVG55vh6ZR4nHK4Xiv2B4/WKXxQYvo8pAuZJLLMps2SBV2SSI5w0xopCYnnN6faKouoCU06fOSVp+oJhJiTxGSH2ZOml8lRNoI0W9PWgQrvnMhiGdFSXbt+reDItZP4FxcmWpPsT5fnKt99/iTZ7br/+cLx956vk7HDCyQrEsuSe9fIV3nIp3w+E8qqwLBGrJclux/ntB8pDrcVTU6XZ0RmN59TqXfSRLaeOK/1Zeu8/NHj89MzDxyb3/LvHOrVGV/60SUvm7mgPJngi5x9pP8eTAzpr6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"beforeResponse\"\n        title=\"\"\n        src=\"/static/f548df5c4bf745e84c88fd244cdd323f/1cfc2/beforeResponse.png\"\n        srcset=\"/static/f548df5c4bf745e84c88fd244cdd323f/3684f/beforeResponse.png 225w,\n/static/f548df5c4bf745e84c88fd244cdd323f/fc2a6/beforeResponse.png 450w,\n/static/f548df5c4bf745e84c88fd244cdd323f/1cfc2/beforeResponse.png 900w,\n/static/f548df5c4bf745e84c88fd244cdd323f/21482/beforeResponse.png 1350w,\n/static/f548df5c4bf745e84c88fd244cdd323f/d61c2/beforeResponse.png 1800w,\n/static/f548df5c4bf745e84c88fd244cdd323f/b297c/beforeResponse.png 2844w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">BEFORE response while sending request body</code> 다른 점은 Netty 서버에서 USER_EVENT가 발생하지 않는 차이점이 있다.</p>\n<h2 id=\"3-during-response\" style=\"position:relative;\">3. DURING response<a href=\"#3-during-response\" aria-label=\"3 during response permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>송신 서버가 수신 서버에게 헤더를 정상적으로 응답받고 바디를 대기하는 도중 커넥션이 송신 서버가 커넥션을 일방적으로 닫는 경우이다.<br>\n즉, 송신 서버가 헤더를 정상적으로 받고 바디를 완전히 받기 위해 대기하는 중에 수신 서버가 일방적으로 커넥션을 종료하는 경우이다.<br>\n<strong>테스트 시나리오</strong>: 응답 헤더와 일부 바디를 전송한 후 연결 종료</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">// 송신 서버의 API\n@GetMapping(&quot;/abort-connection&quot;)\nfun abortConnection(response: HttpServletResponse) {\n    logger.info(&quot;Starting abort connection...&quot;)\n    \n    try {\n        val writer = response.writer\n        \n        // 응답 데이터를 한 번 전송하여 클라이언트가 정상적으로 읽기 시작하도록 유도\n        writer.write(&quot;Starting response...&quot;)\n        writer.flush()\n\n        Thread.sleep(100)\n\n        // 일방적으로 종료! FIN 패킷 전달\n        response.outputStream.close()\n\n        writer.write(&quot;This should not be sent&quot;)\n        \n    } catch (e: IOException) {\n        logger.error(&quot;IOException during abort: ${e.message}&quot;)\n    }\n}</code>\n        </deckgo-highlight-code>\n<details>\n<summary>💡 WebClient Connection Pool 로그 자세히보기</summary>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">Creating a new [my-provider] client pool [PoolFactory{evictionInterval=PT0S, leasingStrategy=fifo, maxConnections=1, maxIdleTime=-1, maxLifeTime=-1, metricsEnabled=false, pendingAcquireMaxCount=2, pendingAcquireTimeout=45000}] for [localhost/&lt;unresolved&gt;:9090]\n[551113d8] Created a new pooled channel, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[551113d8] REGISTERED\n[551113d8] CONNECT: localhost/127.0.0.1:9090\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Registering pool release on close event for channel\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Channel connected, now: 1 active connections, 0 inactive connections and 0 pending acquire requests.\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] ACTIVE\n[551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}, [connected])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=null, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [configured])\n[New Connection] : GET{uri=null, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Handler is being applied: {uri=http://localhost:9090/force/abort-connection, method=GET}\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [request_prepared])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] WRITE: 108B GET /force/abort-connection HTTP/1.1\nuser-agent: ReactorNetty/1.1.22\nhost: localhost:9090\naccept: */*\n\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] FLUSH\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] WRITE: 0B\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] FLUSH\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [request_sent])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] READ: 108B HTTP/1.1 200 \nTransfer-Encoding: chunked\nDate: Sat, 27 Sep 2025 05:28:01 GMT\n14\nStarting response...    // 첫 번째 청킹 데이터 정상적으로 응답받음\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] Received response (auto-read:false) : RESPONSE(decodeResult: success, version: HTTP/1.1)\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090]}}, [response_received])\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] [terminated=false, cancelled=false, pending=0, error=null]: subscribing inbound receiver\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[551113d8-1, L:/127.0.0.1:53169 - R:localhost/127.0.0.1:9090] READ COMPLETE\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] Channel closed, now: 0 active connections, 0 inactive connections and 0 pending acquire requests.\n[Connection Closed] : GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090]}}\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] INACTIVE\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] onStateChange(GET{uri=/force/abort-connection, connection=PooledConnection{channel=[id: 0x551113d8, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090]}}, [response_incomplete])\n[551113d8-1, L:/127.0.0.1:53169 ! R:localhost/127.0.0.1:9090] UNREGISTERED\nServlet.service() for servlet [dispatcherServlet] in context with path [] threw exception \n[Request processing failed: org.springframework.web.reactive.function.client.WebClientResponseException: 200 OK from GET http://localhost:9090/force/abort-connection, \nbut response failed with cause: reactor.netty.http.client.PrematureCloseException: Connection prematurely closed DURING response] with root cause</code>\n        </deckgo-highlight-code>\n</details>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ff6649ca3efa0906969b2bcf54dd3e52/d9ed5/duringResponse.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 32.44444444444445%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABZklEQVR42h2Q2Y7TQBBF/feDeOCBRTzAMNIgFAmJJcRx7MRxvLsd2x07jj1LMgogtr841PTD0a1WVd2+3VZaN3hxQlLXBj0MBIVCjyPbbk8puNK3g5BFFOPnGas8ZV3kLNMEX9QTLdqWuu+x0qrB2UREZWXQhwE/zdG9GLZ7lO6YS3+6WjMX05m/McaPIZwwlMti0Yi4qskajbXdHVlFDaq5o9T3jLe/SdTBaDf8YNef8WONu9maOXdTmdpPNF64NbWzVtTtifvTP6w4vcH2KsJ4IEpGqurMKuio6u+o8oFcHXGWDVNHYbsVs8WWz7PM1N/miqmt+GLnsj9Sy451NT3zctLz5tNJeODa/sPrj7dG39u/ePf1J68mA8+udzK35/mHjou3NU+vOp5c7ri41IYXkzvZ+SsJE/n0ZUkYtQalblgHjdE8H8iyA95KnuUpFjL3iL3IWcjZ8QpJmjN3C/xAS8Ij/wELcYjpVb2JLQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"duringResponse\"\n        title=\"\"\n        src=\"/static/ff6649ca3efa0906969b2bcf54dd3e52/1cfc2/duringResponse.png\"\n        srcset=\"/static/ff6649ca3efa0906969b2bcf54dd3e52/3684f/duringResponse.png 225w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/fc2a6/duringResponse.png 450w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/1cfc2/duringResponse.png 900w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/21482/duringResponse.png 1350w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/d61c2/duringResponse.png 1800w,\n/static/ff6649ca3efa0906969b2bcf54dd3e52/d9ed5/duringResponse.png 2880w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이 세 가지 다른 예외 메시지는 복잡한 네트워크 통신에서 발생하는 예외를 더 자세하게 표현하기 위해 나뉘어진 것을 확인할 수 있다.</p>\n<h1 id=\"커널-tcp-소켓-상태에-따른-처리\" style=\"position:relative;\">커널 TCP 소켓 상태에 따른 처리<a href=\"#%EC%BB%A4%EB%84%90-tcp-%EC%86%8C%EC%BC%93-%EC%83%81%ED%83%9C%EC%97%90-%EB%94%B0%EB%A5%B8-%EC%B2%98%EB%A6%AC\" aria-label=\"커널 tcp 소켓 상태에 따른 처리 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>4-way handshake 단계를 진행 중인 커넥션을 사용하여 요청을 보내면 어떻게 되는지 확인해보자.<br>\n실제로는 굉장히 짧은 시간에 이루어지기 때문에 재현하기 힘들어 TCP 커널 코드를 확인해보면서 유추해보자.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fcb9f339dfde65490a7ecb3b01faf28a/9a1cf/4way-handshake.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAIAAABr+ngCAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB2klEQVR42m1Sa3ObMBDk//+zfmrS5otjM1OIjYTAoPcTRNdo4glNd2yNpNPe7t1Rrevq7ajlTUyt4o2cG6evwasNyOuWc15z0JoTwpqGU4pV9cxrnbetWpY1eKbFhXWvd/ZGrj+DrWMQ287Gf1nXqLUmHT1f+PXW17WmNBqDtJUxVvBxGq987tRMghq8pEv023BfT3V+rzfKYgiQitbKaXJaO6Wi98hbzfPcM0YI7dmAJI5LL1RUJkm1GRO56P989FcSHker71OCVYg+bOVqX3d7y+L3fAj7GKz3xpqBq9dz87v+0D4gZK1Fj7ZPVPkTuI0xbkes64LLFGHZonDG2LhjmibOefXl3ZOcY0qTUOMsQlqeoRBC4aBSrEqpA7nYBlxMNRl/Xdq70CmGlFJxCz5ocCGlfNj+TsZTbPphxM+h1Jwh65wrziml0O/7Hu8rQsjtdmvbFmcEjDEpRW1sTe4v55ZOwhjtvEfGhyPnDg3DAQE0DGowgw2OeCSEVFoXzhMQx1CeA6pAgDKcdF0HZbQBWcoLzBMNCzGVceAGvg7KyA0CUmAVQsQduMTasOnH23s78K/KB/JzBzXEiqVSi7Z2FlIoFXb8R/n7F/YPSjuA0mrUeDqdyqj+Aia9YZP7zMFVAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"4way handshake\"\n        title=\"\"\n        src=\"/static/fcb9f339dfde65490a7ecb3b01faf28a/1cfc2/4way-handshake.png\"\n        srcset=\"/static/fcb9f339dfde65490a7ecb3b01faf28a/3684f/4way-handshake.png 225w,\n/static/fcb9f339dfde65490a7ecb3b01faf28a/fc2a6/4way-handshake.png 450w,\n/static/fcb9f339dfde65490a7ecb3b01faf28a/1cfc2/4way-handshake.png 900w,\n/static/fcb9f339dfde65490a7ecb3b01faf28a/9a1cf/4way-handshake.png 924w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><strong>Active Closer의 정상적인 상태 진행</strong> ESTABLISHED → FIN_WAIT1 → FIN_WAIT2 → TIME_WAIT → CLOSE</p>\n<h2 id=\"커널-레벨-처리-로직\" style=\"position:relative;\">커널 레벨 처리 로직<a href=\"#%EC%BB%A4%EB%84%90-%EB%A0%88%EB%B2%A8-%EC%B2%98%EB%A6%AC-%EB%A1%9C%EC%A7%81\" aria-label=\"커널 레벨 처리 로직 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><a href=\"https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_ipv4.c#L1905\">tcp_ipv4.c <code class=\"language-text\">tcp_v4_do_rcv(...)</code></a> 함수를 보면 소켓 상태에 따른 처리 방식을 확인할 수 있다.</p>\n<p><strong>주요 TCP 상태 설명</strong></p>\n<ol>\n<li><strong>FIN-WAIT-1</strong>: 자신이 보낸 종료 요청(FIN)에 대한 ACK을 기다리거나, 상대방의 FIN을 기다리는 상태</li>\n<li><strong>CLOSE-WAIT</strong>: 상대방으로부터 FIN을 받고 ACK를 보낸 후, 애플리케이션이 close()를 호출할 때까지 기다리는 상태</li>\n<li><strong>FIN-WAIT-2</strong>: 상대방의 FIN을 기다리는 상태 (자신의 FIN에 대한 ACK는 이미 받음)</li>\n<li><strong>LAST-ACK</strong>: 자신이 보낸 FIN에 대한 ACK를 기다리는 상태</li>\n<li><strong>TIME-WAIT</strong>: 상대방이 마지막 ACK를 확실히 받았음을 보장하고, 이전 연결의 지연된 패킷이 새 연결에 영향을 주지 않도록 일정 시간 대기하는 상태 (보통 2*MSL)</li>\n<li><strong>CLOSED</strong>: 연결이 완전히 종료된 상태</li>\n</ol>\n<deckgo-highlight-code language=\"c\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">int tcp_v4_do_rcv(struct sock *sk, struct sk_buff *skb)\n{\n    // 1. 수신된 데이터를 사용자 영역에 전달할 수 있는 상태인 경우\n    if (sk-&gt;sk_state == TCP_ESTABLISHED) { /* Fast path */\n        // ...\n        tcp_rcv_established(sk, skb);\n        return 0;\n    }\n\n    // 2. 연결 요청을 기다리는 상태인 경우\n    if (sk-&gt;sk_state == TCP_LISTEN) {\n        // ...\n    } else\n        sock_rps_save_rxhash(sk, skb);\n\n    // 3. 그 외의 상태인 경우\n    reason = tcp_rcv_state_process(sk, skb);\n    if (reason) {\n        rsk = sk;\n        goto reset;\n    }\n    return 0;\n\n// RST 패킷 전송\nreset:\n    tcp_v4_send_reset(rsk, skb, sk_rst_convert_drop_reason(reason));\n\ntcp_rcv_state_process(struct sock *sk, struct sk_buff *skb)\n{\n    ... (중략) ...\n    switch (sk-&gt;sk_state) {\n    case TCP_CLOSE:\n        ... (중략) ...\n\n    case TCP_LISTEN:\n        if (th-&gt;ack)\n            return 1;\n\n        if (th-&gt;rst) {\n            ... (중략) ...\n        }\n        if (th-&gt;syn) {\n            ... (중략) ...\n        }\n        goto discard;\n\n    case TCP_SYN_SENT:\n        ... (중략) ...\n        return 0;\n    }\n    ... (중략) ...\n\n    switch (sk-&gt;sk_state) {\n    case TCP_SYN_RECV:\n        ... (중략) ...\n    case TCP_FIN_WAIT1:\n    case TCP_FIN_WAIT2:\n        if (sk-&gt;sk_shutdown &amp; RCV_SHUTDOWN) {\n            // 서버가 close()를 호출했으므로 RCV_SHUTDOWN이 설정됨\n            if (TCP_SKB_CB(skb)-&gt;end_seq != TCP_SKB_CB(skb)-&gt;seq &amp;&amp;\n                after(TCP_SKB_CB(skb)-&gt;end_seq - th-&gt;fin, tp-&gt;rcv_nxt)) {\n                // 데이터가 포함된 패킷이면\n                NET_INC_STATS(sock_net(sk), LINUX_MIB_TCPABORTONDATA);\n                tcp_reset(sk, skb);  // ← RST 전송!\n                return SKB_DROP_REASON_TCP_ABORT_ON_DATA;\n            }\n        }\n        ... (중략) ...\n    case TCP_CLOSING:\n        ... (중략) ...\n    case TCP_LAST_ACK:\n        ... (중략) ...\n    }\n}</code>\n        </deckgo-highlight-code>\n<ol>\n<li><strong>TCP_FIN_WAIT1, TCP_FIN_WAIT2 상태</strong> : 데이터가 포함되어 있다면 즉시 RST 패킷 전송</li>\n<li><strong>TCP_TIME_WAIT 상태</strong> : RST 패킷 전송 <a href=\"https://github.com/torvalds/linux/blob/master/net/ipv4/tcp_minisocks.c#L99\">tcp_minisocks.c#L99</a>\n<ul>\n<li>TIME_WAIT은 마지막 ACK가 유실될 경우를 대비하여 상대방이 FIN을 재전송하는 경우 대응하기 위한 상태이다.</li>\n</ul>\n</li>\n</ol>\n<p>이는 종료 절차가 진행 중인 연결에 새로운 데이터가 오는 것을 비정상적인 상황으로 간주하여 강제로 연결을 리셋하기 때문이다.</p>\n<h1 id=\"원인-분석\" style=\"position:relative;\">원인 분석<a href=\"#%EC%9B%90%EC%9D%B8-%EB%B6%84%EC%84%9D\" aria-label=\"원인 분석 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h2 id=\"로드밸런서와-서버간-timeout이-다른-경우\" style=\"position:relative;\">로드밸런서와 서버간 timeout이 다른 경우<a href=\"#%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%84%9C%EC%99%80-%EC%84%9C%EB%B2%84%EA%B0%84-timeout%EC%9D%B4-%EB%8B%A4%EB%A5%B8-%EA%B2%BD%EC%9A%B0\" aria-label=\"로드밸런서와 서버간 timeout이 다른 경우 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h2 id=\"retry-로직-추가\" style=\"position:relative;\">retry 로직 추가<a href=\"#retry-%EB%A1%9C%EC%A7%81-%EC%B6%94%EA%B0%80\" aria-label=\"retry 로직 추가 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<h2 id=\"webclient-maxidletime-설정-부재\" style=\"position:relative;\">WebClient maxIdleTime 설정 부재<a href=\"#webclient-maxidletime-%EC%84%A4%EC%A0%95-%EB%B6%80%EC%9E%AC\" aria-label=\"webclient maxidletime 설정 부재 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 582px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/426261f739ff0c2e9925d9b256aae296/7c1cd/timeout.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 48.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAABuUlEQVR42oVS227TQBDNtyLxH7zxhPgEitQHnkEUibwAEhIVAdI6obXj2F4bO3jje9L4lvVhdu0mKUJirLPy7OyembMzIwiBjrDnIVr/F/ZrDnRdj1PrhFzwPxuJokBjL1GbBhrHQr0wILJ04KBkRNwdyLuD30MM6PoYfSORZRA2g3B9tMxB49J/EKCj/WNxe4jQQFdtDsR/mxiIR9K5ZBcY6+e4WX3Btf8R+mqCPEmw2RTgSYbEmKA5f4xq/BwJXyHNc/hegDn7hneLM0yDT/gZXioowgvjDK+0Z7hNvoIVN0i3EZjrwqNqb00b1ufXqF4+QvHmKRazH1hYFq6+X+PD9C1eTJ9gEoyxTK+Q7H73hNKqssLSNhGs/F7U8C5KTlPiTnuPmtuD4qPksiwpOVN3D5Kl5STDth3EUXxCeLS9bMI/ulrXFRhzwRz2kLBtWwTUjIK6ntD7xXGskKYpUvJNwwAPQ+WfxrM8A6dR2263/dicZtvtdliv1+qg4zgqQRRFCvLCPVFIxKZpKlUyxjmncRYPCe8lutQMeVjXdQWLGuB5nqpc0zQVk3sy4Xw+V7HZbKbeUhL+AVgX9OGkHTBxAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"timeout\"\n        title=\"\"\n        src=\"/static/426261f739ff0c2e9925d9b256aae296/7c1cd/timeout.png\"\n        srcset=\"/static/426261f739ff0c2e9925d9b256aae296/3684f/timeout.png 225w,\n/static/426261f739ff0c2e9925d9b256aae296/fc2a6/timeout.png 450w,\n/static/426261f739ff0c2e9925d9b256aae296/7c1cd/timeout.png 582w\"\n        sizes=\"(max-width: 582px) 100vw, 582px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>WebClient를 생성할 때 maxIdleTime을 지정해주지 않아 무제한으로 설정되어, 클라이언트가 연결을 재사용하려고 할 때 서버가 이미 타임아웃으로 연결을 끊어버리면서 발생하며, 해결을 위해서는 서버의 타임아웃 값을 조정하거나, 클라이언트의 maxIdleTime을 서버의 타임아웃보다 짧게 설정해야 한다.</p>\n<ol>\n<li>클라이언트가 요청 완료 후 커넥션을 풀에 반환 (시각 <code class=\"language-text\">T0</code>)</li>\n<li>서버의 keep-alive timeout은 <code class=\"language-text\">60초</code></li>\n<li>클라이언트 maxIdleTime은 무제한</li>\n<li><code class=\"language-text\">T0 + 60초 이상</code>에 클라이언트가 해당 커넥션을 다시 사용하려고 시도</li>\n<li>서버는 이미 커넥션을 닫았거나 닫는 과정에 있음</li>\n<li><strong>Race Condition 발생</strong>: 클라이언트가 요청을 보내는 시점과 서버의 연결 종료 시점이 겹침</li>\n<li><strong>PrematureCloseException 발생</strong></li>\n</ol>\n<p>서버가 커넥션을 닫기 전에 클라이언트가 proactive하게 커넥션을 정리해서 race condition을 방지할 수 있기에 maxIdleTime을 서버의 keep-alive timeout보다 작게 지정해주는 것이 좋다.</p>\n<h2 id=\"maxidletiem-설정-이후-커넥션-풀-고갈-문제-발생\" style=\"position:relative;\">maxIdleTiem 설정 이후 커넥션 풀 고갈 문제 발생<a href=\"#maxidletiem-%EC%84%A4%EC%A0%95-%EC%9D%B4%ED%9B%84-%EC%BB%A4%EB%84%A5%EC%85%98-%ED%92%80-%EA%B3%A0%EA%B0%88-%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D\" aria-label=\"maxidletiem 설정 이후 커넥션 풀 고갈 문제 발생 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>넥션을 할당받기 위해 대기하다가 예외 발생</p>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">Exception in thread &quot;DefaultDispatcher-worker-5&quot; Exception in thread &quot;DefaultDispatcher-worker-1&quot; Exception in thread &quot;DefaultDispatcher-worker-7&quot; Exception in thread &quot;DefaultDispatcher-worker-10&quot; Exception in thread &quot;DefaultDispatcher-worker-3&quot; org.springframework.web.reactive.function.client.WebClientRequestException: Pending acquire queue has reached its maximum size of 32</code>\n        </deckgo-highlight-code>\n<ul>\n<li>커넥션 풀의 최대 개수만큼 배압 조절</li>\n</ul>\n<blockquote>\n<p>참고</p>\n<ol>\n<li><a href=\"https://brewagebear.github.io/linux-kernel-internal-3/\">[Kernel] 커널과 함께 알아보는 소켓과 TCP Deep Dive</a></li>\n<li><a href=\"https://blog.cjlee.io/post/webclient-timeout/\">헷갈리는 WebClient Timeout</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc9293#name-state-machine-overview\">RFC9293: Transmission Control Protocol (TCP) State Matchine Overview</a></li>\n<li><a href=\"https://projectreactor.io/docs/netty/release/reference/faq.html#faq.connection-closed\">How can I debug \"Connection prematurely closed BEFORE response\"?</a></li>\n<li><a href=\"https://www.baeldung.com/spring-webflux-concurrency\">Concurrency in Spring WebFlux</a></li>\n<li><a href=\"https://www.cs.unh.edu/cnrg/people/gherrin/linux-net.html\">Linux IP Networking: A Guide to the Implementation and Modification of the Linux Protocol Stack</a></li>\n</ol>\n</blockquote>","frontmatter":{"title":"WebClient PrematureCloseException 원인 분석하기","date":"2025-09-22","update":"2025-10-02","description":null,"tags":["deep-dive","network","nio","postmortem"]},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EA%B2%AC\">문제 발견</a></p>\n</li>\n<li>\n<p><a href=\"#webclient-connection-%EC%83%81%ED%83%9C-%EB%B3%80%ED%99%94\">WebClient Connection 상태 변화</a></p>\n</li>\n<li>\n<p><a href=\"#prematurecloseexception%EC%9D%B4-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EC%BC%80%EC%9D%B4%EC%8A%A4\">PrematureCloseException이 발생하는 케이스</a></p>\n<ul>\n<li><a href=\"#1-before-response-while-sending-request-body\">1. BEFORE response while sending request body</a></li>\n<li><a href=\"#2-before-response\">2. BEFORE response</a></li>\n<li><a href=\"#3-during-response\">3. DURING response</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%BB%A4%EB%84%90-tcp-%EC%86%8C%EC%BC%93-%EC%83%81%ED%83%9C%EC%97%90-%EB%94%B0%EB%A5%B8-%EC%B2%98%EB%A6%AC\">커널 TCP 소켓 상태에 따른 처리</a></p>\n<ul>\n<li><a href=\"#%EC%BB%A4%EB%84%90-%EB%A0%88%EB%B2%A8-%EC%B2%98%EB%A6%AC-%EB%A1%9C%EC%A7%81\">커널 레벨 처리 로직</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%9B%90%EC%9D%B8-%EB%B6%84%EC%84%9D\">원인 분석</a></p>\n<ul>\n<li><a href=\"#%EB%A1%9C%EB%93%9C%EB%B0%B8%EB%9F%B0%EC%84%9C%EC%99%80-%EC%84%9C%EB%B2%84%EA%B0%84-timeout%EC%9D%B4-%EB%8B%A4%EB%A5%B8-%EA%B2%BD%EC%9A%B0\">로드밸런서와 서버간 timeout이 다른 경우</a></li>\n<li><a href=\"#retry-%EB%A1%9C%EC%A7%81-%EC%B6%94%EA%B0%80\">retry 로직 추가</a></li>\n<li><a href=\"#webclient-maxidletime-%EC%84%A4%EC%A0%95-%EB%B6%80%EC%9E%AC\">WebClient maxIdleTime 설정 부재</a></li>\n<li><a href=\"#maxidletiem-%EC%84%A4%EC%A0%95-%EC%9D%B4%ED%9B%84-%EC%BB%A4%EB%84%A5%EC%85%98-%ED%92%80-%EA%B3%A0%EA%B0%88-%EB%AC%B8%EC%A0%9C-%EB%B0%9C%EC%83%9D\">maxIdleTiem 설정 이후 커넥션 풀 고갈 문제 발생</a></li>\n</ul>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2025y/coroutinescope/"},"frontmatter":{"title":"API가 왜 멈췄을까? 코루틴 이해하기"}},"next":null},"pageContext":{"id":"e0b1b946-ea07-5d47-9d52-4627d912ebd9","previousPostId":"44185076-e856-5646-974d-b8c8a058bc63","nextPostId":null}},"staticQueryHashes":["230163734","3589320610"],"slicesMap":{}}