{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025y/coroutinescope/","result":{"data":{"site":{"siteMetadata":{"title":"코딩 주머니"}},"markdownRemark":{"id":"44185076-e856-5646-974d-b8c8a058bc63","excerpt":"CS팀에서 특정 기능에 대한 사용자 문의 인입이 증가하고 있다고 백엔드 팀에 문의가 들어왔다. 사용량이 갑자기 늘어나서 병목이 생긴건가? 지연되고 있는 API가 있나? DB에 부하가 발생해서 지연되는 쿼리가 있나? 가용할 수 있는 스레드가 없나? 메모리 또는 CPU…","html":"<p>CS팀에서 특정 기능에 대한 사용자 문의 인입이 증가하고 있다고 백엔드 팀에 문의가 들어왔다.</p>\n<ol>\n<li>사용량이 갑자기 늘어나서 병목이 생긴건가?</li>\n<li>지연되고 있는 API가 있나?</li>\n<li>DB에 부하가 발생해서 지연되는 쿼리가 있나?</li>\n<li>가용할 수 있는 스레드가 없나?</li>\n<li>메모리 또는 CPU로 인해 서버가 다운되었나?</li>\n<li>ECS 태스크가 증설중인가?</li>\n</ol>\n<p>특이사항은 발견하지 못했지만 해당 API의 기능은 계속 먹통이였다.<br>\n애플리케이션 로그를 통해 배포가 완료된 뒤에 정상적으로 호출되다가 런타임 예외가 발생한 시점부터 해당 API가 반응이 없었다.</p>\n<h1 id=\"문제-지점\" style=\"position:relative;\">문제 지점<a href=\"#%EB%AC%B8%EC%A0%9C-%EC%A7%80%EC%A0%90\" aria-label=\"문제 지점 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@RestController\nclass TestController {\n    private val scope = CoroutineScope(Dispatchers.IO)\n    \n    @GetMapping(&quot;/test&quot;)\n    fun test() {\n        scope.launch {\n            // business logic ...\n            throw RuntimeException(&quot;비즈니스 로직 런타임 예외 발생!!!&quot;)\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<p>CoroutineScope를 생성하는 오버헤드를 줄이기 위해 싱글톤 빈 내부에 선언하여 재사용한것으로 보인다.<br>\n<strong>문제는 이 scope 자식 코루틴에서 발생한 예외가 적절히 처리되지 않아 scope의 Job도 <code class=\"language-text\">cancelled</code>로 상태를 전이시키기 때문이다.</strong></p>\n<p>아래의 코드를 통해 코루틴 내부에서 예외를 어떻게 처리하는지, 취소 상태가 되면 왜 코루틴이 실행되지 않는지 알 수 있다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">// 1. BaseContinuationImpl에서 코루틴 블록 내부에서 발생한 런타임 예외를 failure result로 resume 한다.\npublic final override fun resumeWith(result: Result&lt;Any?&gt;) {\n    var current = this\n    var param = result\n    while (true) {\n        probeCoroutineResumed(current)\n        with(current) {\n            // fail fast when trying to resume continuation without completion\n            val completion = completion!!\n            val outcome: Result&lt;Any?&gt; =\n                try {\n                    val outcome = invokeSuspend(param)\n                    if (outcome === COROUTINE_SUSPENDED) return\n                    Result.success(outcome)\n                } catch (exception: Throwable) {\n                    Result.failure(exception)\n                }\n            releaseIntercepted()\n            if (completion is BaseContinuationImpl) {\n                current = completion\n                param = outcome\n            } else {\n                completion.resumeWith(outcome)\n                return\n            }\n        }\n    }\n}\n\n// 2. AbstractCoroutine에서 resume을 실행하면서 전달받은 result를 CompletedExceptionally로 변환하여 전달한다.\npublic final override fun resumeWith(result: Result&lt;T&gt;) {\n    val state = makeCompletingOnce(result.toState())\n    if (state === COMPLETING_WAITING_CHILDREN) return\n    afterResume(state)\n}\ninternal fun &lt;T&gt; Result&lt;T&gt;.toState(\n    onCancellation: ((cause: Throwable) -&gt; Unit)? = null\n): Any? = fold(\n    onSuccess = { if (onCancellation != null) CompletedWithCancellation(it, onCancellation) else it },\n    onFailure = { CompletedExceptionally(it) }\n)\n\n\n// 3. JobSupport에서 예외가 감지된다면 모든 형제,부모 Job에게 예외를 전달하고 상태를 취소,완료 상태로 변경한다.\nprivate fun tryMakeCompletingSlowPath(state: Incomplete, proposedUpdate: Any?): Any? {\n    val list = getOrPromoteCancellingList(state) ?: return COMPLETING_RETRY\n    val finishing = state as? Finishing ?: Finishing(list, false, null)\n    var notifyRootCause: Throwable? = null\n    synchronized(finishing) {\n        ...\n        notifyRootCause = finishing.rootCause.takeIf { !wasCancelling }\n    }\n    notifyRootCause?.let { notifyCancelling(list, it) }\n    val child = firstChild(state)\n    if (child != null &amp;&amp; tryWaitForChild(finishing, child, proposedUpdate))\n        return COMPLETING_WAITING_CHILDREN\n    return finalizeFinishingState(finishing, proposedUpdate)\n}\nprivate fun notifyCancelling(list: NodeList, cause: Throwable) {\n    // first cancel our own children\n    onCancelling(cause)\n    notifyHandlers&lt;JobCancellingNode&gt;(list, cause)\n    cancelParent(cause) // tentative cancellation -- does not matter if there is no parent\n}</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/880a59dd8ab44d605908b0f9d6d2ccd9/b97f6/scopeexception.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA6ElEQVR42j3P207CQBSF4b6NkRnowXZ6mENngGIpKIQEkRj1/Z/id2yiF1/Wzr5Zeyd9kXP3mte65KgqDtHFWe7bzezjeeD7MPG1H7n6nts6cA09p66dDXmGl4KwlGyWgsSKBcZYQvDopqVSLZ3pMS7g/Ibtbk/daKq6Q8X8m+UqRywzhExZyBUPIqURksSJx9iSctl6Pn3Ne99ytoZdWc6G8ompqTnF3a8XoxlrxSGWT03DqBTHeOlRxy9VSSJjQ74q2Lmet8Fxi87BMlrN1Bt8p7GdZ72e8MbhOkOZFf+esnzOKirSgh+uvog2/eORdAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"scopeexception\"\n        title=\"\"\n        src=\"/static/880a59dd8ab44d605908b0f9d6d2ccd9/1cfc2/scopeexception.png\"\n        srcset=\"/static/880a59dd8ab44d605908b0f9d6d2ccd9/3684f/scopeexception.png 225w,\n/static/880a59dd8ab44d605908b0f9d6d2ccd9/fc2a6/scopeexception.png 450w,\n/static/880a59dd8ab44d605908b0f9d6d2ccd9/1cfc2/scopeexception.png 900w,\n/static/880a59dd8ab44d605908b0f9d6d2ccd9/b97f6/scopeexception.png 958w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>처음 예외가 발생한 이후 코루틴 스코프의 Job은 취소된 상태이고, 상세 상태에는 예외 정보가 저장된것을 볼 수 있다.<br>\n만약 이 취소된 코루틴 스코프를 재호출하면, 내부 상태를 확인하고 비어있는 구현체인 NonDisposableHandle을 반환하기 때문에 코루틴이 실행되지 않는다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">loopOnState { state -&gt;\n    when (state) {\n        is Empty -&gt; {\n            ...\n        }\n        is Incomplete -&gt; {\n            ...\n        }\n        else -&gt; { // is complete\n            if (invokeImmediately) {\n                // ChildHandleNode.childJob.parentCancelled(job) 부모 Job을 취소한다.\n                handler.invoke((state as? CompletedExceptionally)?.cause)\n            }\n            return NonDisposableHandle\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<p>테스트 코드로 확인해보면 더 이해하기 쉬울 것이다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">given(&quot;코루틴 빌더별 예외 처리 방식&quot;) {\n    `when`(&quot;스코프 내에서 launch 빌더를 사용할 때&quot;) {\n        then(&quot;예외가 parentJob에 전파되며, 취소된 스코프는 실행되지 않는다.&quot;) {\n            var caughtException = false\n            val handler = CoroutineExceptionHandler { _, _ -&gt;\n                // 예외 핸들러를 통해 스코프 내의 에외를 잡아도 부모 Job에 그대로 전파된다.\n                caughtException = true\n            }\n            val parentJob = Job()\n            val scope = CoroutineScope(parentJob + Dispatchers.IO + handler)\n\n            parentJob.isActive shouldBe true\n            parentJob.isCancelled shouldBe false\n            parentJob.isCompleted shouldBe false\n\n            val childJob = scope.launch {\n                delay(50)\n                throw RuntimeException(&quot;launch 내부 예외&quot;)\n            }\n\n            childJob.isActive shouldBe true\n            childJob.isCancelled shouldBe false\n            childJob.isCompleted shouldBe false\n            caughtException shouldBe false\n\n            childJob.join()\n\n            parentJob.isActive shouldBe false\n            parentJob.isCancelled shouldBe true\n            parentJob.isCompleted shouldBe true\n\n            childJob.isActive shouldBe false\n            childJob.isCancelled shouldBe true\n            childJob.isCompleted shouldBe true\n            caughtException shouldBe true\n\n            scope.launch {\n                throw RuntimeException(&quot;이 코드는 실행되지 않습니다.&quot;)\n            }\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<h2 id=\"첫-번째-코루틴의-구조\" style=\"position:relative;\">첫 번째. 코루틴의 구조<a href=\"#%EC%B2%AB-%EB%B2%88%EC%A7%B8-%EC%BD%94%EB%A3%A8%ED%8B%B4%EC%9D%98-%EA%B5%AC%EC%A1%B0\" aria-label=\"첫 번째 코루틴의 구조 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 583px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/84c9a2296b8160a5dbf148c091c3afb7/9fc4b/coroutinescope.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.77777777777778%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACbklEQVR42mWTWW/iWBBG8///Sj+NpjVqqdNZCDgEB7PHGzbGBq9gY9YEkj5dBs1MZvrhU6l0vzq3qnx9dTx9sFy/kZWi9emstDyy3H5geglPXZNW16KpGdSaPQw3otj9PHv+9le1FaNiXZnzHYPgyDB4ZeCVDP31OY4kfldGfKv3+Hrb5q/7Dn/eqNy0DIbT8qLKW0Wp7ftHxtGeK21yYJxIR0mPU6GyS5u8FW3eco0iuGMx/UEe3JP792TeNeW8xmuhyXn74s1b5EkfJz2h2luuOpNXnHjPLqtLoUIaaJRRnfeyxSJQSX2BF62z8rBLEWmcVk22AlvMe6zjltQquPEGxdhcOpyke2b2LbNZgB/EpKGN+vCF65s76kqLZu0PzP4duunQ6Q7w9Fu6zzVG+pj2s0roPjDNdp+BBzzjmuHoBWcSYBldRto3hi+WyGbYucPRH2k8qjypHaZWnZ7W4Pt1jUZDIZwon4GXkTdJjYXfZBmZMvqD7OaR2FOJpx32MtImbbCKdZZhj8OiThkqrLIxRfgstXUZeYtibqod7rHjE1FoUqZtkqBJmfVYpX3yWJP8SS7pnDVz6+e8zAbi7Z29q+SZSJpw0g8ejfICHEuih+/o8yNmdIl6eOLF32JNIkx3hu1FzNMVQbrhZXaQ8/963eznv0A7kUccnbDi939kiMkPF5SrnPV6je9PsSwT29Tp2xF2ivguNVVtBVR0AWruDkeSqsvPsuSSaZQLcCkqmAVTvInDRDR0M5wF4ns/e6uGKqA6lh268kEG8tK73v5/OqA5a7pWTFuf0zZCBk4mf9GKzm9eYfjyUpIDvwAmmGe/St7gsAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coroutinescope\"\n        title=\"\"\n        src=\"/static/84c9a2296b8160a5dbf148c091c3afb7/9fc4b/coroutinescope.png\"\n        srcset=\"/static/84c9a2296b8160a5dbf148c091c3afb7/3684f/coroutinescope.png 225w,\n/static/84c9a2296b8160a5dbf148c091c3afb7/fc2a6/coroutinescope.png 450w,\n/static/84c9a2296b8160a5dbf148c091c3afb7/9fc4b/coroutinescope.png 583w\"\n        sizes=\"(max-width: 583px) 100vw, 583px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>간략하게 보면 위의 구조와 같다.</p>\n<ol>\n<li><strong>CoroutineScope</strong> : 코루틴의 실행 범위를 정의하며, 모든 코루틴은 특정 Scope 내에서 실행된다. CoroutineContext를 포함하고 있어 코루틴의 실행 환경을 제공한다.\n<ul>\n<li><code class=\"language-text\">supervisorScope {}</code>, <code class=\"language-text\">coroutineScope {}</code>, <code class=\"language-text\">CoroutineScope()</code>, <code class=\"language-text\">runBlocking {}</code>, <code class=\"language-text\">withContext {}</code></li>\n</ul>\n</li>\n<li><strong>CoroutineContext</strong> : 코루틴 실행에 필요한 <strong>컨텍스트 정보들의 집합</strong> 이다.\n<ul>\n<li><strong>Job</strong> : 코루틴의 생명주기를 관리할 수 있는 <code class=\"language-text\">시작</code>, <code class=\"language-text\">취소</code>, <code class=\"language-text\">완료</code>등의 상태를 가지며, 부모와 자식 Job을 참조한다.</li>\n<li><strong>Dispatcher</strong> : 코루틴이 어떤 스레드에서 실행될지 결정한다.\n<ul>\n<li><code class=\"language-text\">Dispatchers.Main</code>, <code class=\"language-text\">IO</code>, <code class=\"language-text\">Default</code>, <code class=\"language-text\">Unconfined</code></li>\n</ul>\n</li>\n<li><strong>CoroutineExceptionHandler</strong></li>\n</ul>\n</li>\n<li><strong>Continuation</strong> : 코루틴의 중단, 재개 메커니즘을 담당하며, <code class=\"language-text\">suspend</code> 함수가 호출될 때 현재 실행 상태를 저장하고, 작업 완료 후 해당 지점부터 재개할 수 있게 해준다.</li>\n</ol>\n<p>코루틴을 중단하면 스레드를 반환해 콜 스택에 있는 정보가 사라지기 때문에 어딘가에 실행 지점을 저장해놓아야 한다.<br>\n그 역할이 Continuation이다.<br>\n<strong>중단이 되었을 때의 상태(label)와 함수의 지역 변수와 파라미터(필드), 그리고 중단 함수를 호출한 함수가 재개될 위치 정보를 가지고 있다.</strong><br>\n그렇기에 하나의 Continuation 객체가 다른 Continuation 객체를 참조하는 거대한 양파와 같다.</p>\n<p>아래의 코드를 통해 중단함수가 디컴파일되는 경우 Continuation이 어떻게 상태를 구분하는지, 또한 continuation은 어떻게 resume되는지 확인할 수 있다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">suspend fun findUserName(token: String): String {\n    println(&quot;Before&quot;)\n    val userId = getUserId(token) // suspending\n    println(&quot;Got userId: $userId&quot;)\n    val userName = getUserName(userId)\n    println(&quot;After&quot;)\n    return userName\n}\n\nsuspend fun getUserId(token: String): String {\n    delay(1000)\n    return &quot;test user id&quot;\n}\n\nsuspend fun getUserName(userId: String): String {\n    delay(1000)\n    return &quot;test user name&quot;\n}\n\nprivate val executor = Executors.newSingleThreadScheduledExecutor {\n    Thread(it, &quot;scheduler&quot;).apply { isDaemon = true }\n}\n\nsuspend fun delay(timeMillis: Long): Unit = suspendCancellableCoroutine { cont -&gt;\n    executor.schedule({\n        cont.resume(Unit)\n    }, timeMillis, TimeUnit.MILLISECONDS)\n}</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/7b6b8c1d339c8793085d17b3966d231c/b06fe/continuation.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 88.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAAAsTAAALEwEAmpwYAAADBElEQVR42p2Ua3OaYBCF/QONclc0gkSjgNwEbNR4A7zl0uZD//9fOT2gSZtM2un0w87AwPvsnj27b00URXwWjUYDo0mMZHfEeJ1hvNrA2+7Qcz0I9TpESfr0XO1PQIHAGz8k8IAg2xG2ZeQwHAIb/wFssIqbMMKEwCgr4LJCZ0NgWSGTSbJ8hn6ImiAI+CxkQqNkivnxESFB8SrHhJJLYOPq6hz1q/fPjJqiqlCbTShNDarWhKxpuDVNmK0WhkmE9OEBYUHJeY708IQB26C1dVieh+uRDeMS10MbncEQNcsdIykObHoOb0lZjIihEaz3TXiTEAEh3dsRujzk3Q4RxinWLz8wOz1hSgXJ7oRJwcj3qBm2h3T/yJcTgu2ejWfP1ju0uxbqwhd4ro90OkeY3KHvBmgpCvwower5BfenZ3zdPbAVe0SMNDuwwnGIiDCPFZZV2qsM4XILvduBRtnxYoP7x2dW8YC0OKJ3bWDsuHDvFvDv5ojnS4zTBW4nU/TDpAQGzPTETEfE2wLBOkdwv4GiK+ypDI8/RxybsooJv9kDB1ani25Lh9HqQGe0tBbEi5nsoY8pJXubAtFmh5CHRrMlZJolygLcZIbZ4bGSF68L6NcWDWxXoyVxTFSVRsoK34XzHFpBiuTSw1LyiIaM5megwJ9u4hjBnoblGexlBpUVyYp6BpTjxWdJkn8NtuVF+Hr6TpfOK+awh/Z8VQHL4W52Omj3LOimhbZhXQ4KbwCFct8DS8mnb/AzOrw5wKXLzqqAxMxGv4++F8KwXZi2U+2xbvaqTakkU2qz06ukvwE71g0dijmoIXpeAIsz1w+n/CihH0ScsycE+QE+t8SnCrPcFFZeQoTPJFfuMONriIIITTeqZ3PsI2TlAQ1z2VuXhnVZ7dttw7OKon0AfrwYqqxaBR5wrhI67BPo0BCXU2BWt41QyS2rVOjy34GX3oiSgkHECeD+lsAxt8fLONhsTQlQuPeKqrFC9V/vwzr76ld3ocPNsRdrSs4qg8rb5VVNFb8BfwKUIv8VK530VQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt text\"\n        title=\"\"\n        src=\"/static/7b6b8c1d339c8793085d17b3966d231c/1cfc2/continuation.png\"\n        srcset=\"/static/7b6b8c1d339c8793085d17b3966d231c/3684f/continuation.png 225w,\n/static/7b6b8c1d339c8793085d17b3966d231c/fc2a6/continuation.png 450w,\n/static/7b6b8c1d339c8793085d17b3966d231c/1cfc2/continuation.png 900w,\n/static/7b6b8c1d339c8793085d17b3966d231c/21482/continuation.png 1350w,\n/static/7b6b8c1d339c8793085d17b3966d231c/d61c2/continuation.png 1800w,\n/static/7b6b8c1d339c8793085d17b3966d231c/b06fe/continuation.png 15340w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/678d094323c1155cfccdf1e8181cc5f9/22284/continuation_sequence.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 158.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAgCAYAAAASYli2AAAACXBIWXMAAAsTAAALEwEAmpwYAAAEHUlEQVR42pVWaXPbNhT0//857afOdJJp67R2aseJ3VGcTGqptg5KpESRAHGD2wUpyfIhx8EMRiQELN6x+x6PvNYohkPYWiCN0LYYlgW+FTlU8N1ayzWR36Ga3aD1Fi3XJlLha1lzT4QJFv/VGSorcdRGgdX8DKt8BNloCCFRCQ1tNJxrEJzk8QjvPKyxCb6bznsY24OnYZ3tLj5KL46bvQ8IgdMbaDVBlf+C1fhn1MUx2iAQI7jHYzsiF/bfnXP7gD16756HkiPkiwHqdQ5J15LVjXJwpoS3U/5O4E2xAdxY/BDQ7QC3cTSxpcWxszwd1PUIJS0uxr+imL6DLAdcj4csfAwY4dqA/dG6AnJ9C0GLFa2tpYPRc6j1ALa5IYZGgjhooWvjA0BEXhDcFh7p32U5wnT4O2a377BejtBG+x3Atu0TRffb6BFsss6gkQ0abWHTOo8FT6ZkJ3A6S7Rx0E1F8wU0OamVhmHWDYESTSQPK655XuqZvBTXdEmK635SrN3E0KkxlrO/GOQvuwQki/cp0Vkd4kHatJHczS+6zD/r8mOOPbeW3hPdUjisnqGc/gSvhz8GmNzqvSAnXWTWR5jf/YGqpHRtOEybyIymmGEToTSM+IL5+ARSCJLco6b2rdWdEJI0k9peAHxqodENFrNrmGbIbFMpTr2W2MyizcirbxB1Sdn10pOSdGFF0eIGmtJ0toEPrwIMqJefMbs756Ga2e25+DjzXVgOF4d7wMisCVpTFDVLVB/odkPw52nziuKQbq+qunN1OxvJWrn6l3z9xOxeQVY3ry8OD0kbeytpeTEbYHp7Qu2eYjYZUFkVa2WB6HOqSh4uDs9ludeyZRhYaMlB0g5FeUsqnZKLp1ivJt2+DnBL2K4QbBJgeTjNpOWm0zLBdK/rrjgoBUOXaXg3d1ruOGZIiUZ1hzsAPieibi1Nv0+0nN435A9+DbFMWl68oJTHxYEe1LXsLtPadIVWJGtTYyNfZTXhJc2BehiSbu8tTARupESesUKzxLkUCoIqH3byfEF6bFLVJTN5zCaVMQS6DwU17I3aXeq5PxXY79OGlbquF8iXY7pg9rIcuib/SkD7wOVU3hcrcV9qfhRwG6+UjDQNKZBl19T0Jd2/ZkKaDjB6s2tSnp7Y1P2fSK9VKLIBytUComHRZHuspGfQGTNbEazmxrgBvP/0cDysNxa22ONh21o28bdw8g28+sB5hqDPEA15pT9iXbzHYnqM8eg3LOd/Qon3CIZ71Gbqc86/4ZtPJDgBqSgo9lQv/kG0/BrgLNbnWJRnUM0V3b4g6Adkw7eYD98wBB8R3WeU8gpzPhvDRq8vsRQX0PwKOwoUZZ0byiruenLGr69ZzXa6KaDJFUPaqGrdJ4drBfdPRGq3jB/X5uRp4zT+BxeNwG5mUmQNAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"continuation sequence\"\n        title=\"\"\n        src=\"/static/678d094323c1155cfccdf1e8181cc5f9/1cfc2/continuation_sequence.png\"\n        srcset=\"/static/678d094323c1155cfccdf1e8181cc5f9/3684f/continuation_sequence.png 225w,\n/static/678d094323c1155cfccdf1e8181cc5f9/fc2a6/continuation_sequence.png 450w,\n/static/678d094323c1155cfccdf1e8181cc5f9/1cfc2/continuation_sequence.png 900w,\n/static/678d094323c1155cfccdf1e8181cc5f9/21482/continuation_sequence.png 1350w,\n/static/678d094323c1155cfccdf1e8181cc5f9/d61c2/continuation_sequence.png 1800w,\n/static/678d094323c1155cfccdf1e8181cc5f9/22284/continuation_sequence.png 2428w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>코루틴은 Continuation의 실행 가능한 단위(블록)라고 볼 수 있다.</p>\n</blockquote>\n<h2 id=\"두-번째-코루틴의-구조적-동시성\" style=\"position:relative;\">두 번째. 코루틴의 구조적 동시성<a href=\"#%EB%91%90-%EB%B2%88%EC%A7%B8-%EC%BD%94%EB%A3%A8%ED%8B%B4%EC%9D%98-%EA%B5%AC%EC%A1%B0%EC%A0%81-%EB%8F%99%EC%8B%9C%EC%84%B1\" aria-label=\"두 번째 코루틴의 구조적 동시성 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>코루틴간 하나의 block으로 감싸져있는 형태로 계층적인 구조를 갖도록하여, 생명주기와 에러 처리, 취소 전파를 통해 예측 가능하도록 하기 위함이다.<br>\n그렇기 때문에, Coroutine이 손실되거나 누수되지 않도록 보장하며, 발생하는 오류도 제대로 보고되도록 보장할 수 있다.<br>\nCoroutineContext의 Job이 아래와 같은 생명주기를 가지면서 코루틴의 구조적 동시성을 지원하고 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f7b102779d4c79b1c5e819da077b5173/bb2fd/coroutinehierarchy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 64.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAAsTAAALEwEAmpwYAAACUklEQVR42oWT227TQBCG+xK8AQ/IBRIXXPIkXMAVUiUkIhUEAiFRoKEFWpK0NGkS1/Epjb0+H9b7MXZbqZUKWBqt15r5/P8zu1tcP8Zg2pam1jRJhnY8stk52emC6ccTPm8fMHp7gvczIDxXaN2im5a20eiupmp6zBY3HtOaPpG2hjIhcVx0HBI5AdZsxdoNEQSJSkmiFG0EKjVGahsB3wYqhVk5aNvGWGPy0x2Wu8/JpwNMrUR50RdalsW34T5Hh7/wJhOK+ZxGasrFEvL8BlBrTFmh0wxTiKVwSj5/LeuxwErqMu/Tcimyzi3slU1TFJ00TFVRqlictXdbbuIp/ukbluMBzuglVTQTa2JPNzjiYjyaMJHw/eCq/YayqK4sS2KnrltN1+CyRPtL1M4L3KdPUK+eUa8dKrHcSo59seT7yVDiK6vNQgRKfi0KxVmndoswBM/rwwRr6sUcsw7wHj5gfv8eweNHYregyEK69g/PPjEYbjPY3+Z4sQeBT+PY0ssFbEIBitzr6C1X8scsoslkEGmIzhV1uiFOE1ReikIPL7rADde40ZqNHLFSjkyeZf84Nv08b3w3mk2ccXjm82Pqo1JNWhj2f7scLQLirKIo8n8Br5jmGtgSpan0zWdv7AqgJisbdg9tjmYbgQsw/xuwuVTYTa6P/ntLKNa+jFw+HCyJ84apHfFub8b74RmWr2TK/1N4y/KlwqUfM3cjAVb4UcZsFcpeEcjNudNyN5iqqCmlJ2Uua171UchehYosSciTlDhSpLG8y0+u99117IB/AEfq4LCDgMqSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"coroutinehierarchy\"\n        title=\"\"\n        src=\"/static/f7b102779d4c79b1c5e819da077b5173/1cfc2/coroutinehierarchy.png\"\n        srcset=\"/static/f7b102779d4c79b1c5e819da077b5173/3684f/coroutinehierarchy.png 225w,\n/static/f7b102779d4c79b1c5e819da077b5173/fc2a6/coroutinehierarchy.png 450w,\n/static/f7b102779d4c79b1c5e819da077b5173/1cfc2/coroutinehierarchy.png 900w,\n/static/f7b102779d4c79b1c5e819da077b5173/bb2fd/coroutinehierarchy.png 1058w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">suspend fun start() {\n    val userData = UserData()\n    var parentJob: Job? = null\n    var dbJob: Deferred&lt;UserData&gt;? = null\n    var cacheJob: Job? = null\n    shouldThrow&lt;RuntimeException&gt; {\n        coroutineScope {\n            parentJob = currentCoroutineContext()[Job]!!\n            parentJob.isActive shouldBe true\n            parentJob.isCancelled shouldBe false\n            parentJob.isCompleted shouldBe false\n\n            cacheJob = launch { saveInCache(userData) }\n            dbJob = async { saveInDatabase(userData) }\n            dbJob.await()\n        }\n    }.shouldHaveMessage(&quot;commit 예외 발생&quot;)\n\n    parentJob!!.isActive shouldBe false\n    parentJob.isCancelled shouldBe true\n    parentJob.isCompleted shouldBe true\n    dbJob!!.isActive shouldBe false\n    dbJob.isCancelled shouldBe true\n    dbJob.isCompleted shouldBe true\n    cacheJob!!.isActive shouldBe false\n    cacheJob.isCancelled shouldBe true\n    cacheJob.isCompleted shouldBe true\n}\n\nsuspend fun saveInDatabase(userData: UserData): UserData {\n    return coroutineScope {\n        commit()    // 예외 발생 !!!\n        userData\n    }\n}\n\nsuspend fun saveInCache(userData: UserData): UserData {\n    coroutineScope {\n        val job1 = async { putKey() }\n        val job2 = async { updateInMem() }\n\n        try {\n            awaitAll(job1, job2)\n        } catch (e: Exception) {\n            e.shouldBeInstanceOf&lt;CancellationException&gt;()\n            e.message shouldBe &quot;Parent job is Cancelling&quot;\n            throw e\n        }\n    }\n    return userData\n}\n\nsuspend fun commit() {\n    throw RuntimeException(&quot;commit 예외 발생&quot;)\n}</code>\n        </deckgo-highlight-code>\n<p><code class=\"language-text\">commit()</code> 메소드에서 런타임 예외가 발생하여 관계된 코루틴의 Job 상태들이 <code class=\"language-text\">Cancelled</code>로 전이된 것을 확인할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5c40df9d2ee084131068ab736dbb5e81/45662/job_lifecycle.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.22222222222222%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAABYlAAAWJQFJUiTwAAABcElEQVR42l2QTUsbURSG84MstIX+AJfuui7Y7opEsLR140Zaav9AoSBoEDSUQg1FF0qkSC3EaEOJgqgBk1FkJpP5yuRzkjtz5+lNAtb0bF7O5Tnvee9JbBzesJa7JvNHx293sGsmRbPFx0KNd/kqu5qPaRhUdYOvpTIz2X3e/DjgzHZxTAvddfisbfLhMsVyJUPi+epvXqQKzH0pYjgNPMclXbzlUfqCB+kS7/MGfsPHsjzeHp/yJPuLyf08O9ot7XqL4o3GVO4Vj39O8/RongSqIhlzv+JeQOTZ2J5LVasgup3BK1GjTteuIYbQv5koEvREQBiKkeGdkYIGmAwCpF8nbLTo2x6h7xL5HrLugFo2ZBmx41EYNySWo43GCe3tJN2tl4jz76PBfo9YCKRSOfhB0MHSdbqmQe3bOnrqE9bmxv+G0VDCyh7N1Yc0VyYIDpaIW8rEtZHqBNJzVFKVWKlQfa9c4mphlsvkM8qLr/kLspevrR+NMTUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alt text\"\n        title=\"\"\n        src=\"/static/5c40df9d2ee084131068ab736dbb5e81/1cfc2/job_lifecycle.png\"\n        srcset=\"/static/5c40df9d2ee084131068ab736dbb5e81/3684f/job_lifecycle.png 225w,\n/static/5c40df9d2ee084131068ab736dbb5e81/fc2a6/job_lifecycle.png 450w,\n/static/5c40df9d2ee084131068ab736dbb5e81/1cfc2/job_lifecycle.png 900w,\n/static/5c40df9d2ee084131068ab736dbb5e81/21482/job_lifecycle.png 1350w,\n/static/5c40df9d2ee084131068ab736dbb5e81/45662/job_lifecycle.png 1410w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h1 id=\"해결방법\" style=\"position:relative;\">해결방법<a href=\"#%ED%95%B4%EA%B2%B0%EB%B0%A9%EB%B2%95\" aria-label=\"해결방법 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<h2 id=\"1-supervisorjob-적용-\" style=\"position:relative;\">1. SupervisorJob 적용 👍<a href=\"#1-supervisorjob-%EC%A0%81%EC%9A%A9-\" aria-label=\"1 supervisorjob 적용  permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@RestController\nclass TestController {\n    // SupervisorJob을 사용하여 자식 코루틴의 실패가 부모에 영향을 주지 않도록 함\n    private val scope = CoroutineScope(Dispatchers.IO + SupervisorJob())\n    \n    @GetMapping(&quot;/test&quot;)\n    fun test() {\n        scope.launch {\n            // 예외가 발생해도 scope는 계속 활성 상태 유지\n            throw RuntimeException(&quot;예외 발생!&quot;)\n        }\n    }\n}\n\ngiven(&quot;간단한 SupervisorJob 테스트&quot;) {\n    `when`(&quot;SupervisorJob을 사용한 스코프에서 자식이 실패하면&quot;) {\n        then(&quot;다른 자식과 스코프는 영향받지 않는다&quot;) {\n            runBlocking {\n                var child2Completed = false\n                val scope = CoroutineScope(SupervisorJob())\n                \n                // 첫 번째 자식 - 실패\n                scope.launch {\n                    throw RuntimeException(&quot;자식1 실패&quot;)\n                }\n                \n                // 두 번째 자식 - 정상 실행\n                scope.launch {\n                    delay(100)\n                    child2Completed = true\n                }.join()\n                \n                child2Completed shouldBe true\n                scope.coroutineContext[Job]?.isActive shouldBe true\n                \n                scope.cancel()\n            }\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<h2 id=\"2-supervisorscope-사용\" style=\"position:relative;\">2. supervisorScope 사용<a href=\"#2-supervisorscope-%EC%82%AC%EC%9A%A9\" aria-label=\"2 supervisorscope 사용 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@RestController\nclass TestController {\n    private val scope = CoroutineScope(Dispatchers.IO)\n    \n    @GetMapping(&quot;/test&quot;)\n    fun test() {\n        scope.launch {\n            supervisorScope {\n                // supervisorScope 내부의 자식 코루틴 실패가 부모에 영향 없음\n                throw RuntimeException(&quot;예외 발생!&quot;)\n            }\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<p>코루틴 스코프 안에 코루틴 빌더가 한 개 더 생성되어야 해서 굳이 이렇게 해결하진 않을 것 같다.</p>\n<h2 id=\"3-spring-suspend--코루틴-빌더\" style=\"position:relative;\">3. Spring suspend + 코루틴 빌더<a href=\"#3-spring-suspend--%EC%BD%94%EB%A3%A8%ED%8B%B4-%EB%B9%8C%EB%8D%94\" aria-label=\"3 spring suspend  코루틴 빌더 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@RestController\nclass TestController {\n    @GetMapping(&quot;/test&quot;)\n    suspend fun test() {\n\n        // 1. 컨텍스트 전환이 필요한 경우\n        withContext(Dispatchers.IO) {\n            // ...\n        }\n\n        // 2. 모든 자식이 완료될 때까지 대기, 하나라도 실패하면 모두 취소\n        return coroutineScope {\n            val data1 = async { fetchData1() }\n            val data2 = async { fetchData2() }\n            Result(data1.await(), data2.await())\n        }\n\n        // 3. 자식 실패가 다른 자식에 영향 없음\n        supervisorScope {\n            launch { .. }\n            launch { .. }\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1a7390e309b46b0c93a3ab6807e4e075/960bd/suspendingFunctionInvoke.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.55555555555556%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAABmElEQVR42k2S6XLbMAyE9SARL4AHCFKUbKdp7B6TH0n6/k/Upd1pO/OJA3G4xGKHC3O8HG1sPYmGPLLu2gbF4mMsKedcpfbAKXBmLtjnJNaxdQSW1foMXdu4ZJ5HN227VCWOzJmgiSXQFEMZ7jv49WGyGBdwRwgROsiK9FK66EBddc+iLrD1YTXBGKz+TniwkF5JbyBv3/fL2/jyPl4+Tq+/jq+f+8t7e/5Zzz/68xu1a9DXqNfYv8V+S1jbbTE+wvj0nkRyQbc+zhVt2679lFUTDPWT9kPawaU5SnZKJrDtjSPgA+UYHwkV0VJUpMM2cosZI22UkGKyFv79xPrFumAcz2yILTHyiDPSsvpgPK2rnxj/tDoUGNvYfyz4fIiRYkwFHWA8S4tJPMEY/390ffAnM79OsYOYa23bfh7j3HuX1nrfk1QbCFE7x85H58lhNM/o5O6gnrZXSylVEZWmdevjcm5jb207Dlw3qvZcFMYkI9SSiuY7yGd2RuCER0SYVIr2UlueaWnVgfCgwoMx6EboFp7+2jbhN0PxYzdUUsQlAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"suspendingFunctionInvoke\"\n        title=\"\"\n        src=\"/static/1a7390e309b46b0c93a3ab6807e4e075/1cfc2/suspendingFunctionInvoke.png\"\n        srcset=\"/static/1a7390e309b46b0c93a3ab6807e4e075/3684f/suspendingFunctionInvoke.png 225w,\n/static/1a7390e309b46b0c93a3ab6807e4e075/fc2a6/suspendingFunctionInvoke.png 450w,\n/static/1a7390e309b46b0c93a3ab6807e4e075/1cfc2/suspendingFunctionInvoke.png 900w,\n/static/1a7390e309b46b0c93a3ab6807e4e075/21482/suspendingFunctionInvoke.png 1350w,\n/static/1a7390e309b46b0c93a3ab6807e4e075/d61c2/suspendingFunctionInvoke.png 1800w,\n/static/1a7390e309b46b0c93a3ab6807e4e075/960bd/suspendingFunctionInvoke.png 6360w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Controller API가 suspend 함수인지 확인하여 <code class=\"language-text\">reactor.core.publisher.Mono&lt;T></code>가 실행된다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 900px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/dc9bad17c701c74ca59ae02478e14599/b54cd/springcoroutine.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAw0lEQVR42jWPWW4CMRBE5z4RUkLA8b6Mx2Y2BsL971K4G/mjVOpFT1XDkT28dRDK4SotjEuY1wPLdmA/XtjuT6z7o/k/7o8XfMz848LYPML6xKL9z6/AEEpBcgajVdBS4XyRuAiF65+B1A4hTUi5Io4VU12aFxYB6ebj505AmofTWaCuC5LR0No0kGYYqcMoLcG6xunG++65zLyv84ZBhYhSMlyDiVZZKAtpPEJLcVt2rtuB2gZO1isaF7g+zdTq6/SNN6sxjDXLbldmAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"springcoroutine\"\n        title=\"\"\n        src=\"/static/dc9bad17c701c74ca59ae02478e14599/1cfc2/springcoroutine.png\"\n        srcset=\"/static/dc9bad17c701c74ca59ae02478e14599/3684f/springcoroutine.png 225w,\n/static/dc9bad17c701c74ca59ae02478e14599/fc2a6/springcoroutine.png 450w,\n/static/dc9bad17c701c74ca59ae02478e14599/1cfc2/springcoroutine.png 900w,\n/static/dc9bad17c701c74ca59ae02478e14599/21482/springcoroutine.png 1350w,\n/static/dc9bad17c701c74ca59ae02478e14599/b54cd/springcoroutine.png 1662w\"\n        sizes=\"(max-width: 900px) 100vw, 900px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>이때 사용되는 코루틴 스코프는 <code class=\"language-text\">SupervisorJob</code> + <code class=\"language-text\">Dispatchers.Default</code>로 구성되어 있기에, 예외가 발생해도 부모 스코프는 취소되지 않는다.</p>\n<h2 id=\"4-예외-처리-\" style=\"position:relative;\">4. 예외 처리 👍<a href=\"#4-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC-\" aria-label=\"4 예외 처리  permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">@RestController\nclass TestController {\n    private val scope = CoroutineScope(Dispatchers.IO)\n    \n    @GetMapping(&quot;/test&quot;)\n    fun test() {\n        scope.launch {\n            try {\n                // business logic\n                throw RuntimeException(&quot;예외 발생!&quot;)\n            } catch (e: Exception) {\n                // 예외를 처리하여 스코프 취소 방지\n                logger.error(&quot;Error occurred: &quot;, e)\n            }\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<p>Job간 예외가 전파되기 때문에 <code class=\"language-text\">scope.launch {}</code> 밖에서 예외를 잡으면 의미없다.</p>\n<deckgo-highlight-code language=\"kotlin\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">given(&quot;코루틴 스코프 독립성 테스트&quot;) {\n    `when`(&quot;launch 바깥에서 try-catch로 예외를 잡으려고 하면&quot;) {\n        then(&quot;예외는 잡히지 않고 Job 계층으로 전파된다&quot;) {\n            val tryBlockException = AtomicBoolean(false)\n            val handlerException = AtomicBoolean(false)\n            \n            runBlocking {\n                val scope = CoroutineScope(Job() + CoroutineExceptionHandler { _, _ -&gt;\n                    handlerException.set(true)\n                })\n                \n                // try-catch로 launch를 감싸도 예외는 잡히지 않음\n                try {\n                    scope.launch {\n                        delay(50)\n                        throw RuntimeException(&quot;launch 내부 예외&quot;)\n                    }\n                    // launch는 즉시 반환되므로 여기서 예외가 발생하지 않음\n                } catch (e: Exception) {\n                    tryBlockException.set(true)  // 실행되지 않음\n                }\n                \n                delay(100)\n                \n                // 검증: try-catch는 예외를 잡지 못하고, ExceptionHandler가 처리\n                tryBlockException.get() shouldBe false  // try-catch로 잡지 못함\n                handlerException.get() shouldBe true    // CoroutineExceptionHandler가 처리\n                scope.coroutineContext[Job]?.isCancelled shouldBe true\n            }\n        }\n    }\n}</code>\n        </deckgo-highlight-code>\n<h1 id=\"마무리\" style=\"position:relative;\">마무리<a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p>이번 장애를 계기로 코루틴을 더 깊게 분석해보았다.<br>\n실무에 적용된 코루틴 안티 패턴을 걷어내고 동료들에게 공유할 수 있도록 노력해야겠다.<br>\n요즘 AI가 작성해주는 코드를 사용하게 되면서 이런 일이 쉽게 발생하는 것 같다. 여전히 딥 다이브하는 능력은 필수임을 잊지 말자.</p>","frontmatter":{"title":"API가 왜 멈췄을까? 코루틴 이해하기","date":"2025-09-10","update":"2025-09-12","description":null,"tags":["deep-dive","coroutine","postmortem"]},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AC%B8%EC%A0%9C-%EC%A7%80%EC%A0%90\">문제 지점</a></p>\n<ul>\n<li><a href=\"#%EC%B2%AB-%EB%B2%88%EC%A7%B8-%EC%BD%94%EB%A3%A8%ED%8B%B4%EC%9D%98-%EA%B5%AC%EC%A1%B0\">첫 번째. 코루틴의 구조</a></li>\n<li><a href=\"#%EB%91%90-%EB%B2%88%EC%A7%B8-%EC%BD%94%EB%A3%A8%ED%8B%B4%EC%9D%98-%EA%B5%AC%EC%A1%B0%EC%A0%81-%EB%8F%99%EC%8B%9C%EC%84%B1\">두 번째. 코루틴의 구조적 동시성</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%95%B4%EA%B2%B0%EB%B0%A9%EB%B2%95\">해결방법</a></p>\n<ul>\n<li><a href=\"#1-supervisorjob-%EC%A0%81%EC%9A%A9-\">1. SupervisorJob 적용 👍</a></li>\n<li><a href=\"#2-supervisorscope-%EC%82%AC%EC%9A%A9\">2. supervisorScope 사용</a></li>\n<li><a href=\"#3-spring-suspend--%EC%BD%94%EB%A3%A8%ED%8B%B4-%EB%B9%8C%EB%8D%94\">3. Spring suspend + 코루틴 빌더</a></li>\n<li><a href=\"#4-%EC%98%88%EC%99%B8-%EC%B2%98%EB%A6%AC-\">4. 예외 처리 👍</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\">마무리</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2025y/multiplexing/"},"frontmatter":{"title":"I/O 멀티플렉싱에 대해"}},"next":{"fields":{"slug":"/2025y/webclient/"},"frontmatter":{"title":"WebClient PrematureCloseException 원인 분석하기"}}},"pageContext":{"id":"44185076-e856-5646-974d-b8c8a058bc63","previousPostId":"e3d18442-a047-5f12-84d4-4bab1d333bc7","nextPostId":"e0b1b946-ea07-5d47-9d52-4627d912ebd9"}},"staticQueryHashes":["230163734","3589320610"],"slicesMap":{}}