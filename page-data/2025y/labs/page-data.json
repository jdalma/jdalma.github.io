{"componentChunkName":"component---src-templates-blog-post-js","path":"/2025y/labs/","result":{"data":{"site":{"siteMetadata":{"title":"코딩 주머니"}},"markdownRemark":{"id":"df0b7c66-d55f-5cf6-8dba-b96a8c6666ad","excerpt":"InnoDB 행 잠금의 2원 2규칙 원칙 1: InnoDB의 기본 잠금 단위는 넥스트 키 락이며, 넥스트 키 락의 잠금 범위는 좌측으로는 개구간, 우측으로는 폐구간이다.  InnoDB 잠금의 시작은 넥스트 키 락이다. 이후에 갭 락과 레코드 락을 따져보는 것이다. 원칙…","html":"<blockquote>\n<p><a href=\"https://devocean.sk.com/blog/techBoardDetail.do?ID=167948&#x26;boardType=techBlog\">InnoDB 행 잠금의 2원 2규칙</a></p>\n<ul>\n<li><strong>원칙 1</strong>: InnoDB의 기본 잠금 단위는 넥스트 키 락이며, 넥스트 키 락의 잠금 범위는 좌측으로는 개구간, 우측으로는 폐구간이다. <code class=\"language-text\">ex) (R1, R10]</code>\n<ul>\n<li>InnoDB 잠금의 시작은 넥스트 키 락이다. 이후에 갭 락과 레코드 락을 따져보는 것이다.</li>\n</ul>\n</li>\n<li><strong>원칙 2</strong>: 잠금은 쿼리를 수행하는 과정에서 접근한 객체에만 걸린다.</li>\n<li><strong>규칙 1</strong>: 인덱스(고유, 비고유)를 사용하는 동등 조건의 쿼리를 수행할 때 레코드 스캔 방향은 오른쪽이며, 마지막 레코드가 동등 조건을 만족하지 않으면 넥스트 키 락은 갭 락으로 강등된다.</li>\n<li><strong>규칙 2</strong>: 고유 인덱스를 사용하는 동등 조건의 쿼리를 수행할 때, 레코드가 동등 조건을 만족하면 넥스트 키 락은 레코드 락으로 강등된다.</li>\n</ul>\n</blockquote>\n<details>\n<summary>🔐 잠금 상태 조회 쿼리</summary>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">-- 잠금 상태 조회하기\nSELECT \n    dl.object_name AS `table`,\n    dl.lock_type,\n    dl.index_name,\n    dl.lock_mode,\n    CASE \n        WHEN dl.lock_mode LIKE &#39;%REC_NOT_GAP%&#39; THEN &#39;Record Lock&#39;\n        WHEN dl.lock_mode LIKE &#39;%GAP%&#39; AND dl.lock_mode NOT LIKE &#39;%REC_NOT_GAP%&#39; THEN &#39;Gap Lock&#39;\n        WHEN dl.lock_mode NOT LIKE &#39;%GAP%&#39; AND dl.lock_mode NOT LIKE &#39;%REC_NOT_GAP%&#39; THEN &#39;Next-Key Lock&#39;\n        ELSE dl.lock_mode\n    END AS lock_type_detail,\n    dl.lock_data AS locked_data\nFROM performance_schema.data_locks dl\nORDER BY dl.object_name, dl.lock_data;</code>\n        </deckgo-highlight-code>\n</details>\n<h2 id=\"갭-락으로-인한-insert-실패\" style=\"position:relative;\">갭 락으로 인한 INSERT 실패<a href=\"#%EA%B0%AD-%EB%9D%BD%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-insert-%EC%8B%A4%ED%8C%A8\" aria-label=\"갭 락으로 인한 insert 실패 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n| 20 |   20 |   20 |\n| 25 |   25 |   25 |\n+----+------+------+\n\n-- &lt;A 세션&gt; 존재하지 않는 id = 7를 업데이트 \nBEGIN;\nUPDATE t SET b=b+1 WHERE id=7;\n\n+-----------+------------+-----------+------------------+-------------+\n| lock_type | index_name | lock_mode | lock_type_detail | locked_data |\n+-----------+------------+-----------+------------------+-------------+\n| TABLE     | NULL       | IX        | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,GAP     | Gap Lock         | 10          |\n+-----------+------------+-----------+------------------+-------------+\n\n-- &lt;B 세션&gt;\nINSERT INTO t VALUES (8, 8, 8);     -- BLOCKED\nINSERT INTO t VALUES (9, 9, 9);     -- BLCOKED\n\nINSERT INTO t VALUES (4, 4, 4);     -- 성공\nINSERT INTO t VALUES (11, 11, 11);  -- 성공\nUPDATE t SET b=b+1 WHERE id=5;      -- 성공\nUPDATE t SET b=b+1 WHERE id=10;     -- 성공</code>\n        </deckgo-highlight-code>\n<p>먼저 넥스트 키 락에 의해 <code class=\"language-text\">(5, 10]</code>으로 잠금되고, 마지막 레코드 10이 id=7 조건에 만족하지 않기 때문에 넥스트 키 락은 갭 락으로 강등되어 <code class=\"language-text\">(5, 10)</code>의 잠금이 발생한다.<br>\n그리하여 마지막 업데이트 쿼리는 둘 다 성공한다.</p>\n<h2 id=\"non-unique-세컨더리-인덱스-동등-잠금-for-share\" style=\"position:relative;\">non-unique 세컨더리 인덱스 동등 잠금 (FOR SHARE)<a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%8F%99%EB%93%B1-%EC%9E%A0%EA%B8%88-for-share\" aria-label=\"non unique 세컨더리 인덱스 동등 잠금 for share permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n| 20 |   20 |   20 |\n| 25 |   25 |   25 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nselect id from t where a = 5 for share;\n\n+-----------+------------+-----------+------------------+-------------+\n| lock_type | index_name | lock_mode | lock_type_detail | locked_data |\n+-----------+------------+-----------+------------------+-------------+\n| TABLE     | NULL       | IS        | Next-Key Lock    | NULL        |\n| RECORD    | ix_a       | S,GAP     | Gap Lock         | 10, 10      | &lt;- (5, 10)\n| RECORD    | ix_a       | S         | Next-Key Lock    | 5, 5        | &lt;- (0, 5]\n+-----------+------------+-----------+------------------+-------------+\n\n-- &lt;B 세션&gt;\nINSERT INTO t VALUES (-1, -1, -1);  -- 성공\nINSERT INTO t VALUES (0,0,0);   -- BLOCKED\nINSERT INTO t VALUES (3,3,3);   -- BLOCKED\nINSERT INTO t VALUES (7,7,7);   -- BLOCKED\n\nUPDATE t SET b=b+1 WHERE id=5;  -- 성공\nUPDATE t SET b=b+1 WHERE id=10; -- 성공\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n| -1 |   -1 |   -1 |\n|  0 |    0 |    0 |\n|  5 |    5 |    6 |\n| 10 |   10 |   11 |\n+----+------+------+\n\nUPDATE t SET a=a+1 WHERE id=10; -- 성공\nUPDATE t SET a=a+1 WHERE id=5;  -- BLOCKED\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n| -1 |   -1 |   -1 |\n|  0 |    0 |    0 |\n|  5 |    5 |    6 |\n| 10 |   11 |   11 |\n+----+------+------+</code>\n        </deckgo-highlight-code>\n<ul>\n<li><strong>Q: 왜 5미만의 INSERT 쿼리는 실행하지 못할까?</strong>\n<ul>\n<li>원칙 1에 따라 기본 잠금 단위는 넥스트 키 락이기 때문에 <code class=\"language-text\">(0,5]</code>에 넥스트 키 락이 설정된다.</li>\n</ul>\n</li>\n<li><strong>Q: 왜 <code class=\"language-text\">id = (5 &lt; N &lt; 10)</code>의 INSERT 쿼리는 실행하지 못할까?</strong>\n<ul>\n<li>a 컬럼 인덱스는 유니크하지 않은 세컨더리 인덱스이기 때문에 <code class=\"language-text\">a = 5</code>에 해당하는 레코드만 찾아서 바로 종료하는 것이 아니라 오른쪽으로 계속 스캔하여 레코드 10을 찾을 때까지 이동하기에 <code class=\"language-text\">(5,10]</code>에 넥스트 키 락이 설정된다. <strong>이 과정에서 접근한 모든 객체에 잠금을 걸게 되기 때문이다</strong></li>\n</ul>\n</li>\n<li><strong>Q: 왜 <code class=\"language-text\">id=10</code>에 대한 a,b 컬럼 UPDATE는 성공할까?</strong>\n<ul>\n<li>10은 <code class=\"language-text\">a = 5</code> 조건을 만족하지 않기 때문에 넥스트 키 락이 갭 락으로 강등되어 <code class=\"language-text\">(5,10)</code>으로 잠금 범위가 변경되기 때문이다.</li>\n</ul>\n</li>\n<li><strong>Q: FOR SHARE로 <code class=\"language-text\">a = 5</code>에 대한 명시적 공유 잠금을 걸었는데 b 컬럼에 대한 업데이트는 왜 실행될까?</strong>\n<ul>\n<li>A 세션의 FOR SHARE 쿼리는 커버링 인덱스를 활용하고 있고 조회 가능 잠금이기 때문에 프라이머리 키 인덱스에 어떠한 잠금도 설정되지 않는다.</li>\n<li>잠금에 대한 정보를 통해 <code class=\"language-text\">ix_a 인덱스의 (5,10) 구간에 걸린 Gap Lock</code>으로 인해 a 컬럼은 UPDATE가 실행되지 않았고, b 컬럼에 대한 UPDATE는 실행 가능한 것이다.</li>\n<li>만약 <code class=\"language-text\">a = 5</code>에 대한 조회 가능 잠금을 통해 레코드가 업데이트 되는 것을 원하지 않으면 FOR SHARE 쿼리를 수정하면 된다.</li>\n</ul>\n</li>\n</ul>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">select * from t where a = 5 for share; -- 또는\nselect id, a, b from t where a = 5 for share;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IS            | Next-Key Lock    | NULL        |\n| RECORD    | ix_a       | S,GAP         | Gap Lock         | 10, 10      |\n| RECORD    | PRIMARY    | S,REC_NOT_GAP | Record Lock      | 5           | -&gt; 레코드 락을 확인할 수 있다!\n| RECORD    | ix_a       | S             | Next-Key Lock    | 5, 5        |\n+-----------+------------+---------------+------------------+-------------+</code>\n        </deckgo-highlight-code>\n<h2 id=\"non-unique-세컨더리-인덱스-동등-장금-for-update\" style=\"position:relative;\">non-unique 세컨더리 인덱스 동등 장금 (FOR UPDATE)<a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%8F%99%EB%93%B1-%EC%9E%A5%EA%B8%88-for-update\" aria-label=\"non unique 세컨더리 인덱스 동등 장금 for update permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n| 20 |   20 |   20 |\n| 25 |   25 |   25 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nselect id from t where a = 5 for update;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | ix_a       | X,GAP         | Gap Lock         | 10, 10      |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 5           |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 5, 5        |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\n\nINSERT INTO t VALUES (7,7,7);   -- BLOCKED\nUPDATE t SET b=b+1 WHERE id=5;  -- BLOCKED\nUPDATE t SET b=b+1 WHERE id=10; -- 성공\n\nUPDATE t SET a=a+1 WHERE id=5;   -- BLOCKED\nUPDATE t SET a=a+1 WHERE id=10;  -- 성공</code>\n        </deckgo-highlight-code>\n<h2 id=\"프라이머리-키-인덱스-범위-잠금\" style=\"position:relative;\">프라이머리 키 인덱스 범위 잠금<a href=\"#%ED%94%84%EB%9D%BC%EC%9D%B4%EB%A8%B8%EB%A6%AC-%ED%82%A4-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%B2%94%EC%9C%84-%EC%9E%A0%EA%B8%88\" aria-label=\"프라이머리 키 인덱스 범위 잠금 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p>조회 결과는 같지만 잠금 범위가 서로 다른 케이스를 확인해보자.</p>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nSELECT * FROM t WHERE id=10 FOR UPDATE;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 10          |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\nUPDATE t SET b=b+1 WHERE id=5;  -- 성공\nINSERT INTO t VALUES (7,7,7);   -- 성공\nINSERT INTO t VALUES (11,11,11);    -- 성공</code>\n        </deckgo-highlight-code>\n<p>처음엔 <code class=\"language-text\">(5, 10]</code> 넥스트 키 락이 설정되고, id는 프라이머리 키 인덱스이고 <code class=\"language-text\">id = 10</code> 조건에 해당하는 레코드가 존재하므로 레코드 락으로 강등된다.</p>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">-- &lt;A 세션&gt;\nBEGIN;\nSELECT * FROM t WHERE id &gt;= 10 AND id &lt; 11 FOR UPDATE;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 10          |\n| RECORD    | PRIMARY    | X,GAP         | Gap Lock         | 15          |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\nINSERT INTO t VALUES (8, 8, 8);     -- 성공\nINSERT INTO t VALUES (9, 9, 9);     -- 성공\nINSERT INTO t VALUES (11, 11, 11);  -- BLOCKED\n\nUPDATE t SET b=b+1 WHERE id = 15;   -- 성공\nUPDATE t SET a=a+1 WHERE id = 15;   -- 성공\nUPDATE t SET a=a+1 WHERE id = 10;   -- BLOCKED</code>\n        </deckgo-highlight-code>\n<p><code class=\"language-text\">id >= 10 AND id &lt; 11</code> 조건에 해당하는 레코드를 찾게 되는데, 먼저 <code class=\"language-text\">id >= 10</code>에 대한 <code class=\"language-text\">(5, 10]</code> 넥스트 키 락이 설정된다. 하지만 <code class=\"language-text\">id = 10</code>인 레코드가 존재하므로 레코드 락으로 강등된다.</p>\n<p><code class=\"language-text\">id &lt; 11</code> 같은 범위 검색은 조건을 만족하는지 안하는지 다음 첫 번째 레코드까지 접근해야만 알 수 있기 때문에 오른쪽으로 범위 검색을 계속해서 수행하며 <code class=\"language-text\">id=15</code> 레코드를 찾게된다.<br>\n이미 <code class=\"language-text\">id=10</code>레코드를 찾았으므로 <code class=\"language-text\">(10, 15)</code>에 갭락이 설정된다.</p>\n<p>즉, 최종 잠금 범위는 <code class=\"language-text\">10, (10, 15)</code>가 된다.</p>\n<h2 id=\"non-unique-세컨더리-인덱스-범위-잠금\" style=\"position:relative;\">non-unique 세컨더리 인덱스 범위 잠금<a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%B2%94%EC%9C%84-%EC%9E%A0%EA%B8%88\" aria-label=\"non unique 세컨더리 인덱스 범위 잠금 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nSELECT * FROM t WHERE a &gt;= 10 AND a &lt; 11 FOR UPDATE;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 10          |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 10, 10      |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 15, 15      |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\nINSERT INTO t VALUES (6, 6, 6);     -- BLOCKED\nINSERT INTO t VALUES (8, 8, 8);     -- BLOCKED\nINSERT INTO t VALUES (4, 4, 4);     -- 성공\n\nUPDATE t SET b=b+1 WHERE a = 15;    -- BLOCKED\nUPDATE t SET b=b+1 WHERE a = 10;    -- BLOCKED\nUPDATE t SET b=b+1 WHERE a = 5;     -- 성공\nUPDATE t SET b=b+1 WHERE a = 4;     -- 성공</code>\n        </deckgo-highlight-code>\n<p>먼저 <code class=\"language-text\">a=10</code>인 레코드를 찾아 <code class=\"language-text\">(5, 10]</code> 넥스트 키 락이 설정된다. <code class=\"language-text\">ix_a</code> 인덱스는 유니크 인덱스가 아니기 때문에 레코드 락으로 끝나지 않는다. (규칙 2를 적용할 수 없다.)<br>\n그렇기에 동등 조건을 만족하지 않는 다음 레코드까지 범위 검색을 수행하며, <code class=\"language-text\">a=15</code>에 해당하는 레코드를 찾아 검색이 중단되고 <code class=\"language-text\">(10, 15]</code>에 넥스트 키 락이 설정된다.<br>\n동등 조건이 아닌 범위 검색에 해당하기 때문에 갭 락으로 강등되지 않는다.</p>\n<p>즉, 최종 잠금 범위는 <code class=\"language-text\">(5, 10], (10, 15]</code>이다.</p>\n<h2 id=\"unique-세컨더리-인덱스-업데이트-잠금\" style=\"position:relative;\">unique 세컨더리 인덱스 업데이트 잠금<a href=\"#unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%EC%9E%A0%EA%B8%88\" aria-label=\"unique 세컨더리 인덱스 업데이트 잠금 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t2 (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  UNIQUE ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n| 20 |   20 |   20 |\n| 25 |   25 |   25 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nUPDATE t2 set b = b + 1 where a = 10;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 10          |\n| RECORD    | ix_a       | X,REC_NOT_GAP | Record Lock      | 10, 10      |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\n\ninsert into t2 values (9, 9, 9);    -- 성공\ninsert into t2 values (11, 11, 11); -- 성공\nupdate t2 set b = 15 where a = 10;  -- BLOCKED</code>\n        </deckgo-highlight-code>\n<p><code class=\"language-text\">a</code> 컬럼의 인덱스는 유니크함을 보장하기 때문에 <code class=\"language-text\">a = 10</code>을 찾게되면 넥스트 키 락은 레코드 락으로 강등되기 때문에 왼쪽과 오른쪽에 대한 갭락 또는 넥스트 키 락이 발생하지 않는다.</p>\n<h2 id=\"non-unique-세컨더리-인덱스-중복된-행-잠금\" style=\"position:relative;\">non-unique 세컨더리 인덱스 중복된 행 잠금<a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A4%91%EB%B3%B5%EB%90%9C-%ED%96%89-%EC%9E%A0%EA%B8%88\" aria-label=\"non unique 세컨더리 인덱스 중복된 행 잠금 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n| 20 |   20 |   20 |\n| 25 |   25 |   25 |\n| 30 |   10 |   30 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nSELECT * FROM t WHERE a=10 FOR UPDATE;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 10          |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 30          |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 10, 10      |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 10, 30      |\n| RECORD    | ix_a       | X,GAP         | Gap Lock         | 15, 15      |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\nINSERT INTO t VALUES (4, 4, 4);      -- 성공\nINSERT INTO t VALUES (6, 6, 6);      -- BLOCKED\nINSERT INTO t VALUES (9, 9, 9);      -- BLOCKED\nINSERT INTO t VALUES (12, 12, 12);   -- BLOCKED\nINSERT INTO t VALUES (17, 17, 17);   -- 성공\nINSERT INTO t VALUES (24, 24, 24);   -- 성공\nINSERT INTO t VALUES (27, 27, 27);   -- 성공\n\nUPDATE t SET b=b+1 WHERE a = 5;     -- 성공\nUPDATE t SET b=b+1 WHERE a = 10;    -- BLOCKED\nUPDATE t SET b=b+1 WHERE a = 15;    -- 성공\nUPDATE t SET b=b+1 WHERE a = 20;    -- 성공\nUPDATE t SET b=b+1 WHERE a = 25;    -- 성공\n\nUPDATE t SET a=a+1 WHERE id = 0;\nUPDATE t SET a=a+1 WHERE id = 5;     -- BLOCKED\nUPDATE t SET a=a+1 WHERE id = 10;    -- BLOCKED\nUPDATE t SET a=a+1 WHERE id = 15;\nUPDATE t SET a=a+1 WHERE id = 20;\nUPDATE t SET a=a+1 WHERE id = 25;\nUPDATE t SET a=a+1 WHERE id = 30;    -- BLOCKED\n\nUPDATE t SET b=b+1 WHERE id = 0;\nUPDATE t SET b=b+1 WHERE id = 5;\nUPDATE t SET b=b+1 WHERE id = 10;    -- BLOCKED\nUPDATE t SET b=b+1 WHERE id = 15;\nUPDATE t SET b=b+1 WHERE id = 20;\nUPDATE t SET b=b+1 WHERE id = 25;\nUPDATE t SET b=b+1 WHERE id = 30;    -- BLOCKED</code>\n        </deckgo-highlight-code>\n<p>먼저 <code class=\"language-text\">a=10</code> 조건에 해당하는 레코드를 찾아 <code class=\"language-text\">(5, 10]</code> 넥스트 키 락을 설정한다.<br>\n정확히는 <code class=\"language-text\">(a=5, id=5)부터 (a=10, id=10)</code>까지 넥스트 키 락이 설정된다.</p>\n<p>그리고 넌유니크 세컨더리 인덱스이기 때문에 다음 레코드 <code class=\"language-text\">a=15</code>를 찾을 때 까지 오른쪽으로 검색을 수행하며, 이 과정에서 <code class=\"language-text\">a=10, id=30</code> 레코드를 거치기 때문에 <code class=\"language-text\">(a=10, id=10) ~ (a=10, id=30)</code>까지 넥스트 키 락이 설정된다.</p>\n<p>계속 오른쪽으로 검색하며 <code class=\"language-text\">a=15, id=15</code> 레코드를 만나면 검색 루프는 종료되고 <code class=\"language-text\">(a=10, id=30) ~ (a=15, id=15)</code> 까지 넥스트 키 락이 설정된다.<br>\n하지만 검색 조건 <code class=\"language-text\">a=10</code> 조건에 해당되지 않으므로 최종적으로 갭 락으로 강등된다.</p>\n<p>즉 최종 잠금 범위는</p>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">-- ix_a, X (Next-Key Lock)\n( (a=5, id=5), (a=10, id=10) ],\n\n-- ix_a, X (Next-Key Lock)\n( (a=10, id=10), (a=10, id=30) ], \n\n-- ix_a, X,GAP (Gap Lock)\n( (a=10, id=30), (a=15, id=15) )</code>\n        </deckgo-highlight-code>\n<h2 id=\"non-unique-세컨더리-인덱스-중복된-행-잠금-추가-케이스\" style=\"position:relative;\">non-unique 세컨더리 인덱스 중복된 행 잠금 (추가 케이스)<a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A4%91%EB%B3%B5%EB%90%9C-%ED%96%89-%EC%9E%A0%EA%B8%88-%EC%B6%94%EA%B0%80-%EC%BC%80%EC%9D%B4%EC%8A%A4\" aria-label=\"non unique 세컨더리 인덱스 중복된 행 잠금 추가 케이스 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE employees (\n    id int NOT NULL AUTO_INCREMENT,\n    first_name varchar(255) DEFAULT NULL,\n    last_name varchar(255) DEFAULT NULL,\n    PRIMARY KEY (id),\n    KEY idx_first_name (first_name)\n) ENGINE=InnoDB\n\n+----+------------+-----------+\n| id | first_name | last_name |\n+----+------------+-----------+\n| 34 | E          | E1        |\n| 35 | E          | E2        |\n| 36 | E          | E3        |\n| 37 | B          | B1        |\n| 38 | B          | B2        |\n+----+------------+-----------+</code>\n        </deckgo-highlight-code>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">-- &lt;A 세션&gt;\nBEGIN;\nupdate employees SET last_name = &#39;Updated E&#39; where first_name = &#39;E&#39; and last_name = &#39;E2&#39;;\n\n+-----------+----------------+---------------+------------------+------------------------+\n| lock_type | index_name     | lock_mode     | lock_type_detail | locked_data            |\n+-----------+----------------+---------------+------------------+------------------------+\n| TABLE     | NULL           | IX            | Next-Key Lock    | NULL                   |\n| RECORD    | idx_first_name | X             | Next-Key Lock    | &#39;E&#39;, 34                |\n| RECORD    | idx_first_name | X             | Next-Key Lock    | &#39;E&#39;, 35                |\n| RECORD    | idx_first_name | X             | Next-Key Lock    | &#39;E&#39;, 36                |\n| RECORD    | PRIMARY        | X,REC_NOT_GAP | Record Lock      | 34                     |\n| RECORD    | PRIMARY        | X,REC_NOT_GAP | Record Lock      | 35                     |\n| RECORD    | PRIMARY        | X,REC_NOT_GAP | Record Lock      | 36                     |\n| RECORD    | idx_first_name | X             | Next-Key Lock    | supremum pseudo-record |\n+-----------+----------------+---------------+------------------+------------------------+\n\n-- &lt;B 세션&gt;\ninsert into employees (first_name, last_name) values (&#39;A&#39;, &#39;A1&#39;);    -- 성공\ninsert into employees (first_name, last_name) values (&#39;B&#39;, &#39;B1&#39;);    -- BLOCKED\ninsert into employees (first_name, last_name) values (&#39;C&#39;, &#39;C1&#39;);    -- BLOCKED\ninsert into employees (first_name, last_name) values (&#39;D&#39;, &#39;D1&#39;);    -- BLOCKED\ninsert into employees (first_name, last_name) values (&#39;F&#39;, &#39;F1&#39;);    -- BLOCKED\ninsert into employees (first_name, last_name) values (&#39;Z&#39;, &#39;Z1&#39;);    -- BLOCKED\n\nupdate employees set last_name = &#39;updated B1&#39; where id = 37;   -- 성공\nupdate employees set last_name = &#39;updated B2&#39; where id = 38;   -- 성공\nupdate employees set last_name = &#39;updated B2&#39; where first_name = &#39;B&#39;;    -- 성공\nupdate employees set first_name = &#39;C&#39; where id = 37;   -- BLOCKED\nupdate employees set first_name = &#39;A&#39; where id = 37;   -- 성공</code>\n        </deckgo-highlight-code>\n<p>먼저 <code class=\"language-text\">first_name = 'E'</code>를 찾기 위해 오른쪽으로 검색하지만 <code class=\"language-text\">E</code>보다 큰 데이터는 없기에 supremum 락이 걸린다.</p>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">(&#39;B&#39;, 37)\n(&#39;B&#39;, 38) ← 마지막 B 레코드\n    ↓\n  [갭1] ← (&#39;B&#39;, 38) ~ (&#39;E&#39;, 34)\n    ↓\n(&#39;E&#39;, 34) ← Next-Key Lock = 레코드 + 갭1\n(&#39;E&#39;, 35) ← Next-Key Lock = 레코드 + 갭2\n(&#39;E&#39;, 36) ← Next-Key Lock = 레코드 + 갭3\n    ↓\n  [갭4] ← (&#39;E&#39;, 36) ~ supremum\n    ↓\nsupremum  ← Next-Key Lock = supremum + 갭4</code>\n        </deckgo-highlight-code>\n<p><strong>실제 락 범위</strong></p>\n<ol>\n<li><code class=\"language-text\">('E', 34)</code> <strong>Next-Key Lock</strong>\n<ul>\n<li>레코드: <code class=\"language-text\">('E', 34)</code></li>\n<li>갭: <code class=\"language-text\">(('B', 38) ~ ('E', 34))</code></li>\n</ul>\n</li>\n<li><code class=\"language-text\">('E', 35)</code> <strong>Next-Key Lock</strong>\n<ul>\n<li>레코드: <code class=\"language-text\">('E', 35)</code></li>\n<li>갭: <code class=\"language-text\">(('E', 34) ~ ('E', 35))</code></li>\n</ul>\n</li>\n<li><code class=\"language-text\">('E', 36)</code> <strong>Next-Key Lock</strong>\n<ul>\n<li>레코드: <code class=\"language-text\">('E', 36)</code></li>\n<li>갭: <code class=\"language-text\">(('E', 35) ~ ('E', 36))</code></li>\n</ul>\n</li>\n<li><strong>supremum Next-Key Lock</strong>\n<ul>\n<li>supremum 자체</li>\n<li>갭: <code class=\"language-text\">(('E', 36) ~ supremum)</code></li>\n</ul>\n</li>\n</ol>\n<h2 id=\"non-unique-세컨더리-인덱스-limit-잠금\" style=\"position:relative;\">non-unique 세컨더리 인덱스 LIMIT 잠금<a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-limit-%EC%9E%A0%EA%B8%88\" aria-label=\"non unique 세컨더리 인덱스 limit 잠금 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n| 20 |   20 |   20 |\n| 25 |   25 |   25 |\n| 30 |   10 |   30 |\n| 35 |   10 |   35 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nselect * from t where a = 10 limit 2 FOR UPDATE;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 10          |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 10, 10      |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 10, 30      |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 30          |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\ninsert into t values (9, 9, 9);       -- BLOCKED\ninsert into t values (13, 13, 13);    -- 성공\ninsert into t values (14, 9, 14);     -- BLOCKED\ninsert into t values (16, 16, 16);    -- 성공\n\nUPDATE t SET b=b+1 WHERE id = 15;     -- 성공</code>\n        </deckgo-highlight-code>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 712px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0fa3f7bc2ed3df21f40adff80ae95151/c4538/not_gray_gaplock.webp\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.777777777777779%; position: relative; bottom: 0; left: 0; background-image: url('data:image/webp;base64,UklGRkgAAABXRUJQVlA4IDwAAACwAwCdASoUAAMAPtFUo0uoJKMhsAgBABoJaQDGfB7HiqstkCsGAAD+8eBgRKEvjjsZCYemeID/2OF4AAA='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"not gray gaplock\"\n        title=\"\"\n        src=\"/static/0fa3f7bc2ed3df21f40adff80ae95151/c4538/not_gray_gaplock.webp\"\n        srcset=\"/static/0fa3f7bc2ed3df21f40adff80ae95151/d7e55/not_gray_gaplock.webp 225w,\n/static/0fa3f7bc2ed3df21f40adff80ae95151/8626f/not_gray_gaplock.webp 450w,\n/static/0fa3f7bc2ed3df21f40adff80ae95151/c4538/not_gray_gaplock.webp 712w\"\n        sizes=\"(max-width: 712px) 100vw, 712px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<ol>\n<li>처음으로 좌측 개구간 <code class=\"language-text\">(a=5, id=5)부터 (a=10, id=10)</code> 까지 넥스트 키 락이 설정된다.</li>\n<li>우측으로 탐색하며 <code class=\"language-text\">(a=10, id=30)</code> 레코드에 접근학데 되므로 <code class=\"language-text\">(a=10, id=10)부터 (a=10, id=30)</code>까지 넥스트 키 락이 설정된다.</li>\n<li>LIMIT 2에 대한 조건을 만족했기 때문에 더 이상 검색을 진행하지 않고 종료한다.</li>\n</ol>\n<h2 id=\"넥스트-키-락갭-락--레코드-락으로-인한-데드락-발생-케이스\" style=\"position:relative;\">넥스트 키 락(갭 락 + 레코드 락)으로 인한 데드락 발생 케이스<a href=\"#%EB%84%A5%EC%8A%A4%ED%8A%B8-%ED%82%A4-%EB%9D%BD%EA%B0%AD-%EB%9D%BD--%EB%A0%88%EC%BD%94%EB%93%9C-%EB%9D%BD%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-%EB%8D%B0%EB%93%9C%EB%9D%BD-%EB%B0%9C%EC%83%9D-%EC%BC%80%EC%9D%B4%EC%8A%A4\" aria-label=\"넥스트 키 락갭 락  레코드 락으로 인한 데드락 발생 케이스 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE t (\n  id int NOT NULL,\n  a int NULL,\n  b int NULL,\n  PRIMARY KEY (id),\n  KEY ix_a (a)\n) ENGINE=InnoDB;\n\n+----+------+------+\n| id | a    | b    |\n+----+------+------+\n|  0 |    0 |    0 |\n|  5 |    5 |    5 |\n| 10 |   10 |   10 |\n| 15 |   15 |   15 |\n| 20 |   20 |   20 |\n| 25 |   25 |   25 |\n+----+------+------+\n\n-- &lt;A 세션&gt;\nBEGIN;\nselect * from t where a = 10 for update;\n\n+-----------+------------+---------------+------------------+-------------+\n| lock_type | index_name | lock_mode     | lock_type_detail | locked_data |\n+-----------+------------+---------------+------------------+-------------+\n| TABLE     | NULL       | IX            | Next-Key Lock    | NULL        |\n| RECORD    | PRIMARY    | X,REC_NOT_GAP | Record Lock      | 10          |\n| RECORD    | ix_a       | X             | Next-Key Lock    | 10, 10      |\n| RECORD    | ix_a       | X,GAP         | Gap Lock         | 15, 15      |\n+-----------+------------+---------------+------------------+-------------+\n\n-- &lt;B 세션&gt;\nUPDATE t SET b=b+1 WHERE a=10;   -- BLOCKED\n\n-- &lt;A 세션&gt;\ninsert into t values (8,8,8);    -- 데드락을 감지하여 B 세션의 트랜잭션을 재시작해버리면서 성공한다.\n\n-- &lt;B 세션&gt;\nERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</code>\n        </deckgo-highlight-code>\n<ol>\n<li>A 세션이 <code class=\"language-text\">a=10 FOR UPDATE</code>를 실행하면, 인덱스 ix_a 기준 <code class=\"language-text\">(5,10], (10,15)</code>에 넥스트 키 락(갭 락+레코드 락)이 설정된다.</li>\n<li>B 세션이 <code class=\"language-text\">UPDATE t SET b=b+1 WHERE a=10;</code>을 실행하면, 이미 A 세션이 소유한 레코드 락 때문에 세션 2는 대기한다.</li>\n<li>이후 A 세션이 커밋/롤백 없이 <code class=\"language-text\">INSERT INTO t VALUES (8,8,8);</code>을 실행하면, 해당 값은 ix_a 인덱스의 <code class=\"language-text\">(5,10) 갭</code>에 삽입되어야 하므로, B 세션이 이미 <code class=\"language-text\">(5,10) 구간의 갭 락</code>을 소유하고 있을 경우 세션 1의 INSERT도 대기(블로킹)하게 된다.</li>\n</ol>\n<p>결과적으로, A 세션은 B 세션의 갭 락을 기다리고, B 세션은 A 세션의 레코드 락을 기다리는 데드락이 성립하여 MySQL이 둘 중 하나의 트랜잭션을 강제 롤백시키면서 B 세션에 에러가 발생한다.</p>\n<blockquote>\n<p>💡 <strong>핵심</strong><br>\nInnoDB는 팬텀 리드 등 트랜잭션 고립성을 위해 넥스트 키 락(갭 락+레코드 락) 구조를 채택<br>\n갭 락과 레코드 락이 분리되어 동작하기 때문에, 세션 간 대기가 서로 꼬이면 데드락이 자주 발생함<br>\n데드락 발생 시 애플리케이션에서 트랜잭션 재시도 처리를 해주는 것이 필요함</p>\n</blockquote>\n<h1 id=\"넥스트-키-락은-왜-양-쪽으로-락을-걸까\" style=\"position:relative;\">넥스트 키 락은 왜 양 쪽으로 락을 걸까?<a href=\"#%EB%84%A5%EC%8A%A4%ED%8A%B8-%ED%82%A4-%EB%9D%BD%EC%9D%80-%EC%99%9C-%EC%96%91-%EC%AA%BD%EC%9C%BC%EB%A1%9C-%EB%9D%BD%EC%9D%84-%EA%B1%B8%EA%B9%8C\" aria-label=\"넥스트 키 락은 왜 양 쪽으로 락을 걸까 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<p><strong>MVCC(멀티 버전 동시성 제어)만으로 팬텀 리드를 완벽히 방지할 수 있는 게 아니기 때문에, InnoDB는 넥스트 키 락(Next-Key Lock)을 추가로 도입했다.</strong></p>\n<p>MVCC(멀티 버전 동시성 제어)만으로는 <strong>'조회' 팬텀 리드 방지</strong> 만 가능하다.<br>\n내 트랜잭션이 시작됐을 때의 스냅샷을 쿼리할 수 있기 때문에, 트랜잭션 도중 누가 새로 데이터를 넣든 \"내가 바라보는 데이터셋\"에는 영향이 없어서 \"조회 팬텀 리드\"는 막을 수 있다.</p>\n<p>하지만, <strong>UPDATE/DELETE/SELECT ... FOR UPDATE 등 '쓰기/락 기반' 쿼리에서는 MVCC만으로는 한계가 있다</strong><br>\n내가 트랜잭션 중 특정 조건으로 UPDATE를 수행하면 동시에 다른 트랜잭션에서 그 조건에 부합하는 새 데이터를 INSERT할 수 있다.<br>\n이 경우 '조작(UPDATE/DELETE)'의 대상이 되는 레코드 집합이 트랜잭션 중에 변동 되기 때문에 <strong>쓰기 팬텀 리드</strong>가 발생할 수 있다.<br>\n<strong>단순 스냅샷(읽기 일관성)만으로는 \"조작 대상의 집합\"을 동적으로 제약할 수 없다.</strong></p>\n<deckgo-highlight-code language=\"sql\" terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">CREATE TABLE employees (\n    id int NOT NULL,\n    first_name varchar(255) DEFAULT NULL,\n    last_name varchar(255) DEFAULT NULL,\n    PRIMARY KEY (id),\n    KEY idx_first_name (first_name)\n) ENGINE=InnoDB;\n\n+----+------------+-----------+\n| id | first_name | last_name |\n+----+------------+-----------+\n|  1 | John       | Doe1      |\n|  2 | John       | Doe2      |\n|  3 | John       | Doe3      |\n|  4 | John       | Doe4      |\n|  5 | Jane       | Ann1      |\n|  6 | Jane       | Ann2      |\n|  7 | Jane       | Ann3      |\n|  8 | Jack       | Tim1      |\n|  9 | Jack       | Tim2      |\n| 10 | Jack       | Tim3      |\n+----+------------+-----------+\n\n-- &lt;트랜잭션 A&gt;\nset transaction_isolation = &#39;READ-COMMITTED&#39;;\n\nselect * from employees where id &gt;= 8 for update;\n-- 3 rows in set (0.01 sec)\n\n+-------------+------------+-----------+---------------+-------------+-----------+\n| OBJECT_NAME | INDEX_NAME | LOCK_TYPE | LOCK_MODE     | LOCK_STATUS | LOCK_DATA |\n+-------------+------------+-----------+---------------+-------------+-----------+\n| employees   | NULL       | TABLE     | IX            | GRANTED     | NULL      |\n| employees   | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 8         |\n| employees   | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 9         |\n| employees   | PRIMARY    | RECORD    | X,REC_NOT_GAP | GRANTED     | 10        |\n+-------------+------------+-----------+---------------+-------------+-----------+\n\n-- &lt;트랜잭션 B&gt;\nset transaction_isolation = &#39;READ-COMMITTED&#39;;\n\ninsert into employees(id, first_name, last_name) values (11, &#39;Test&#39;, &#39;Test1&#39; );\ncommit;\n-- Query OK, 1 row affected (0.03 sec)\n-- &lt;/트랜잭션 B&gt;\n\n-- &lt;트랜잭션 A&gt;\nselect * from employees where id &gt;= 8 for update;\n-- 4 rows in set (0.00 sec)</code>\n        </deckgo-highlight-code>\n<p>넥스트 키 락으로 인해 <strong>\"현재 읽은 쿼리 결과에 포함되지 않았던 행이 이후 트랜잭션에서 추가\"</strong> 되는 현상을 차단하는 것이다.<br>\n자세한 테스트 내용은 <a href=\"https://jdalma.github.io/2024y/transaction/#phantom-read-%EB%AC%B8%EC%A0%9C\">팬텀 리드 문제</a>에서 확인할 수 있다.</p>\n<p>즉, 넥스트 키 락은 <strong>MVCC의 한계를 보완</strong> 한다.</p>\n<ul>\n<li>트랜잭션이 조회,조작한 인덱스의 \"사이 공간\"에도 락을 걸어 <strong>추가적인 INSERT(팬텀 레코드 삽입)</strong> 을 막는다.</li>\n<li>실행한 트랜잭션 동안 UPDATE/DELETE/SELECT ... FOR UPDATE 조건에서 조작한 레코드뿐 아니라, 조건 사이 갭에도 갭락을 걸어 <strong>\"어떤 트랜잭션도 이 구간에 새 레코드 못 넣게\"</strong> 강제하는 것이다.</li>\n</ul>\n<h2 id=\"결론\" style=\"position:relative;\">결론<a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h2>\n<p><strong>MVCC만으로는 \"조회 일관성\"만 보장되고, 같은 조건 대상으로 UPDATE/DELETE/SELECT ... FOR UPDATE 등에서는 '팬텀 리드' 발생 가능(쓰기 팬텀).</strong>\n<strong>InnoDB 넥스트 키 락은 이러한 상황까지 커버해서 \"조작 대상 집합이 트랜잭션 내에서 변하지 않도록\" 보장</strong></p>\n<ul>\n<li>즉, MVCC + Next-Key Lock이 합쳐져서 완전한 팬텀 리드 차단 메커니즘이 되는 것</li>\n</ul>\n<p>자세한 내용은 <a href=\"https://dev.mysql.com/doc/refman/8.4/en/innodb-locking.html#innodb-next-key-locks\">MySQL docs: innodb-locking</a>을 참고하자!</p>\n<h1 id=\"테스트-필요\" style=\"position:relative;\">테스트 필요!<a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%ED%95%84%EC%9A%94\" aria-label=\"테스트 필요 permalink\" class=\"custom-class after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a></h1>\n<blockquote>\n<p>범위 조건 이후 컬럼은 스캔 범위를 좁히는데 사용되지 않고, 필터 조건으로만 동작한다</p>\n</blockquote>\n<p>-- 인덱스를 바꾼다면\n(contract_id, valid_to, valid_from)</p>\n<p>-- 쿼리\nWHERE contract_id = ?\nAND valid_to > ?      -- 범위 조건 (여기서 스캔 멈춤)\nAND valid_from &#x3C;= ?   -- 필터링만</p>\n<p>결론: 둘 다 범위 조건이면 어느 쪽을 앞에 두든 하나만 인덱스 스캔에 활용됩니다. 순서를 바꿔도 본질적으로 같습니다.</p>\n<hr>\n<p>그래서 현재 인덱스가 적절한가?</p>\n<p>(contract_id, valid_from, valid_to)</p>\n<ul>\n<li>contract_id = ? → 효율적 (등호 조건)</li>\n<li>valid_from &#x3C;= ? → 범위 스캔</li>\n<li>valid_to > ? → 필터링 (인덱스에 포함되어 있어서 커버링 인덱스로 동작 가능)</li>\n</ul>\n<p>세 번째 컬럼(valid_to)이 인덱스에 포함되어 있으면, 테이블을 다시 읽지 않고 인덱스만으로 필터링할 수 있어서 여전히 이점이 있습니다.</p>\n<hr>\n<p>요약</p>\n<table>\n<thead>\n<tr>\n<th>상황</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>범위 조건 이후 컬럼</td>\n<td>인덱스 스캔에는 사용 안 됨</td>\n</tr>\n<tr>\n<td>인덱스에 포함되면</td>\n<td>필터링은 인덱스 내에서 가능 (커버링)</td>\n</tr>\n<tr>\n<td>현재 인덱스</td>\n<td>적절함, contract_id로 좁히고 나머지는 필터링</td>\n</tr>\n</tbody>\n</table>\n<hr>\n<p>인덱스: (contract_id, valid_from, valid_to)</p>\n<p>정렬 순서:</p>\n<table>\n<thead>\n<tr>\n<th>contract_id</th>\n<th>valid_from</th>\n<th>valid_to</th>\n</tr>\n</thead>\n</table>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">  A       | 2025-01-01 | 2025-06-01\n  A       | 2025-01-01 | 2025-12-31\n  A       | 2025-01-15 | 2025-03-01\n  A       | 2025-02-01 | 9999-12-31\n  B       | 2025-01-01 | 2025-06-01\n  ...</code>\n        </deckgo-highlight-code>\n<p>첫 번째 컬럼으로 정렬 → 같은 값 내에서 두 번째로 정렬 → 같은 값 내에서 세 번째로 정렬</p>\n<hr>\n<p>범위 조건의 문제</p>\n<p>WHERE contract_id = 'A'\nAND valid_from &#x3C;= '2025-01-15'\nAND valid_to > '2025-01-15'</p>\n<ol>\n<li>contract_id = 'A' → A 블록으로 바로 이동 (등호)</li>\n<li>valid_from &#x3C;= '2025-01-15' → A 내에서 범위 스캔 시작</li>\n</ol>\n<p>이 시점에서 valid_to가 연속되어 있지 않음:</p>\n<table>\n<thead>\n<tr>\n<th>contract_id</th>\n<th>valid_from</th>\n<th>valid_to</th>\n<th>valid_to > '2025-01-15'?</th>\n</tr>\n</thead>\n</table>\n<deckgo-highlight-code  terminal=\"carbon\" theme=\"one-light\" line-numbers=\"true\"  >\n          <code slot=\"code\">  A       | 2025-01-01 | 2025-06-01    | ✓\n  A       | 2025-01-01 | 2025-12-31    | ✓\n  A       | 2025-01-15 | 2025-03-01    | ✓</code>\n        </deckgo-highlight-code>\n<p>valid_from이 같아도 valid_to는 다 다름 → 범위를 더 좁힐 수 없음</p>\n<hr>\n<p>그래서 정확히 말하면</p>\n<table>\n<thead>\n<tr>\n<th>용어</th>\n<th>설명</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Index Range Scan</td>\n<td>범위 조건 이후 컬럼은 스캔 범위를 좁히는 데 사용 안 됨 ✓</td>\n</tr>\n<tr>\n<td>Index Filter</td>\n<td>인덱스 내에서 필터링은 가능 (ICP, 커버링 인덱스)</td>\n</tr>\n</tbody>\n</table>\n<p>스캔 범위: contract_id = 'A' AND valid_from &#x3C;= '2025-01-15'\n필터링:   valid_to > '2025-01-15' (스캔한 결과에서 걸러냄)</p>","frontmatter":{"title":"MySQL Lock 실험실","date":"2025-10-26","update":"2025-11-05","description":null,"tags":["mysql","lock"]},"tableOfContents":"<ul>\n<li>\n<ul>\n<li><a href=\"#%EA%B0%AD-%EB%9D%BD%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-insert-%EC%8B%A4%ED%8C%A8\">갭 락으로 인한 INSERT 실패</a></li>\n<li><a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%8F%99%EB%93%B1-%EC%9E%A0%EA%B8%88-for-share\">non-unique 세컨더리 인덱스 동등 잠금 (FOR SHARE)</a></li>\n<li><a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%8F%99%EB%93%B1-%EC%9E%A5%EA%B8%88-for-update\">non-unique 세컨더리 인덱스 동등 장금 (FOR UPDATE)</a></li>\n<li><a href=\"#%ED%94%84%EB%9D%BC%EC%9D%B4%EB%A8%B8%EB%A6%AC-%ED%82%A4-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%B2%94%EC%9C%84-%EC%9E%A0%EA%B8%88\">프라이머리 키 인덱스 범위 잠금</a></li>\n<li><a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EB%B2%94%EC%9C%84-%EC%9E%A0%EA%B8%88\">non-unique 세컨더리 인덱스 범위 잠금</a></li>\n<li><a href=\"#unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%97%85%EB%8D%B0%EC%9D%B4%ED%8A%B8-%EC%9E%A0%EA%B8%88\">unique 세컨더리 인덱스 업데이트 잠금</a></li>\n<li><a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A4%91%EB%B3%B5%EB%90%9C-%ED%96%89-%EC%9E%A0%EA%B8%88\">non-unique 세컨더리 인덱스 중복된 행 잠금</a></li>\n<li><a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-%EC%A4%91%EB%B3%B5%EB%90%9C-%ED%96%89-%EC%9E%A0%EA%B8%88-%EC%B6%94%EA%B0%80-%EC%BC%80%EC%9D%B4%EC%8A%A4\">non-unique 세컨더리 인덱스 중복된 행 잠금 (추가 케이스)</a></li>\n<li><a href=\"#non-unique-%EC%84%B8%EC%BB%A8%EB%8D%94%EB%A6%AC-%EC%9D%B8%EB%8D%B1%EC%8A%A4-limit-%EC%9E%A0%EA%B8%88\">non-unique 세컨더리 인덱스 LIMIT 잠금</a></li>\n<li><a href=\"#%EB%84%A5%EC%8A%A4%ED%8A%B8-%ED%82%A4-%EB%9D%BD%EA%B0%AD-%EB%9D%BD--%EB%A0%88%EC%BD%94%EB%93%9C-%EB%9D%BD%EC%9C%BC%EB%A1%9C-%EC%9D%B8%ED%95%9C-%EB%8D%B0%EB%93%9C%EB%9D%BD-%EB%B0%9C%EC%83%9D-%EC%BC%80%EC%9D%B4%EC%8A%A4\">넥스트 키 락(갭 락 + 레코드 락)으로 인한 데드락 발생 케이스</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%84%A5%EC%8A%A4%ED%8A%B8-%ED%82%A4-%EB%9D%BD%EC%9D%80-%EC%99%9C-%EC%96%91-%EC%AA%BD%EC%9C%BC%EB%A1%9C-%EB%9D%BD%EC%9D%84-%EA%B1%B8%EA%B9%8C\">넥스트 키 락은 왜 양 쪽으로 락을 걸까?</a></p>\n<ul>\n<li><a href=\"#%EA%B2%B0%EB%A1%A0\">결론</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%85%8C%EC%8A%A4%ED%8A%B8-%ED%95%84%EC%9A%94\">테스트 필요!</a></p>\n</li>\n</ul>"},"previous":{"fields":{"slug":"/2025y/webclient/"},"frontmatter":{"title":"WebClient PrematureCloseException 원인 분석하기"}},"next":{"fields":{"slug":"/wiki/agentic/"},"frontmatter":{"title":"에이전틱 프로그래밍에 가까워지기"}}},"pageContext":{"id":"df0b7c66-d55f-5cf6-8dba-b96a8c6666ad","previousPostId":"3989ad6a-110d-5d39-92f8-0420ad980e65","nextPostId":"912cbcb8-ee51-5885-8241-f19a2df1ea51"}},"staticQueryHashes":["230163734","3589320610"],"slicesMap":{}}