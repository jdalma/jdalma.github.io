---
layout: default
title: ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸
parent: JPA
nav_order: 2
---
## Table of contents
{: .no_toc .text-delta }

1. TOC
{:toc}
---

# **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**

- **"ì—”í‹°í‹°ë¥¼ ì˜êµ¬ ì €ì¥í•˜ëŠ” í™˜ê²½"**ì´ë¼ëŠ” ëœ»
- `EntityManager`ë¥¼ í†µí•´ **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸**ì— ì ‘ê·¼
- 1ì°¨ ìºì‹œì™€ ë™ì¼ì„± ë³´ì¥
  - ê°™ì€ íŠ¸ëœì­ì…˜ ì•ˆì—ì„œëŠ” ê°™ì€ ì—”í‹°í‹°ë¥¼ ë°˜í™˜
  - DB Isolation Levelì´ Read Commit ì´ì–´ë„ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ Repeatable Read ë³´ì¥
- íŠ¸ëœì­ì…˜ì„ ì§€ì›í•˜ëŠ” ì“°ê¸° ì§€ì—° (transactional write-behind)
  - íŠ¸ëœì­ì…˜ì„ ì»¤ë°‹í•  ë•Œ ê¹Œì§€ INSERT SQLì„ ëª¨ì€ë‹¤
    - JDBC BATCH SQL ê¸°ëŠ¥ì„ ì‚¬ìš©í•´ì„œ í•œë²ˆì— SQL ì „ì†¡
  - UPDATE , DELETEë¡œ ì¸í•œ ROW ë½ ì‹œê°„ ìµœì†Œí™”
    - íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ UPDATE , DELETE SQL ì‹¤í–‰í•˜ê³  , ë°”ë¡œ ì»¤ë°‹
- ë³€ê²½ ê°ì§€(`Dirty Checking`)
- ì§€ì—° ë¡œë”©(`Lazy Loading`)

# **`EntityManagerFactory`**

![](../../assets/images/jpa/Persistence-context/entityManagerFactory.png)

***

# **Entity Life Cycle**

## **ë¹„ì˜ì† `new` / `transient`**
- **ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ ì „í˜€ ê´€ê³„ê°€ ì—†ëŠ” ìƒˆë¡œìš´ ìƒíƒœ**

```java
    Member member = new Member();
    member.setId("1");
    member.setName("ë©¤ë²„1");
```


## **ì˜ì† `managed`**
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ê²Œ **ê´€ë¦¬ë˜ëŠ” ìƒíƒœ**

```java
    // <ë¹„ì˜ì†>
    Member member = new Member();
    member.setId(3L);
    member.setName("ì´ ë©¤ë²„ëŠ” ì˜ì†ìƒíƒœ");
    // </ë¹„ì˜ì†>

    // <ì˜ì†>
    entityManager.persist(member);
    // </ì˜ì†>

    transaction.commit();
```

- ì˜ì† ì‹œí‚¨ í›„ì— `Member`ê°ì²´ì˜ í•„ë“œë¥¼ ë³€ê²½í•´ë„ ì ìš©ëœë‹¤.
- **í•˜ì§€ë§Œ ì•„ë˜ì˜ ë‘ ê²½ìš°ëŠ” ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ì§€ ì•ŠëŠ”ë‹¤.**

```java
    // 1. ì˜ì† ëœ í›„ í‚¤ ê°’ì„ ë°”ê¾¼ë‹¤ë©´?
    Member member = new Member();
    member.setId(5L);

    entityManager.persist(member);

    member.setId(6L);
    member.setName("ì˜ì† ëœ í›„ í‚¤ ê°’ì„ ë°”ê¾¼ë‹¤ë©´?");

    transaction.commit();

    // 2. ì˜ì† ë˜ê¸°ì „ì— í‚¤ê°’ì„ ë„£ì§€ ì•ŠëŠ”ë‹¤ë©´?
    Member member = new Member();

    entityManager.persist(member);

    member.setId(6L);
    member.setName("ì˜ì† ë˜ê¸°ì „ì— í‚¤ê°’ì„ ë„£ì§€ ì•ŠëŠ”ë‹¤ë©´?");

    transaction.commit();
```

## ğŸ“Œ **ì¤€ì˜ì† `detached`**

- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì €ì¥ë˜ì—ˆë‹¤ê°€ **ë¶„ë¦¬**ëœ ìƒíƒœ
  - âœ‹ **ì„ì˜ë¡œ ë§Œë“¤ì–´ë‚¸ ì—”í‹°í‹°ë„ ê¸°ì¡´ ì‹ë³„ìë¥¼ ê°€ì§€ê³  ìˆìœ¼ë©´ ì¤€ì˜ì† ì—”í‹°í‹°ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.**

```java
    // <ë¹„ì˜ì†>
    Member member = new Member();
    member.setId(4L);
    member.setName("ì´ ë©¤ë²„ëŠ” ì˜ì†ìƒíƒœ 1");
    // </ë¹„ì˜ì†>

    // <ì˜ì†>
    entityManager.persist(member);
    // </ì˜ì†>

    // <ë¹„ì˜ì†>
    entityManager.detach(member);
    // ì¿¼ë¦¬ê°€ ë‚ ë¼ê°€ì§€ ì•ŠëŠ”ë‹¤.
    // </ë¹„ì˜ì†>

    transaction.commit();
```

### **ì¤€ì˜ì† ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•˜ëŠ” 2ê°€ì§€ ë°©ë²•**

- **ë³€ê²½ ê°ì§€ ê¸°ëŠ¥**

```java
    @Transactional
    // bookParamì€ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ì´ë‹¤.
    public void updateItem(Long itemId , Book bookParam){
        // findItemì€ ì˜ì†ìƒíƒœì´ë‹¤.
        // JPAê°€ ê°ì‹œí•˜ëŠ” ëŒ€ìƒì´ë‹¤.
        Item findItem = itemRepository.findOne(itemId);
        findItem.setPrice(bookParam.getPrice());
        ...
        findItem.setName(bookParam.getName());
    }
```
-   ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì—ì„œ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒí•œ í›„ì— ë°ì´í„°ë¥¼ ìˆ˜ì •í•˜ëŠ” ë°©ë²•
-   íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì—”í‹°í‹°ë¥¼ ë‹¤ì‹œ ì¡°íšŒ , ë³€ê²½í•  ê°’ì„ ì„ íƒ âœ íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œì ì— ë³€ê²½ ê°ì§€(`Dirty Checking`)
-   ì´ ë™ì‘ì—ì„œ ë°ì´í„°ë² ì´ìŠ¤ UPDATE SQL ì‹¤í–‰

- **ë³‘í•© (`merge`) ì‚¬ìš©**

```java
    @Transactional
    // itemParam íŒŒë¦¬ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°
    void update(Item itemParam) {
    	// mergeItem ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°
        Item mergeItem = em.merge(itemParam);
    }
```
- ğŸ“Œ **ë³‘í•©ì€ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë³€ê²½í•  ë•Œ ì‚¬ìš©í•˜ëŠ” ê¸°ëŠ¥ì´ë‹¤**

![](../../assets/images/jpa/Persistence-context/1.png)

- ë³‘í•© (merge) ë™ì‘ ë°©ì‹

1.  `merge()`ë¥¼ ì‹¤í–‰Â 
2.  íŒŒë¼ë¯¸í„°ë¡œ ë„˜ì–´ì˜¨ ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ 1ì°¨ ìºì‹œì—ì„œ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ
3.  ë§Œì•½ 1ì°¨ ìºì‹œì— ì—”í‹°í‹°ê°€ ì—†ìœ¼ë©´ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì—”í‹°í‹° ì¡°íšŒ í›„ 1ì°¨ ìºì‹œì— ì €ì¥
4.  ì¡°íšŒí•œ ì˜ì† ì—”í‹°í‹° `mergeMember` ì— `member` ì—”í‹°í‹°ì˜ ê°’ì„ ì±„ì›Œ ë„£ëŠ”ë‹¤.
    1.  `member`ì—”í‹°í‹°ì˜ ëª¨ë“  ê°’ì„ `mergeMember`ì— ë°€ì–´ ë„£ëŠ”ë‹¤.
    2.  ì´ë•Œ `mergeMember`ì˜ `"íšŒì› 1"`ì´ë¼ëŠ” ì´ë¦„ì´ `"íšŒì›ëª…ë³€ê²½"`ìœ¼ë¡œ ë°”ë€ë‹¤.
5.  ì˜ì† ìƒíƒœì¸ `mergeMember`ë¥¼ ë°˜í™˜í•œë‹¤.

**ê°„ë‹¨íˆ ì •ë¦¬**
{: .fh-default .fs-4 }

1.  ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ì‹ë³„ì ê°’ìœ¼ë¡œ ì˜ì† ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•œë‹¤.
2.  ì˜ì† ì—”í‹°í‹°ì˜ ê°’ì„ ì¤€ì˜ì† ì—”í‹°í‹°ì˜ ê°’ìœ¼ë¡œ ëª¨ë‘ êµì²´í•œë‹¤.(ë³‘í•©í•œë‹¤)
3.  íŠ¸ëœì°ì…• ì»¤ë°‹ ì‹œì ì— ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì´ ë™ì‘í•´ì„œ ë°ì´í„°ë² ì´ìŠ¤ UPDATE SQLì´ ì‹¤í–‰ëœë‹¤.

> âœ‹ **ì£¼ì˜!**Â 
> - **ë³€ê²½ ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë©´ ì›í•˜ëŠ” ì†ì„±ë§Œ ì„ íƒí•´ì„œ ë³€ê²½í•  ìˆ˜ ìˆì§€ë§Œ , ë³‘í•©ì„ ì‚¬ìš©í•˜ë©´ ëª¨ë“  ì†ì„±ì´ ë³€ê²½ëœë‹¤.**
> - ë³‘í•© ì‹œ ê°’ì´ ì—†ìœ¼ë©´ nullë¡œ ì—…ë°ì´íŠ¸í•  ìœ„í—˜ë„ ìˆë‹¤. (ë³‘í•©ì€ ëª¨ë“  í•„ë“œë¥¼ êµì²´í•œë‹¤)

***

### ì˜ˆì œ
```java
package jpabook.jpashop.repository;
@Repository
public class ItemRepository {
    @PersistenceContext
    EntityManager em;



    public void save(Item item) {
        if (item.getId() == null) {
        	// ì‹ë³„ì ê°’ì´ ì—†ìœ¼ë©´ ìƒˆë¡œìš´ ì—”í‹°í‹°ë¡œ íŒë‹¨í•´ì„œ ì˜ì†í™”(persist)í•˜ê³ 
            em.persist(item);
        } else {
        	// ì‹ë³„ì ê°’ì´ ìˆìœ¼ë©´ ë³‘í•©(merge)
      	// ì¤€ì˜ì† ìƒíƒœì¸ ìƒí’ˆ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•  ë•ŒëŠ” id ê°’ì´ ìˆìœ¼ë¯€ë¡œ ë³‘í•© ìˆ˜í–‰
            // ì£¼ì˜!
            // Item mergeItem = em.merge(item)
            // em.mergeì˜ ë°˜í™˜ì„ ë°›ì€ mergeItemì€ ì˜ì† ìƒíƒœì´ê³ 
            // íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì˜¨ itemì€ ì—¬ì „íˆ ì¤€ì˜ì† ìƒíƒœì´ë‹¤.
            em.merge(item);
        }
    }
    //...
}
```

-   ì‹ ê·œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ê²ƒ ë¿ë§Œ ì•„ë‹ˆë¼ ë³€ê²½ëœ ë°ì´í„°ì˜ ì €ì¥ë„ í•œë‹¤.
-   ì—¬ê¸°ì„œ ì‚¬ìš©í•˜ëŠ” ìˆ˜ì •(ë³‘í•©)ì€ ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ìˆ˜ì •í•  ë•Œ ì‚¬ìš©í•œë‹¤.

### ğŸ“Œ í•µì‹¬
![](../../assets/images/jpa/Persistence-context/2.png)

> **Q.**  ì—¬ê¸°ì„œì˜ **`new Book()`ìœ¼ë¡œ ìƒì„±ëœ `book` ê°ì²´ëŠ” ì¤€ì˜ì† ì—”í‹°í‹°**ì´ë‹¤.
>
> HTML Formì—ì„œ ê°€ì ¸ì˜¨ `BookForm` `form`ì˜ ë°ì´í„°ë¥¼ ë‹´ì€ `book` ê°ì²´ê°€ ì™œ ì¤€ì˜ì† ì—”í‹°í‹°ì¼ê¹Œ?
>
> ë‹¨ìˆœíˆ `setId`ë¥¼ í•´ì¤€ ê²ƒ ë°–ì— ì—†ëŠ”ë°?

> **A.** **ì¤€ì˜ì†ì€ ê°ì²´ë¥¼ new í–ˆê±°ë‚˜ , ì•ˆ í–ˆê±°ë‚˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ„ëŠ” ê²ƒì€ ì•„ë‹ˆë‹¤.**
>
> **í•µì‹¬ì€ ì‹ë³„ì(key)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì˜ì†ìƒíƒœê°€ ë˜ì–´ DBì— ì €ì¥ëœ ì ì´ ìˆëŠ”ê°€ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.**
>
> new ìƒíƒœì¸ ê°ì²´ì™€ ì¤€ì˜ì† ìƒíƒœì˜ ê°ì²´ëŠ” `merge()`ë¼ëŠ” ëª…ë ¹ì—ì„œ ë™ì‘ì— ì°¨ì´ê°€ ìˆë‹¤.
>
> **new ìƒíƒœì¸ ê°ì²´ëŠ” `merge()`ë¥¼ í˜¸ì¶œí•  ë•Œ ì™„ì „íˆ ìƒˆë¡œìš´ ì—”í‹°í‹°ë¥¼ ë§Œë“ ë‹¤.**
>
> ë°˜ë©´ì— ì¤€ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ëŠ” DBì—ì„œ ê¸°ì¡´ ì—”í‹°í‹°ë¥¼ ì°¾ê³  ê·¸ ê°’ì„ ì¤€ì˜ì† ìƒíƒœì˜ ê°ì²´ë¡œ ë³€ê²½í•œ í›„ ë°˜í™˜í•œë‹¤.
>
> ë§ˆì¹˜ ì¤€ì˜ì† ìƒíƒœì˜ ê°ì²´ê°€ ì˜ì† ìƒíƒœê°€ ëœ ê²ƒ ì²˜ëŸ¼

ğŸ‘ **ê°€ì¥ ì¢‹ì€ í•´ê²½ ë°œë²•**
{: .fh-default .fs-5 }

**ì—”í‹°í‹°ë¥¼ ë³€ê²½í•  ë•ŒëŠ” í•­ìƒ ë³€ê²½ ê°ì§€ë¥¼ ì´ìš©í•˜ì**

-   ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì–´ì„¤í”„ê²Œ ì—”í‹°í‹°ë¥¼ ìƒì„±í•˜ì§€ ë§ì
-   íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì‹ë³„ì(id)ì™€ ë³€ê²½í•  ë°ì´í„°ë¥¼ ëª…í™•í•˜ê²Œ ì „ë‹¬í•˜ì
-   íŠ¸ëœì­ì…˜ì´ ìˆëŠ” ì„œë¹„ìŠ¤ ê³„ì¸µì—ì„œ ì˜ì† ìƒíƒœì˜ ì—”í‹°í‹°ë¥¼ ì¡°íšŒ í•˜ê³  , ì—”í‹°í‹°ì˜ ë°ì´í„°ë¥¼ ì§ì ‘ ë³€ê²½í•˜ì.(ì›í•˜ëŠ” í•„ë“œë§Œ)

***

## **ì‚­ì œ `removed`**